<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro Anecdótico - Cloud</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
        /* ================= ESTILOS CSS COMPLETOS ================= */
        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --accent-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --text-color: #333;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --input-bg: #ffffff;
            --border-color: #ddd;
            --shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            
            /* Variables Sistema Interno */
            --sys-primary: #2c3e50;
            --sys-secondary: #3498db;
            --light-gray: #f5f5f5;
        }

        .dark-mode {
            --primary-color: #8c68cd;
            --secondary-color: #5e97fc;
            --text-color: #f0f0f0;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --input-bg: #2d2d2d;
            --border-color: #444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; transition: all 0.3s; }
        body { background-color: var(--bg-color); color: var(--text-color); min-height: 100vh; }

        /* --- PANTALLA LOGIN --- */
        #login-wrapper {
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 20px;
        }

        .login-card {
            background: var(--card-bg); padding: 40px; border-radius: 20px;
            box-shadow: var(--shadow); width: 100%; max-width: 450px; text-align: center;
            position: relative; overflow: hidden;
        }

        .login-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        }

        .avatar-circle {
            width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex; align-items: center; justify-content: center;
            font-size: 35px; color: white; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .input-group { margin-bottom: 15px; text-align: left; position: relative; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; }
        
        input, select, textarea {
            width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border-color);
            background: var(--input-bg); color: var(--text-color); font-size: 15px;
        }
        
        input:focus { border-color: var(--primary-color); outline: none; }

        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white; font-weight: 600; cursor: pointer; margin-top: 10px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .btn-secondary { background: linear-gradient(to right, #7f8c8d, #95a5a6); }
        .btn-danger { background: linear-gradient(to right, #e74c3c, #c0392b); }
        .btn-success { background: linear-gradient(to right, #2ecc71, #27ae60); }
        .btn-warning { background: linear-gradient(to right, #f39c12, #e67e22); }

        .msg-box { padding: 10px; border-radius: 5px; margin-top: 15px; font-size: 14px; display: none; }
        .error-msg { background: rgba(231, 76, 60, 0.1); color: var(--danger-color); border-left: 3px solid var(--danger-color); }
        .success-msg { background: rgba(46, 204, 113, 0.1); color: var(--accent-color); border-left: 3px solid var(--accent-color); }

        /* --- SISTEMA PRINCIPAL --- */
        #app-wrapper { display: none; padding-bottom: 80px; }
        
        header {
            background: linear-gradient(135deg, var(--sys-primary) 0%, var(--sys-secondary) 100%);
            color: white; padding: 1.5rem 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        .card {
            background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card-header { 
            border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px;
            color: var(--sys-primary); font-size: 1.2rem; display: flex; align-items: center; gap: 10px;
        }

        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab { padding: 12px 20px; cursor: pointer; background: #eee; margin-right: 5px; border-radius: 5px 5px 0 0; }
        .tab.active { background: white; border: 1px solid #ddd; border-bottom: none; font-weight: bold; color: var(--sys-primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Grid System */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

        /* Estudiantes */
        .student-box {
            border-left: 4px solid var(--sys-secondary); background: #f9f9f9;
            padding: 15px; margin-bottom: 10px; border-radius: 4px;
        }
        .student-box.out { border-left-color: var(--danger-color); background: #fff5f5; }
        
        .timer-display { font-size: 1.5rem; font-weight: bold; text-align: center; margin: 10px 0; color: #555; }
        
        /* Indicador Flotante */
        #outside-indicator {
            position: fixed; top: 100px; right: 20px; width: 250px;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 999; display: none;
            border: 1px solid #ffcccc;
        }
        .blink-dot { height: 12px; width: 12px; background: red; border-radius: 50%; display: inline-block; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Footer Nav */
        .footer-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; background: var(--sys-primary);
            display: flex; justify-content: space-around; padding: 10px; z-index: 1000;
        }
        .nav-item { color: white; text-align: center; font-size: 0.8rem; cursor: pointer; opacity: 0.7; }
        .nav-item.active { opacity: 1; font-weight: bold; }
        .nav-item i { font-size: 1.2rem; display: block; margin-bottom: 3px; }

        /* Utilidades */
        .hidden { display: none; }
        @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
        
        /* Modal Cámara */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; }
        .modal-content { background:white; padding:20px; border-radius:10px; max-width:90%; text-align:center; }
        video { width: 100%; max-width: 500px; border-radius: 8px; background: black; }
    </style>
</head>
<body>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCY14LkfciAkiQK8tqFedBR1oNsSJYy_NM",
      authDomain: "registro-anecdotico-4e9f9.firebaseapp.com",
      projectId: "registro-anecdotico-4e9f9",
      storageBucket: "registro-anecdotico-4e9f9.firebasestorage.app",
      messagingSenderId: "452165916569",
      appId: "1:452165916569:web:38eba932b3a9b13cdd6508"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
</script>

<div id="login-wrapper">
    <div class="login-card" id="login-card">
        <div class="avatar-circle" id="login-avatar">MS</div>
        <h2 id="login-title">Bienvenido</h2>
        <p style="color: #777; margin-bottom: 20px;" id="login-subtitle">Sistema de Registro Anecdótico</p>

        <div id="form-login">
            <div class="input-group">
                <label>Correo Electrónico</label>
                <input type="email" id="email" placeholder="ejemplo@escuela.edu">
            </div>
            <div class="input-group">
                <label>Contraseña</label>
                <input type="password" id="password" placeholder="••••••••">
            </div>
            <div style="text-align: right; margin-bottom: 15px;">
                <a href="#" onclick="forgotPassword()" style="color: var(--secondary-color); font-size: 13px;">¿Olvidaste tu contraseña?</a>
            </div>
            <button class="btn" onclick="login()">Ingresar</button>
            <button class="btn btn-secondary" onclick="showRegister()" style="margin-top: 15px;">Crear Cuenta</button>
        </div>

        <div id="form-register" class="hidden">
            <div class="input-group">
                <label>Nombre Completo</label>
                <input type="text" id="reg-name" placeholder="Prof. Juan Pérez">
            </div>
            <div class="input-group">
                <label>Rol / Cargo</label>
                <input type="text" id="reg-role" placeholder="Docente de Inglés">
            </div>
            <div class="input-group">
                <label>Teléfono</label>
                <input type="text" id="reg-phone" placeholder="809-555-5555">
            </div>
            <div class="input-group">
                <label>Correo</label>
                <input type="email" id="reg-email" placeholder="correo@ejemplo.com">
            </div>
            <div class="input-group">
                <label>Contraseña</label>
                <input type="password" id="reg-pass" placeholder="Mínimo 6 caracteres">
            </div>
            <button class="btn btn-success" onclick="register()">Registrar Usuario</button>
            <button class="btn btn-secondary" onclick="showLogin()">Volver</button>
        </div>

        <div id="login-msg" class="msg-box"></div>
    </div>
</div>

<div id="app-wrapper">
    <header>
        <div>
            <h3><i class="fas fa-clipboard-list"></i> Registro Anecdótico</h3>
            <small id="header-user-name">Cargando...</small>
        </div>
        <button class="btn btn-danger" style="width: auto; padding: 8px 15px;" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Salir
        </button>
    </header>

    <div id="outside-indicator">
        <h4 style="color: var(--danger-color); margin-bottom: 10px;">
            <span class="blink-dot"></span> Estudiantes Fuera
        </h4>
        <div id="outside-list-content"></div>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="setTab('registro')">Clase y Estudiantes</div>
            <div class="tab" onclick="setTab('reportes')">Reportes</div>
            <div class="tab" onclick="setTab('evidencias')">Evidencias</div>
        </div>

        <div id="tab-registro" class="tab-content active">
            <div class="card">
                <div class="card-header"><i class="fas fa-school"></i> Datos de la Clase</div>
                <div class="grid-3">
                    <div class="input-group">
                        <label>Centro Educativo</label>
                        <input type="text" id="school-name" value="Politécnico Santo Esteban Rivera">
                    </div>
                    <div class="input-group">
                        <label>Profesor</label>
                        <input type="text" id="teacher-name" readonly>
                    </div>
                    <div class="input-group">
                        <label>Grado</label>
                        <input type="text" id="grade" placeholder="Ej: 4to A">
                    </div>
                </div>
                <div class="input-group">
                    <label>Materia</label>
                    <select id="subject">
                        <option>Inglés Técnico</option>
                        <option>Ofimática</option>
                        <option>Lengua Española</option>
                        <option>Otra</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><i class="fas fa-clock"></i> Control de Tiempo</div>
                <div class="grid-3" style="text-align: center; margin-bottom: 15px;">
                    <div>Inicio: <strong id="start-time">--:--</strong></div>
                    <div>Fin: <strong id="end-time">--:--</strong></div>
                    <div>Duración: <strong id="duration">00:00</strong></div>
                </div>
                <button class="btn btn-success" style="width: 48%; display: inline-block;" onclick="startClass()">Iniciar Clase</button>
                <button class="btn btn-danger" style="width: 48%; display: inline-block;" onclick="endClass()">Finalizar Clase</button>
            </div>

            <div class="card">
                <div class="card-header"><i class="fas fa-user-graduate"></i> Gestión de Estudiantes</div>
                <button class="btn btn-primary" onclick="addStudentForm()">
                    <i class="fas fa-plus"></i> Registrar Salida de Estudiante
                </button>
                <div id="students-container" style="margin-top: 20px;"></div>
            </div>

            <div class="card">
                <div class="card-header"><i class="fas fa-comment-dots"></i> Situaciones / Eventos</div>
                <textarea id="event-input" rows="3" placeholder="Describe lo ocurrido..."></textarea>
                <button class="btn btn-warning" style="margin-top: 10px;" onclick="addEvent()">Agregar Evento</button>
                <ul id="events-list" style="margin-top: 15px; list-style: none;"></ul>
            </div>
        </div>

        <div id="tab-reportes" class="tab-content">
            <div class="card">
                <div class="card-header">Generar Documento</div>
                <p>Genera un PDF con toda la información registrada en esta sesión.</p>
                <button class="btn btn-primary" onclick="generatePreview()">Vista Previa</button>
                <button class="btn btn-success" onclick="downloadPDF()">Descargar PDF</button>
            </div>
            <div id="report-preview" style="background: white; padding: 40px; border: 1px solid #ccc; min-height: 400px;">
                <p style="text-align: center; color: #999;">La vista previa aparecerá aquí...</p>
            </div>
        </div>

        <div id="tab-evidencias" class="tab-content">
            <div class="card">
                <div class="card-header">Captura de Evidencias</div>
                <div class="grid-2">
                    <button class="btn btn-primary" onclick="openCamera()"><i class="fas fa-camera"></i> Usar Cámara</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('file-upload').click()"><i class="fas fa-upload"></i> Subir Archivo</button>
                </div>
                <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload(event)">
                
                <div id="evidence-gallery" class="grid-3" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <div class="footer-nav">
        <div class="nav-item active" onclick="setTab('registro')"><i class="fas fa-clipboard-check"></i> Registro</div>
        <div class="nav-item" onclick="setTab('reportes')"><i class="fas fa-file-pdf"></i> Reportes</div>
        <div class="nav-item" onclick="setTab('evidencias')"><i class="fas fa-camera"></i> Evidencias</div>
    </div>
</div>

<div id="camera-modal" class="modal">
    <div class="modal-content">
        <h3>Capturar Foto</h3>
        <video id="video-feed" autoplay></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <br>
        <button class="btn btn-success" onclick="takePhoto()">Capturar</button>
        <button class="btn btn-danger" onclick="closeCamera()">Cancelar</button>
    </div>
</div>

<script>
    // ================= LÓGICA JAVASCRIPT COMPLETA =================
    
    // 1. GESTIÓN DE USUARIOS Y LOGIN
    let currentUser = null;

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            loadUserProfile(user.uid);
            document.getElementById('login-wrapper').style.display = 'none';
            document.getElementById('app-wrapper').style.display = 'block';
        } else {
            document.getElementById('login-wrapper').style.display = 'flex';
            document.getElementById('app-wrapper').style.display = 'none';
        }
    });

    function showLogin() {
        document.getElementById('form-login').classList.remove('hidden');
        document.getElementById('form-register').classList.add('hidden');
        document.getElementById('login-title').textContent = 'Bienvenido';
    }

    function showRegister() {
        document.getElementById('form-login').classList.add('hidden');
        document.getElementById('form-register').classList.remove('hidden');
        document.getElementById('login-title').textContent = 'Crear Cuenta';
    }

    function showMsg(msg, type) {
        const box = document.getElementById('login-msg');
        box.textContent = msg;
        box.className = 'msg-box ' + (type === 'error' ? 'error-msg' : 'success-msg');
        box.style.display = 'block';
        setTimeout(() => box.style.display = 'none', 4000);
    }

    function login() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        if(!email || !pass) return showMsg('Completa todos los campos', 'error');

        auth.signInWithEmailAndPassword(email, pass)
            .catch(err => showMsg('Error: ' + err.message, 'error'));
    }

    function register() {
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-pass').value;
        const name = document.getElementById('reg-name').value;
        const role = document.getElementById('reg-role').value;
        const phone = document.getElementById('reg-phone').value;

        if(!email || !pass || !name) return showMsg('Campos obligatorios vacíos', 'error');

        auth.createUserWithEmailAndPassword(email, pass)
            .then((cred) => {
                // Guardar datos extra en Firestore
                return db.collection('users').doc(cred.user.uid).set({
                    name: name, role: role, phone: phone, email: email
                });
            })
            .then(() => showMsg('Usuario creado exitosamente', 'success'))
            .catch(err => showMsg(err.message, 'error'));
    }

    function forgotPassword() {
        const email = document.getElementById('email').value;
        if(!email) return showMsg('Escribe tu correo en el campo de arriba', 'error');
        auth.sendPasswordResetEmail(email)
            .then(() => showMsg('Correo de recuperación enviado', 'success'))
            .catch(err => showMsg(err.message, 'error'));
    }

    function logout() {
        auth.signOut();
        // Limpiar datos en memoria
        students = [];
        events = [];
        evidences = [];
        document.getElementById('students-container').innerHTML = '';
        document.getElementById('events-list').innerHTML = '';
    }

    function loadUserProfile(uid) {
        db.collection('users').doc(uid).get().then(doc => {
            if(doc.exists) {
                const data = doc.data();
                document.getElementById('teacher-name').value = data.name;
                document.getElementById('header-user-name').textContent = data.name + ' (' + data.role + ')';
            }
        });
    }

    // 2. LÓGICA DE LA APP (CLASE, ESTUDIANTES, TIEMPO)
    let classStart = null;
    let students = [];
    let events = [];
    let evidences = [];
    let studentCounter = 0;

    function setTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Activar botones footer también
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

        // Mapeo simple
        const index = tabName === 'registro' ? 0 : tabName === 'reportes' ? 1 : 2;
        document.querySelectorAll('.tab')[index].classList.add('active');
        document.querySelectorAll('.nav-item')[index].classList.add('active');
        document.getElementById('tab-'+tabName).classList.add('active');
    }

    // Cronómetro Clase
    function startClass() {
        classStart = new Date();
        document.getElementById('start-time').textContent = classStart.toLocaleTimeString();
        setInterval(() => {
            const now = new Date();
            const diff = Math.floor((now - classStart) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2,'0');
            const s = (diff % 60).toString().padStart(2,'0');
            document.getElementById('duration').textContent = `${m}:${s}`;
        }, 1000);
    }

    function endClass() {
        const end = new Date();
        document.getElementById('end-time').textContent = end.toLocaleTimeString();
    }

    // Gestión Estudiantes (Timer Individual)
    function addStudentForm() {
        studentCounter++;
        const id = studentCounter;
        
        const html = `
            <div id="stu-card-${id}" class="student-box out">
                <div class="grid-2">
                    <input type="text" id="stu-name-${id}" placeholder="Nombre Estudiante">
                    <input type="text" id="stu-reason-${id}" placeholder="Motivo Salida">
                </div>
                <div class="grid-2" style="margin-top:10px; align-items:center;">
                    <div class="timer-display" id="stu-timer-${id}">00:00</div>
                    <div>
                        <button class="btn btn-success" id="btn-in-${id}" onclick="studentReturn(${id})" disabled>Registrar Retorno</button>
                        <button class="btn btn-warning" id="btn-out-${id}" onclick="studentLeave(${id})">Confirmar Salida</button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('students-container').insertAdjacentHTML('beforeend', html);
    }

    function studentLeave(id) {
        const name = document.getElementById(`stu-name-${id}`).value;
        const reason = document.getElementById(`stu-reason-${id}`).value;
        if(!name) return alert('Ingresa el nombre');

        const startTime = new Date();
        
        // Guardar objeto
        const studentObj = { id, name, reason, start: startTime, end: null, interval: null };
        students.push(studentObj);

        // UI
        document.getElementById(`btn-out-${id}`).style.display = 'none';
        document.getElementById(`btn-in-${id}`).disabled = false;
        
        // Timer Interval
        studentObj.interval = setInterval(() => {
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2,'0');
            const s = (diff % 60).toString().padStart(2,'0');
            document.getElementById(`stu-timer-${id}`).textContent = `${m}:${s}`;
        }, 1000);

        updateOutsideIndicator();
    }

    function studentReturn(id) {
        const student = students.find(s => s.id === id);
        if(student) {
            clearInterval(student.interval);
            student.end = new Date();
            student.interval = null; // Marcar como regresado
            
            // UI
            const card = document.getElementById(`stu-card-${id}`);
            card.classList.remove('out');
            card.style.borderLeftColor = 'green';
            document.getElementById(`btn-in-${id}`).textContent = 'Retorno Registrado';
            document.getElementById(`btn-in-${id}`).disabled = true;
            document.getElementById(`stu-timer-${id}`).style.color = 'green';
            
            updateOutsideIndicator();
        }
    }

    function updateOutsideIndicator() {
        const list = document.getElementById('outside-list-content');
        list.innerHTML = '';
        const active = students.filter(s => s.interval !== null); // Los que tienen intervalo activo
        
        if (active.length > 0) {
            document.getElementById('outside-indicator').style.display = 'block';
            active.forEach(s => {
                list.innerHTML += `<div style="font-size:13px; border-bottom:1px solid #eee; padding:5px;">
                    <strong>${s.name}</strong> (${s.reason})
                </div>`;
            });
        } else {
            document.getElementById('outside-indicator').style.display = 'none';
        }
    }

    // Eventos
    function addEvent() {
        const txt = document.getElementById('event-input').value;
        if(!txt) return;
        const time = new Date().toLocaleTimeString();
        events.push({ time, text: txt });
        
        const li = document.createElement('li');
        li.innerHTML = `<strong>${time}:</strong> ${txt}`;
        li.style.background = '#fff'; li.style.padding = '10px'; li.style.marginBottom = '5px'; li.style.borderLeft = '3px solid orange';
        document.getElementById('events-list').appendChild(li);
        document.getElementById('event-input').value = '';
    }

    // 3. EVIDENCIAS Y CÁMARA
    let stream = null;
    
    function openCamera() {
        document.getElementById('camera-modal').style.display = 'flex';
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(s => {
                stream = s;
                document.getElementById('video-feed').srcObject = stream;
            })
            .catch(err => alert('Error cámara: ' + err));
    }

    function closeCamera() {
        if(stream) stream.getTracks().forEach(t => t.stop());
        document.getElementById('camera-modal').style.display = 'none';
    }

    function takePhoto() {
        const video = document.getElementById('video-feed');
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        const imgData = canvas.toDataURL('image/png');
        addEvidenceToGallery(imgData, 'Foto de Cámara');
        closeCamera();
    }

    function handleFileUpload(e) {
        const file = e.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                addEvidenceToGallery(evt.target.result, file.name);
            };
            reader.readAsDataURL(file);
        }
    }

    function addEvidenceToGallery(src, title) {
        evidences.push({ src, title });
        const html = `
            <div style="border:1px solid #ddd; padding:5px;">
                <img src="${src}" style="width:100%; height:150px; object-fit:cover;">
                <small>${title}</small>
            </div>
        `;
        document.getElementById('evidence-gallery').insertAdjacentHTML('beforeend', html);
    }

    // 4. REPORTES PDF
    function generatePreview() {
        const teacher = document.getElementById('teacher-name').value;
        const school = document.getElementById('school-name').value;
        const date = new Date().toLocaleDateString();
        
        let html = `
            <h2 style="text-align:center;">Reporte Anecdótico</h2>
            <p><strong>Centro:</strong> ${school} | <strong>Fecha:</strong> ${date}</p>
            <p><strong>Docente:</strong> ${teacher}</p>
            <hr>
            <h4>Situaciones Registradas</h4>
            <ul>${events.map(e => `<li>[${e.time}] ${e.text}</li>`).join('')}</ul>
            <hr>
            <h4>Registro de Salidas de Estudiantes</h4>
            <table style="width:100%; border-collapse:collapse; margin-top:10px;" border="1">
                <tr style="background:#eee;"><th>Estudiante</th><th>Motivo</th><th>Salida</th><th>Retorno</th></tr>
                ${students.map(s => `
                    <tr>
                        <td>${s.name}</td>
                        <td>${s.reason}</td>
                        <td>${s.start.toLocaleTimeString()}</td>
                        <td>${s.end ? s.end.toLocaleTimeString() : 'Pendiente'}</td>
                    </tr>
                `).join('')}
            </table>
            <hr>
            <h4>Evidencias Adjuntas</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                ${evidences.map(ev => `
                    <div style="text-align:center;">
                        <img src="${ev.src}" style="max-width:150px; border:1px solid #ccc;">
                        <br><small>${ev.title}</small>
                    </div>
                `).join('')}
            </div>
        `;
        document.getElementById('report-preview').innerHTML = html;
    }

    async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const element = document.getElementById('report-preview');
        
        // Asegurarse de que el preview esté visible y renderizado
        if (element.innerHTML.includes("La vista previa aparecerá aquí")) {
            generatePreview();
        }

        const canvas = await html2canvas(element, { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        
        const doc = new jsPDF();
        const imgProps = doc.getImageProperties(imgData);
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        doc.save(`Reporte_${new Date().toLocaleDateString()}.pdf`);
    }
</script>

</body>
</html>
