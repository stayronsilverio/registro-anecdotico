<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - Registro Anecd√≥tico (Firebase)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
    /* ... ESTILOS ORIGINALES ... */
    :root {
        --primary-color: #6a11cb;
        --secondary-color: #2575fc;
        --accent-color: #2ecc71;
        --danger-color: #e74c3c;
        --warning-color: #f39c12;
        --text-color: #333;
        --bg-color: #f8f9fa;
        --card-bg: #ffffff;
        --input-bg: #ffffff;
        --border-color: #ddd;
        --shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        
        /* Variables para el sistema principal */
        --primary: #2c3e50;
        --secondary: #3498db;
        --accent: #e74c3c;
        --light: #ecf0f1;
        --dark: #2c3e50;
        --success: #2ecc71;
        --warning: #f39c12;
        --danger: #e74c3c;
        --gray: #95a5a6;
        --light-gray: #f5f5f5;
    }

    .dark-mode {
        --primary-color: #8c68cd;
        --secondary-color: #5e97fc;
        --accent-color: #35de7d;
        --danger-color: #ff6b6b;
        --warning-color: #ffd166;
        --text-color: #f0f0f0;
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --input-bg: #2d2d2d;
        --border-color: #444;
        --shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        transition: background-color 0.3s, color 0.3s;
    }

    body {
        /* Estilos generales body login */
        min-height: 100vh;
        background-color: var(--bg-color);
        color: var(--text-color);
    }
    
    /* Estilos espec√≠ficos para el contenedor de Login */
    #login-page-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        padding: 20px;
        width: 100%;
    }

    .login-container {
        background: var(--card-bg);
        padding: 40px;
        border-radius: 20px;
        box-shadow: var(--shadow);
        width: 100%;
        max-width: 500px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .login-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
    }

    .theme-switch {
        position: absolute;
        top: 20px;
        right: 20px;
        cursor: pointer;
        font-size: 24px;
        color: var(--primary-color);
    }

    .avatar-container {
        width: 130px;
        height: 130px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 40px;
        font-weight: bold;
        border: 4px solid var(--card-bg);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        overflow: hidden;
    }

    .avatar-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .login-container h2 {
        font-size: 24px;
        margin-bottom: 5px;
        color: var(--text-color);
        font-weight: 600;
    }

    .user-role {
        font-size: 16px;
        color: var(--primary-color);
        font-weight: 500;
        margin-bottom: 5px;
    }

    .contact-info {
        font-size: 14px;
        color: var(--text-color);
        opacity: 0.8;
        margin-bottom: 25px;
    }

    .input-group {
        margin-bottom: 15px;
        text-align: left;
        position: relative;
    }

    .input-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
        color: var(--text-color);
        font-weight: 500;
    }

    .login-container select,
    .login-container input {
        width: 100%;
        padding: 12px 15px;
        border-radius: 10px;
        border: 2px solid var(--border-color);
        font-size: 15px;
        transition: all 0.3s;
        background-color: var(--input-bg);
        color: var(--text-color);
    }

    .login-container select:focus,
    .login-container input:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.2);
    }

    .password-toggle {
        position: absolute;
        right: 15px;
        top: 38px;
        cursor: pointer;
        color: var(--text-color);
        opacity: 0.7;
    }

    .login-container button {
        width: 100%;
        padding: 14px;
        margin-top: 10px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 10px rgba(106, 17, 203, 0.3);
    }

    .login-container button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(106, 17, 203, 0.4);
    }

    .secondary-btn {
        background: linear-gradient(to right, #fd746c, #ff9068) !important;
        box-shadow: 0 4px 10px rgba(253, 116, 108, 0.3) !important;
    }

    .error-msg {
        color: var(--danger-color);
        font-size: 14px;
        margin-top: 15px;
        display: none;
        background: rgba(231, 76, 60, 0.1);
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid var(--danger-color);
    }

    .success-msg {
        color: var(--accent-color);
        font-size: 14px;
        margin-top: 15px;
        display: none;
        background: rgba(46, 204, 113, 0.1);
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid var(--accent-color);
    }

    .admin-auth, .register-form {
        display: none;
        text-align: left;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px dashed var(--border-color);
    }

    .footer {
        margin-top: 25px;
        font-size: 12px;
        color: var(--text-color);
        opacity: 0.7;
        text-align: center;
    }

    .custom-alert {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        background: var(--card-bg);
        color: var(--text-color);
        box-shadow: var(--shadow);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }

    .custom-alert.show { transform: translateX(0); }
    .custom-alert.success { border-left: 4px solid var(--accent-color); }
    .custom-alert.error { border-left: 4px solid var(--danger-color); }
    .custom-alert.info { border-left: 4px solid var(--primary-color); }

    /* ESTILOS DEL SISTEMA PRINCIPAL (Simplificados para no romper) */
    .main-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        padding-bottom: 120px;
    }
    
    header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
        padding: 1.5rem 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .header-content { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
    .card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .card-title { font-size: 1.3rem; color: var(--primary); margin-bottom: 1.2rem; border-bottom: 2px solid var(--light); display: flex; align-items: center; }
    
    .form-group { margin-bottom: 1.2rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); }
    input[type="text"], input[type="date"], input[type="time"], textarea, select {
        width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px;
    }
    
    .btn {
        display: inline-block; padding: 12px 20px; background-color: var(--secondary); color: white;
        border: none; border-radius: 6px; cursor: pointer; margin-right: 10px; margin-bottom: 10px;
    }
    
    .btn-primary { background-color: var(--primary); }
    .btn-success { background-color: var(--success); }
    .btn-danger { background-color: var(--danger); }
    .btn-warning { background-color: var(--warning); }
    .hidden { display: none; }

    .tabs { display: flex; margin-bottom: 1.5rem; border-bottom: 1px solid #ddd; }
    .tab { padding: 12px 20px; cursor: pointer; background: #f1f1f1; margin-right: 5px; }
    .tab.active { background: white; border: 1px solid #ddd; border-bottom: none; font-weight: 500; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 2rem; border-radius: 10px; max-width: 90%; max-height: 90%; overflow: auto; }
    
    .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--primary); display: flex; justify-content: space-around; padding: 10px 0; z-index: 99; }
    .footer-nav-btn { display: flex; flex-direction: column; align-items: center; color: white; text-decoration: none; font-size: 0.8rem; }
    
    .outside-student { padding: 10px; margin: 8px 0; background: #fff4f4; border-radius: 5px; border-left: 4px solid var(--danger); }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; }

    /* Ajustes visuales para listas */
    ul { list-style-type: none; }
    .participation-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .participation-table th, .participation-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    
    @media (max-width: 768px) {
        .grid-2, .grid-3 { grid-template-columns: 1fr; }
    }
</style>
</head>
<body>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCY14LkfciAkiQK8tqFedBR1oNsSJYy_NM",
      authDomain: "registro-anecdotico-4e9f9.firebaseapp.com",
      projectId: "registro-anecdotico-4e9f9",
      storageBucket: "registro-anecdotico-4e9f9.firebasestorage.app",
      messagingSenderId: "452165916569",
      appId: "1:452165916569:web:38eba932b3a9b13cdd6508"
    };
  
    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    console.log("üî• Firebase Inicializado y listo.");
</script>

<div id="login-page-container">
    <div class="login-container" id="login-page">
        <div class="theme-switch" id="theme-switch">
            <i class="fas fa-moon"></i>
        </div>

        <div class="avatar-container" id="user-avatar">MS</div>
        
        <h2 id="profile-name">Bienvenido</h2>
        <p class="user-role" id="profile-role">Por favor, inicia sesi√≥n</p>
        <p class="contact-info" id="profile-contact"></p>

        <div id="login-form">
            <div class="input-group">
                <label for="usuario">Correo electr√≥nico</label>
                <input type="email" id="usuario" placeholder="ejemplo@correo.com" required>
            </div>

            <div class="input-group">
                <label for="password">Contrase√±a</label>
                <input type="password" id="password" placeholder="Ingresa tu contrase√±a">
                <span class="password-toggle" id="password-toggle">
                    <i class="far fa-eye"></i>
                </span>
            </div>

            <div class="forgot-password" style="text-align: right; margin-bottom: 15px;">
                <a class="forgot-link" style="color: var(--primary-color); cursor: pointer;" onclick="forgotPassword()">¬øOlvidaste tu contrase√±a?</a>
            </div>

            <button onclick="validarLogin()">Ingresar al Sistema</button>
            
            <p class="error-msg" id="error-msg">
                <i class="fas fa-exclamation-circle"></i> <span id="error-text"></span>
            </p>
            
            <p class="success-msg" id="success-msg">
                <i class="fas fa-check-circle"></i> Acceso concedido, redirigiendo...
            </p>

            <button class="secondary-btn" onclick="showRegisterForm()">
                <i class="fas fa-user-plus"></i> Registrar nuevo usuario
            </button>
        </div>

        <div id="register-form" class="register-form">
            <h3 style="text-align: center; margin-bottom: 15px; color: var(--primary-color);">
                <i class="fas fa-user-circle"></i> Crear Nueva Cuenta
            </h3>
            
            <div class="input-group">
                <label for="reg-email">Correo Electr√≥nico *</label>
                <input type="email" id="reg-email" placeholder="correo@ejemplo.com">
            </div>
            
            <div class="input-group">
                <label for="reg-password">Contrase√±a *</label>
                <input type="password" id="reg-password" placeholder="M√≠nimo 6 caracteres">
            </div>

            <div class="input-group">
                <label for="reg-name">Nombre Completo *</label>
                <input type="text" id="reg-name" placeholder="Ej: Juan P√©rez">
            </div>
            
            <div class="input-group">
                <label for="reg-role">Rol/Cargo</label>
                <input type="text" id="reg-role" placeholder="Ej: Docente de Ingl√©s">
            </div>

            <div class="input-group">
                <label for="reg-phone">Tel√©fono</label>
                <input type="text" id="reg-phone" placeholder="Ej: 809-555-5555">
            </div>
            
            <button onclick="registerUser()">Registrar Usuario</button>
            <button class="secondary-btn" onclick="hideRegisterForm()">Volver al Login</button>
            
            <p class="error-msg" id="reg-error-msg"></p>
        </div>

        <div class="footer">
            Sistema de Registro Anecd√≥tico v5.0 (Cloud)<br>
            Powered by Firebase
        </div>
    </div>
</div>

<div id="main-page" style="display:none;">
    
    <button onclick="logout()" 
            style="position:fixed; top:15px; right:15px; padding:10px 15px; 
                   background:linear-gradient(to right,#e74c3c,#c0392b); 
                   color:#fff; border:none; border-radius:8px; 
                   cursor:pointer; font-weight:bold; z-index:9999;">
        <i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n
    </button>

    <header>
        <div class="main-container header-content">
            <h1 class="app-title"><i class="fas fa-clipboard-list"></i> Registro Anecd√≥tico</h1>
            <div class="header-buttons">
                <button class="btn btn-success" onclick="navigateToStudentSection()">
                    <i class="fas fa-user-plus"></i> Agregar Estudiante
                </button>
            </div>
        </div>
    </header>

    <div id="studentOutsideIndicator" style="display: none; position: fixed; top: 100px; right: 10px; background: white; border: 1px solid #ddd; padding: 15px; z-index: 1000; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h3><span style="color:red">‚óè</span> Estudiante(s) Fuera</h3>
        <div id="outsideStudentsList"></div>
    </div>

    <div class="main-container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('class-register')">Registro de Clase</div>
            <div class="tab" onclick="switchTab('reports')">Reportes</div>
            <div class="tab" onclick="switchTab('evidence')">Evidencias</div>
        </div>

        <div id="class-register" class="tab-content active">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-school"></i> Datos de la Clase</h2>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Nombre del Centro:</label>
                        <input type="text" id="schoolName" value="Polit√©cnico Santo Esteban Rivera">
                    </div>
                    <div class="form-group">
                        <label>Profesor:</label>
                        <input type="text" id="teacherName" placeholder="Cargando..." readonly>
                    </div>
                    <div class="form-group">
                        <label>Grado:</label>
                        <input type="text" id="grade" placeholder="Ej: 4to Contabilidad">
                    </div>
                </div>
                <div class="form-group">
                    <label>Materia:</label>
                    <select id="subject" onchange="toggleOtherSubject()">
                        <option value="">Seleccione...</option>
                        <option value="Ofim√°tica">Ofim√°tica</option>
                        <option value="Ingl√©s T√©cnico">Ingl√©s T√©cnico</option>
                        <option value="Ingl√©s Tur√≠stico">Ingl√©s Tur√≠stico</option>
                        <option value="Otra">Otra</option>
                    </select>
                    <input type="text" id="otherSubject" class="hidden" placeholder="Especifique la materia" style="margin-top: 5px;">
                </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-clock"></i> Control de Tiempo</h2>
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; text-align: center;">
                    <div><strong>Inicio:</strong> <span id="startTime">--:--</span></div>
                    <div><strong>Fin:</strong> <span id="endTime">--:--</span></div>
                    <div><strong>Duraci√≥n:</strong> <span id="classDuration">00:00:00</span></div>
                </div>
                <button class="btn btn-success" onclick="startClass()"><i class="fas fa-play"></i> Iniciar</button>
                <button class="btn btn-danger" onclick="endClass()"><i class="fas fa-stop"></i> Finalizar</button>
            </div>

            <div class="card" id="studentManagementSection">
                <h2 class="card-title"><i class="fas fa-user-graduate"></i> Salida de Estudiantes</h2>
                <button class="btn btn-primary" onclick="toggleStudentForm()"><i class="fas fa-plus"></i> Registrar Salida</button>
                <div id="studentInputs" class="hidden" style="margin-top: 15px;">
                    </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-calendar-check"></i> Situaciones del Aula</h2>
                <textarea id="classEvents" placeholder="Describe el evento..."></textarea>
                <button class="btn btn-primary" onclick="addEvent()" style="margin-top:10px;">Agregar Evento</button>
                <ul id="eventsList" style="margin-top: 15px;"></ul>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> Participaci√≥n y Conducta</h2>
                <div class="form-group">
                    <label>Estudiante:</label>
                    <input type="text" id="participationStudent" placeholder="Nombre del estudiante">
                </div>
                <div style="margin: 10px 0;">
                    <button class="btn" style="background:#fff; border:1px solid #ddd" onclick="addEmoji('üëç', 'Positiva')">üëç</button>
                    <button class="btn" style="background:#fff; border:1px solid #ddd" onclick="addEmoji('üëé', 'Negativa')">üëé</button>
                    <button class="btn" style="background:#fff; border:1px solid #ddd" onclick="addEmoji('üëè', 'Participaci√≥n')">üëè</button>
                    <button class="btn" style="background:#fff; border:1px solid #ddd" onclick="addEmoji('‚ö†Ô∏è', 'Atenci√≥n')">‚ö†Ô∏è</button>
                </div>
                <textarea id="participationComment" placeholder="Comentario..."></textarea>
                <button class="btn btn-primary" onclick="registerParticipation()" style="margin-top:10px;">Registrar</button>

                <table class="participation-table">
                    <thead><tr><th>Estudiante</th><th>Tipo</th><th>Detalle</th></tr></thead>
                    <tbody id="participationList"></tbody>
                </table>
            </div>
        </div>

        <div id="reports" class="tab-content">
            <div class="card">
                <h2 class="card-title">Generar Reportes</h2>
                <button class="btn btn-primary" onclick="generateReport()">Vista Previa</button>
                <button class="btn btn-success" onclick="downloadPDF()">Descargar PDF</button>
            </div>
            <div id="reportPreview" style="background:white; padding:20px; border:1px solid #ddd; margin-top:20px;">
                <p style="text-align:center; color:#999;">Genera el reporte para ver la vista previa aqu√≠.</p>
            </div>
        </div>

        <div id="evidence" class="tab-content">
            <div class="card">
                <h2 class="card-title">Evidencias</h2>
                <p>Captura fotos o sube archivos.</p>
                <button class="btn btn-primary" onclick="document.getElementById('uploadEvidence').click()">Subir Archivo</button>
                <input type="file" id="uploadEvidence" class="hidden" onchange="handleEvidenceUpload(event)">
                <div id="evidenceList" class="grid-2" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <div class="footer-nav">
        <a href="javascript:void(0)" onclick="switchTab('class-register')" class="footer-nav-btn"><i class="fas fa-chalkboard-teacher"></i><span>Registro</span></a>
        <a href="javascript:void(0)" onclick="switchTab('reports')" class="footer-nav-btn"><i class="fas fa-file-pdf"></i><span>Reportes</span></a>
        <a href="javascript:void(0)" onclick="switchTab('evidence')" class="footer-nav-btn"><i class="fas fa-camera"></i><span>Evidencias</span></a>
    </div>
</div>

<div class="custom-alert" id="custom-alert">
    <i class="fas fa-info-circle"></i>
    <span id="alert-message">Mensaje</span>
</div>

<script>
    // ================= L√ìGICA JAVASCRIPT & FIREBASE =================

    // Variables globales de la APP
    let currentUser = null;
    let students = [];
    let events = [];
    let participationRecords = [];
    let evidenceList = [];
    let startTime = null;
    let endTime = null;
    let outsideStudents = [];
    let currentStudentIndex = 0;
    
    // --- AUTHENTICATION (FIREBASE) ---

    // Escuchar cambios en el estado de autenticaci√≥n (Sesi√≥n persistente)
    auth.onAuthStateChanged(user => {
        if (user) {
            // Usuario logueado
            currentUser = user;
            console.log("Usuario detectado:", user.email);
            
            // Cargar datos adicionales del usuario desde Firestore
            db.collection("usuarios").doc(user.uid).get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    updateProfileUI(user.email, userData);
                    document.getElementById("teacherName").value = userData.nombre || "Profesor";
                } else {
                    console.log("No hay datos extra en Firestore, usando defaults.");
                    updateProfileUI(user.email, {});
                }
            }).catch((error) => {
                console.log("Error obteniendo datos usuario:", error);
            });

            // Mostrar app principal, ocultar login
            document.getElementById("login-page-container").style.display = "none";
            document.getElementById("main-page").style.display = "block";
            
        } else {
            // Usuario no logueado
            currentUser = null;
            console.log("No hay usuario logueado.");
            
            // Mostrar login, ocultar app principal
            document.getElementById("login-page-container").style.display = "flex";
            document.getElementById("main-page").style.display = "none";
        }
    });

    // Funci√≥n LOGIN
    function validarLogin() {
        const email = document.getElementById("usuario").value;
        const password = document.getElementById("password").value;
        const errorMsg = document.getElementById("error-msg");
        const errorText = document.getElementById("error-text");

        if (!email || !password) {
            showAlert("Por favor ingresa correo y contrase√±a", "error");
            return;
        }

        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // Login exitoso, el onAuthStateChanged manejar√° el cambio de pantalla
                showAlert("Credenciales correctas. Ingresando...", "success");
            })
            .catch((error) => {
                let mensaje = "Error al iniciar sesi√≥n";
                if (error.code === 'auth/user-not-found') mensaje = "Usuario no encontrado";
                if (error.code === 'auth/wrong-password') mensaje = "Contrase√±a incorrecta";
                if (error.code === 'auth/invalid-email') mensaje = "Correo inv√°lido";
                
                errorText.textContent = mensaje;
                errorMsg.style.display = "block";
                showAlert(mensaje, "error");
            });
    }

    // Funci√≥n REGISTRO
    function registerUser() {
        const email = document.getElementById("reg-email").value;
        const password = document.getElementById("reg-password").value;
        const name = document.getElementById("reg-name").value;
        const role = document.getElementById("reg-role").value;
        const phone = document.getElementById("reg-phone").value;
        const errorMsg = document.getElementById("reg-error-msg");

        if (!email || !password || !name) {
            errorMsg.textContent = "Campos obligatorios: Email, Password, Nombre";
            errorMsg.style.display = "block";
            return;
        }

        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // Usuario creado en Auth, ahora guardar datos en Firestore
                const user = userCredential.user;
                return db.collection("usuarios").doc(user.uid).set({
                    nombre: name,
                    email: email,
                    role: role,
                    phone: phone,
                    fechaRegistro: new Date()
                });
            })
            .then(() => {
                showAlert("Usuario registrado correctamente", "success");
                hideRegisterForm();
                // onAuthStateChanged detectar√° el nuevo usuario y lo loguear√°
            })
            .catch((error) => {
                errorMsg.textContent = error.message;
                errorMsg.style.display = "block";
            });
    }

    // Funci√≥n LOGOUT
    function logout() {
        auth.signOut().then(() => {
            showAlert("Sesi√≥n cerrada", "info");
            // Limpiar datos en memoria
            students = [];
            events = [];
            participationRecords = [];
            document.getElementById("startTime").textContent = "--:--";
            document.getElementById("endTime").textContent = "--:--";
        });
    }

    function forgotPassword() {
        const email = document.getElementById('usuario').value;
        if (!email) {
            showAlert('Ingresa tu correo en el campo de usuario primero', 'error');
            return;
        }
        auth.sendPasswordResetEmail(email)
            .then(() => {
                showAlert('Se ha enviado un correo para restablecer contrase√±a', 'success');
            })
            .catch((error) => {
                showAlert('Error: ' + error.message, 'error');
            });
    }

    // --- UI HELPERS Login ---
    function showRegisterForm() {
        document.getElementById("login-form").style.display = "none";
        document.getElementById("register-form").style.display = "block";
    }
    function hideRegisterForm() {
        document.getElementById("register-form").style.display = "none";
        document.getElementById("login-form").style.display = "block";
    }
    function updateProfileUI(email, data) {
        document.getElementById("profile-name").textContent = data.nombre || email;
        document.getElementById("profile-role").textContent = data.role || "Usuario";
        document.getElementById("profile-contact").textContent = data.phone || "";
        // Generar iniciales para avatar
        const name = data.nombre || email;
        document.getElementById("user-avatar").textContent = name.substring(0,2).toUpperCase();
    }

    // --- L√ìGICA DEL SISTEMA PRINCIPAL (Registro Anecd√≥tico) ---

    // Navegaci√≥n de Pesta√±as
    function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Activar tab visualmente
        const tabs = document.querySelectorAll('.tab');
        if(tabId === 'class-register') tabs[0].classList.add('active');
        if(tabId === 'reports') tabs[1].classList.add('active');
        if(tabId === 'evidence') tabs[2].classList.add('active');

        document.getElementById(tabId).classList.add('active');
    }

    function toggleOtherSubject() {
        const val = document.getElementById("subject").value;
        const other = document.getElementById("otherSubject");
        if(val === "Otra") other.classList.remove("hidden");
        else other.classList.add("hidden");
    }

    // --- CONTROL DE TIEMPO DE CLASE ---
    function startClass() {
        startTime = new Date();
        document.getElementById("startTime").textContent = startTime.toLocaleTimeString();
        setInterval(updateClassDuration, 1000);
        showAlert("Clase iniciada", "success");
    }

    function endClass() {
        endTime = new Date();
        document.getElementById("endTime").textContent = endTime.toLocaleTimeString();
        showAlert("Clase finalizada", "success");
    }

    function updateClassDuration() {
        if (!startTime) return;
        const now = endTime || new Date();
        const diff = now - startTime;
        const date = new Date(diff);
        document.getElementById("classDuration").textContent = date.toISOString().substr(11, 8);
    }

    // --- GESTI√ìN DE ESTUDIANTES (SALIDAS) ---
    function toggleStudentForm() {
        const container = document.getElementById("studentInputs");
        container.classList.remove("hidden");
        addStudentField();
    }

    function navigateToStudentSection() {
        switchTab('class-register');
        document.getElementById('studentManagementSection').scrollIntoView({behavior: 'smooth'});
        toggleStudentForm();
    }

    function addStudentField() {
        currentStudentIndex++;
        const id = currentStudentIndex;
        const html = `
            <div id="stu_${id}" class="student-box" style="border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:5px; background:#f9f9f9;">
                <input type="text" id="name_${id}" placeholder="Nombre Estudiante" style="margin-bottom:5px;">
                <input type="text" id="reason_${id}" placeholder="Motivo" style="margin-bottom:5px;">
                <button class="btn btn-warning btn-sm" onclick="studentOut(${id})">Registrar Salida</button>
                <button class="btn btn-success btn-sm hidden" id="btnIn_${id}" onclick="studentIn(${id})">Registrar Retorno</button>
                <div id="timer_${id}" style="font-weight:bold; color:red; margin-top:5px;"></div>
            </div>
        `;
        document.getElementById("studentInputs").insertAdjacentHTML('beforeend', html);
    }

    function studentOut(id) {
        const name = document.getElementById(`name_${id}`).value;
        const reason = document.getElementById(`reason_${id}`).value;
        if(!name) { showAlert("Escribe el nombre", "error"); return; }
        
        const start = new Date();
        const studentObj = { id, name, reason, start, end: null, interval: null };
        
        // Mostrar bot√≥n retorno
        document.getElementById(`btnIn_${id}`).classList.remove("hidden");
        
        // Timer
        studentObj.interval = setInterval(() => {
            const now = new Date();
            const diff = Math.floor((now - start) / 1000);
            const min = Math.floor(diff / 60).toString().padStart(2,'0');
            const sec = (diff % 60).toString().padStart(2,'0');
            document.getElementById(`timer_${id}`).textContent = `${min}:${sec}`;
            
            // Actualizar indicador flotante
            updateOutsideIndicator();
        }, 1000);

        students.push(studentObj);
        outsideStudents.push(studentObj);
        showAlert(`Salida registrada: ${name}`, "warning");
    }

    function studentIn(id) {
        const student = students.find(s => s.id === id);
        if(student) {
            clearInterval(student.interval);
            student.end = new Date();
            document.getElementById(`timer_${id}`).style.color = "green";
            document.getElementById(`btnIn_${id}`).disabled = true;
            
            // Remover de lista de fuera
            outsideStudents = outsideStudents.filter(s => s.id !== id);
            updateOutsideIndicator();
            showAlert(`${student.name} ha regresado`, "success");
        }
    }

    function updateOutsideIndicator() {
        const indicator = document.getElementById("studentOutsideIndicator");
        const list = document.getElementById("outsideStudentsList");
        list.innerHTML = "";
        
        if (outsideStudents.length > 0) {
            indicator.style.display = "block";
            outsideStudents.forEach(s => {
                const div = document.createElement("div");
                div.innerHTML = `<strong>${s.name}</strong> (${s.reason})`;
                div.style.borderBottom = "1px solid #eee";
                div.style.padding = "5px 0";
                list.appendChild(div);
            });
        } else {
            indicator.style.display = "none";
        }
    }

    // --- EVENTOS ---
    function addEvent() {
        const text = document.getElementById("classEvents").value;
        if(!text) return;
        const ev = { text, time: new Date().toLocaleTimeString() };
        events.push(ev);
        
        const li = document.createElement("li");
        li.innerHTML = `<strong>${ev.time}:</strong> ${ev.text}`;
        document.getElementById("eventsList").appendChild(li);
        document.getElementById("classEvents").value = "";
    }

    // --- PARTICIPACI√ìN ---
    function addEmoji(emoji, type) {
        document.getElementById("participationComment").value += ` ${emoji} (${type})`;
    }

    function registerParticipation() {
        const name = document.getElementById("participationStudent").value;
        const comment = document.getElementById("participationComment").value;
        if(!name) { showAlert("Nombre requerido", "error"); return; }
        
        const record = { name, comment, time: new Date().toLocaleTimeString() };
        participationRecords.push(record);
        
        const row = `<tr><td>${name}</td><td>${comment}</td><td>${record.time}</td></tr>`;
        document.getElementById("participationList").insertAdjacentHTML('beforeend', row);
        
        document.getElementById("participationStudent").value = "";
        document.getElementById("participationComment").value = "";
        showAlert("Participaci√≥n guardada", "success");
    }

    // --- REPORTES ---
    function generateReport() {
        const container = document.getElementById("reportPreview");
        let html = `<h3>REPORTE ANECD√ìTICO</h3>
                    <p><strong>Fecha:</strong> ${new Date().toLocaleDateString()}</p>
                    <p><strong>Docente:</strong> ${document.getElementById("teacherName").value}</p>
                    <hr>`;
        
        html += `<h4>Eventos:</h4><ul>`;
        events.forEach(e => html += `<li>${e.time} - ${e.text}</li>`);
        html += `</ul>`;
        
        html += `<h4>Estudiantes Fuera:</h4><ul>`;
        students.forEach(s => {
            const duration = s.end ? Math.floor((s.end - s.start)/60000) + " min" : "En curso";
            html += `<li>${s.name}: ${s.reason} (${duration})</li>`;
        });
        html += `</ul>`;
        
        html += `<h4>Participaci√≥n:</h4><ul>`;
        participationRecords.forEach(p => html += `<li>${p.name}: ${p.comment}</li>`);
        html += `</ul>`;

        container.innerHTML = html;
        showAlert("Reporte generado", "success");
    }

    async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const element = document.getElementById('reportPreview');
        const canvas = await html2canvas(element);
        const imgData = canvas.toDataURL('image/png');
        
        const doc = new jsPDF();
        const imgProps = doc.getImageProperties(imgData);
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        doc.save(`Reporte-${new Date().toLocaleDateString()}.pdf`);
    }

    // --- UTILS ---
    function showAlert(msg, type) {
        const alert = document.getElementById("custom-alert");
        const msgSpan = document.getElementById("alert-message");
        msgSpan.textContent = msg;
        alert.className = `custom-alert ${type} show`;
        setTimeout(() => alert.classList.remove("show"), 3000);
    }
    
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const icon = document.querySelector('#theme-switch i');
        if(document.body.classList.contains('dark-mode')) {
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
        } else {
            icon.classList.remove('fa-sun');
            icon.classList.add('fa-moon');
        }
    }
    document.getElementById('theme-switch').addEventListener('click', toggleTheme);
    
    // Toggles de contrase√±a
    document.getElementById('password-toggle').addEventListener('click', () => {
        const inp = document.getElementById('password');
        inp.type = inp.type === 'password' ? 'text' : 'password';
    });
</script>

</body>
</html>
