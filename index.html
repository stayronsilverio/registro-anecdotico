<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro Anecd√≥tico v4.0</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
        /* ================= VARIABLES Y DISE√ëO BASE ================= */
        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --accent-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --text-color: #333;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --input-bg: #ffffff;
            --border-color: #ddd;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .dark-mode {
            --primary-color: #8c68cd;
            --secondary-color: #5e97fc;
            --accent-color: #35de7d;
            --danger-color: #ff6b6b;
            --warning-color: #ffd166;
            --text-color: #f0f0f0;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --input-bg: #2d2d2d;
            --border-color: #444;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; transition: background 0.3s, color 0.3s; }

        body {
            min-height: 100vh;
            background: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }

        /* ================= LOGIN ================= */
        #login-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 20px;
        }

        .login-card {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 420px;
            text-align: center;
            position: relative;
        }

        .avatar-circle {
            width: 90px; height: 90px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 30px; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .input-box { margin-bottom: 15px; text-align: left; position: relative; }
        .input-box label { font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; display: block; }
        
        .input-box input {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 2px solid var(--border-color);
            background: var(--input-bg); color: var(--text-color);
            font-size: 1rem;
        }

        .input-box input:focus { border-color: var(--primary-color); outline: none; }

        .btn-main {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white; font-size: 1rem; font-weight: bold; cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(106, 17, 203, 0.3);
        }
        .btn-main:hover { transform: translateY(-2px); }
        .btn-main:disabled { opacity: 0.7; cursor: not-allowed; }

        .footer-credit {
            margin-top: 25px; font-size: 0.8rem; opacity: 0.7; line-height: 1.4;
        }

        /* Mensajes de Estado */
        .msg-box { padding: 10px; border-radius: 5px; margin-top: 15px; font-size: 0.9rem; display: none; }
        .msg-error { background: rgba(231, 76, 60, 0.1); color: var(--danger-color); border-left: 3px solid var(--danger-color); }
        .msg-success { background: rgba(46, 204, 113, 0.1); color: var(--accent-color); border-left: 3px solid var(--accent-color); }

        /* ================= DASHBOARD ================= */
        #dashboard-wrapper { display: none; width: 100%; }

        header.dash-header {
            background: var(--card-bg); padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-bottom: 1px solid var(--border-color);
        }

        .user-badge {
            display: flex; align-items: center; gap: 10px;
            font-weight: 600; font-size: 0.9rem;
        }
        .role-tag {
            background: var(--primary-color); color: white;
            padding: 2px 8px; border-radius: 12px; font-size: 0.7rem;
        }

        .container { max-width: 1100px; margin: 20px auto; padding: 0 15px; padding-bottom: 80px; }

        .card {
            background: var(--card-bg); border-radius: 12px; padding: 20px;
            margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid var(--border-color);
        }

        h2.card-title {
            font-size: 1.2rem; color: var(--primary-color); margin-bottom: 15px;
            display: flex; align-items: center; gap: 10px;
            border-bottom: 2px solid var(--bg-color); padding-bottom: 10px;
        }

        /* Tabs */
        .tabs-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); }
        .tab-btn {
            padding: 10px 20px; background: transparent; border: none;
            color: var(--text-color); cursor: pointer; font-weight: 600;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Grid de Emojis mejorado */
        .emoji-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px;
            max-height: 200px; overflow-y: auto; padding: 5px; border: 1px solid var(--border-color); border-radius: 8px;
        }
        .emoji-item {
            background: var(--bg-color); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 8px; cursor: pointer; font-size: 1.5rem;
            text-align: center; transition: transform 0.2s;
        }
        .emoji-item:hover { transform: scale(1.1); background: var(--input-bg); border-color: var(--primary-color); }
        
        .emoji-cat-title { font-size: 0.8rem; color: var(--text-color); opacity: 0.7; margin: 10px 0 5px; }

        /* Botones Dashboard */
        .btn-action { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; color: white; display: inline-flex; align-items: center; gap: 5px; }
        .btn-blue { background: var(--secondary-color); }
        .btn-red { background: var(--danger-color); }
        .btn-green { background: var(--accent-color); }

        /* Tabla */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        th, td { padding: 10px; border: 1px solid var(--border-color); text-align: left; }
        th { background: var(--primary-color); color: white; }

        .hidden { display: none; }

        /* Media Queries para Footer y Layout */
        @media (max-width: 600px) {
            .emoji-grid { grid-template-columns: repeat(5, 1fr); }
            .login-card { padding: 25px; }
        }
    </style>
</head>
<body>

    <section id="login-wrapper">
        <div class="login-card">
            <div style="position: absolute; top: 15px; right: 15px; cursor: pointer;" onclick="toggleTheme()">
                <i class="fas fa-adjust"></i>
            </div>

            <div class="avatar-circle">RA</div>
            <h2 style="margin-bottom: 5px;">Bienvenido</h2>
            <p style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 25px;">Ingresa tus credenciales</p>

            <div class="input-box">
                <label>Correo Electr√≥nico</label>
                <input type="email" id="email" placeholder="tucorreo@ejemplo.com">
            </div>

            <div class="input-box">
                <label>Contrase√±a</label>
                <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <i class="far fa-eye" onclick="togglePass()" style="position: absolute; right: 12px; top: 38px; cursor: pointer; opacity: 0.6;"></i>
            </div>

            <button class="btn-main" id="btn-login" onclick="handleLogin()">
                <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
            </button>

            <div id="error-msg" class="msg-box msg-error"></div>
            <div id="success-msg" class="msg-box msg-success"></div>

            <div class="footer-credit">
                Sistema de Registro Anecd√≥tico | v4.0<br>
                <strong>Desarrollado por Miguel Silverio</strong>
            </div>
        </div>
    </section>

    <section id="dashboard-wrapper">
        <header class="dash-header">
            <div class="user-badge">
                <div class="avatar-circle" style="width: 35px; height: 35px; font-size: 14px; margin: 0;">MS</div>
                <div>
                    <div id="user-email-display">Cargando...</div>
                    <span id="user-role-display" class="role-tag">Docente</span>
                </div>
            </div>
            <button class="btn-action btn-red" onclick="handleLogout()" style="font-size: 0.8rem;">
                <i class="fas fa-power-off"></i> Salir
            </button>
        </header>

        <div class="container">
            <div id="admin-tools" class="card hidden" style="border-left: 4px solid var(--warning-color);">
                <h2 class="card-title"><i class="fas fa-user-shield"></i> Panel de Administrador</h2>
                <p>Opciones exclusivas para la gesti√≥n del sistema.</p>
                <button class="btn-action btn-blue" onclick="alert('Funci√≥n de admin: Ver logs globales')">Ver Logs</button>
                <button class="btn-action btn-blue" onclick="alert('Funci√≥n de admin: Gestionar usuarios')">Gestionar Usuarios</button>
            </div>

            <div class="tabs-nav">
                <button class="tab-btn active" onclick="switchTab('registro')">Registro</button>
                <button class="tab-btn" onclick="switchTab('reportes')">Reportes</button>
            </div>

            <div id="tab-registro" class="tab-content active">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-edit"></i> Nuevo Registro</h2>
                    
                    <div class="input-box">
                        <label>Estudiante:</label>
                        <input type="text" id="student-name" placeholder="Nombre del estudiante...">
                    </div>

                    <label style="font-size: 0.9rem; font-weight: 600;">Seleccionar Reacci√≥n:</label>
                    <div class="emoji-cat-title">Acad√©mico</div>
                    <div class="emoji-grid" id="emojis-academic"></div>
                    
                    <div class="emoji-cat-title">Conducta</div>
                    <div class="emoji-grid" id="emojis-behavior"></div>

                    <div class="input-box" style="margin-top: 15px;">
                        <label>Comentario:</label>
                        <input type="text" id="comment-box" placeholder="Detalles de la observaci√≥n...">
                    </div>

                    <button class="btn-main" onclick="addEntry()">Guardar Registro</button>
                </div>

                <div class="card">
                    <h2 class="card-title"><i class="fas fa-list"></i> Historial de Hoy</h2>
                    <table id="entries-table">
                        <thead>
                            <tr>
                                <th>Estudiante</th>
                                <th>Reacci√≥n</th>
                                <th>Comentario</th>
                                <th>Hora</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-reportes" class="tab-content">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-file-pdf"></i> Exportar Datos</h2>
                    <p>Genera un reporte PDF con todos los registros de la sesi√≥n actual.</p>
                    <br>
                    <button class="btn-action btn-green" onclick="alert('Generando PDF... (Simulado)')">
                        <i class="fas fa-download"></i> Descargar PDF
                    </button>
                </div>
            </div>
        </div>
    </section>

    <script>
        // 1. CONFIGURACI√ìN FIREBASE (Tus credenciales)
        const firebaseConfig = {
            apiKey: "AIzaSyCY14LkfciAkiQK8tqFedBR1oNsSJYy_NM",
            authDomain: "registro-anecdotico-4e9f9.firebaseapp.com",
            projectId: "registro-anecdotico-4e9f9",
            storageBucket: "registro-anecdotico-4e9f9.appspot.com",
            messagingSenderId: "1090150651792",
            appId: "1:1090150651792:web:7235a82869df91969a5840"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 2. CONFIGURACI√ìN ADMINS
        const ADMIN_EMAILS = [
            "silveriomiguel09@gmail.com", 
            "admin2@ejemplo.com" // Cambia esto por el segundo correo real
        ];

        // 3. EMOJIS (Lista ampliada)
        const emojisAcademic = ["üìö", "üß†", "üìù", "üí°", "üé®", "üî¨", "üßÆ", "üó£Ô∏è", "ü•á", "üöÄ", "üìà", "üß©"];
        const emojisBehavior = ["üëç", "üëé", "‚ö†Ô∏è", "ü§ù", "ü§ê", "üò°", "üò¥", "üåü", "üòá", "ü§î", "üëÄ", "üëÇ"];

        // VARIABLES GLOBALES
        let heartbeatInterval;
        let currentUserEmail = "";

        // --- INICIALIZACI√ìN ---
        window.onload = () => {
            renderEmojis();
            // Limpiar cualquier sesi√≥n vieja al cargar
            localStorage.clear(); 
        };

        // --- L√ìGICA DE LOGIN Y BLOQUEO ---
        async function handleLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const btn = document.getElementById('btn-login');
            
            if(!email || !password) return showMsg("Completa todos los campos", "error");

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';

            try {
                // 1. Verificar si ya hay sesi√≥n activa en Firestore
                const sessionRef = db.collection('active_sessions').doc(email);
                const doc = await sessionRef.get();
                const now = Date.now();

                if (doc.exists) {
                    const lastSeen = doc.data().timestamp;
                    // Si hubo actividad hace menos de 60 segundos, BLOQUEAR
                    if (now - lastSeen < 60000) {
                        throw new Error("SESSION_LOCKED");
                    }
                }

                // 2. Si no est√° bloqueado, intentar login en Firebase Auth
                await auth.signInWithEmailAndPassword(email, password);
                
                // 3. Registrar nueva sesi√≥n
                await sessionRef.set({
                    timestamp: now,
                    device: navigator.userAgent
                });

                showMsg("¬°Bienvenido! Cargando sistema...", "success");
                
                setTimeout(() => {
                    initDashboard(email);
                }, 1000);

            } catch (error) {
                console.error(error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n';
                
                if (error.message === "SESSION_LOCKED") {
                    showMsg("‚õî ACCESO DENEGADO: Tu cuenta est√° activa en otro dispositivo. Cierra sesi√≥n all√≠ o espera 1 minuto.", "error");
                } else if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    showMsg("Credenciales incorrectas.", "error");
                } else {
                    showMsg("Error de conexi√≥n: " + error.message, "error");
                }
            }
        }

        // --- FUNCIONES DASHBOARD ---
        function initDashboard(email) {
            currentUserEmail = email;
            
            // Ocultar login, mostrar dash
            document.getElementById('login-wrapper').style.display = 'none';
            document.getElementById('dashboard-wrapper').style.display = 'block';

            // Datos de usuario
            document.getElementById('user-email-display').innerText = email;
            
            // Verificar Rol
            if (ADMIN_EMAILS.includes(email)) {
                document.getElementById('user-role-display').innerText = "Administrador";
                document.getElementById('user-role-display').style.background = "var(--danger-color)";
                document.getElementById('admin-tools').classList.remove('hidden');
            } else {
                document.getElementById('user-role-display').innerText = "Docente";
            }

            // Iniciar Heartbeat (Actualiza sesi√≥n cada 30s)
            startHeartbeat(email);
        }

        function startHeartbeat(email) {
            if(heartbeatInterval) clearInterval(heartbeatInterval);
            
            // Actualizar inmediatamente y luego cada 30s
            const update = () => {
                db.collection('active_sessions').doc(email).update({
                    timestamp: Date.now()
                }).catch(err => console.log("Sesi√≥n finalizada"));
            };
            
            update();
            heartbeatInterval = setInterval(update, 30000);
        }

        async function handleLogout() {
            if(currentUserEmail) {
                // Eliminar sesi√≥n de Firestore
                await db.collection('active_sessions').doc(currentUserEmail).delete();
            }
            await auth.signOut();
            location.reload();
        }

        // --- INTERFAZ ---
        function renderEmojis() {
            const acadContainer = document.getElementById('emojis-academic');
            const behContainer = document.getElementById('emojis-behavior');
            
            emojisAcademic.forEach(e => {
                acadContainer.innerHTML += `<div class="emoji-item" onclick="addEmoji('${e}')">${e}</div>`;
            });
            emojisBehavior.forEach(e => {
                behContainer.innerHTML += `<div class="emoji-item" onclick="addEmoji('${e}')">${e}</div>`;
            });
        }

        function addEmoji(emoji) {
            const box = document.getElementById('comment-box');
            box.value = emoji + " " + box.value;
            box.focus();
        }

        function addEntry() {
            const name = document.getElementById('student-name').value;
            const comment = document.getElementById('comment-box').value;
            const tbody = document.querySelector('#entries-table tbody');

            if (!name) return alert("Escribe el nombre del estudiante");

            const row = `
                <tr>
                    <td>${name}</td>
                    <td>${comment.substring(0, 2)}</td>
                    <td>${comment.substring(2)}</td>
                    <td>${new Date().toLocaleTimeString()}</td>
                </tr>
            `;
            tbody.innerHTML += row;
            
            // Limpiar
            document.getElementById('student-name').value = "";
            document.getElementById('comment-box').value = "";
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tabId}`).classList.add('active');
            event.target.classList.add('active');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
        }

        function togglePass() {
            const p = document.getElementById('password');
            p.type = p.type === 'password' ? 'text' : 'password';
        }

        function showMsg(msg, type) {
            const el = document.getElementById(type === 'error' ? 'error-msg' : 'success-msg');
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }
    </script>
</body>
</html>
