<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - Registro Anecd칩tico</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --primary-color: #6a11cb;
        --secondary-color: #2575fc;
        --accent-color: #2ecc71;
        --danger-color: #e74c3c;
        --warning-color: #f39c12;
        --text-color: #333;
        --bg-color: #f8f9fa;
        --card-bg: #ffffff;
        --input-bg: #ffffff;
        --border-color: #ddd;
        --shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }

    .dark-mode {
        --primary-color: #8c68cd;
        --secondary-color: #5e97fc;
        --accent-color: #35de7d;
        --danger-color: #ff6b6b;
        --warning-color: #ffd166;
        --text-color: #f0f0f0;
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --input-bg: #2d2d2d;
        --border-color: #444;
        --shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        transition: background-color 0.3s, color 0.3s;
    }

    body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        padding: 20px;
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    .login-container {
        background: var(--card-bg);
        padding: 40px;
        border-radius: 20px;
        box-shadow: var(--shadow);
        width: 100%;
        max-width: 500px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .login-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
    }

    .theme-switch {
        position: absolute;
        top: 20px;
        right: 20px;
        cursor: pointer;
        font-size: 24px;
        color: var(--primary-color);
    }

    .avatar-container {
        width: 130px;
        height: 130px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 40px;
        font-weight: bold;
        border: 4px solid var(--card-bg);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        overflow: hidden;
    }

    .avatar-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .login-container h2 {
        font-size: 24px;
        margin-bottom: 5px;
        color: var(--text-color);
        font-weight: 600;
    }

    .user-role {
        font-size: 16px;
        color: var(--primary-color);
        font-weight: 500;
        margin-bottom: 5px;
    }

    .contact-info {
        font-size: 14px;
        color: var(--text-color);
        opacity: 0.8;
        margin-bottom: 25px;
    }

    .input-group {
        margin-bottom: 15px;
        text-align: left;
        position: relative;
    }

    .input-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
        color: var(--text-color);
        font-weight: 500;
    }

    .login-container select,
    .login-container input {
        width: 100%;
        padding: 12px 15px;
        border-radius: 10px;
        border: 2px solid var(--border-color);
        font-size: 15px;
        transition: all 0.3s;
        background-color: var(--input-bg);
        color: var(--text-color);
    }

    .login-container select:focus,
    .login-container input:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.2);
    }

    .password-toggle {
        position: absolute;
        right: 15px;
        top: 38px;
        cursor: pointer;
        color: var(--text-color);
        opacity: 0.7;
    }

    .login-container button {
        width: 100%;
        padding: 14px;
        margin-top: 10px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 10px rgba(106, 17, 203, 0.3);
    }

    .login-container button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(106, 17, 203, 0.4);
    }

    .secondary-btn {
        background: linear-gradient(to right, #fd746c, #ff9068) !important;
        box-shadow: 0 4px 10px rgba(253, 116, 108, 0.3) !important;
    }

    .secondary-btn:hover {
        box-shadow: 0 6px 15px rgba(253, 116, 108, 0.4) !important;
    }

    .danger-btn {
        background: linear-gradient(to right, var(--danger-color), #c0392b) !important;
        box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3) !important;
    }

    .danger-btn:hover {
        box-shadow: 0 6px 15px rgba(231, 76, 60, 0.4) !important;
    }

    .success-btn {
        background: linear-gradient(to right, var(--accent-color), #27ae60) !important;
        box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3) !important;
    }

    .success-btn:hover {
        box-shadow: 0 6px 15px rgba(46, 204, 113, 0.4) !important;
    }

    .warning-btn {
        background: linear-gradient(to right, var(--warning-color), #e67e22) !important;
        box-shadow: 0 4px 10px rgba(243, 156, 18, 0.3) !important;
    }

    .warning-btn:hover {
        box-shadow: 0 6px 15px rgba(243, 156, 18, 0.4) !important;
    }

    .error-msg {
        color: var(--danger-color);
        font-size: 14px;
        margin-top: 15px;
        display: none;
        background: rgba(231, 76, 60, 0.1);
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid var(--danger-color);
    }

    .success-msg {
        color: var(--accent-color);
        font-size: 14px;
        margin-top: 15px;
        display: none;
        background: rgba(46, 204, 113, 0.1);
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid var(--accent-color);
    }

    .info-msg {
        color: var(--primary-color);
        font-size: 14px;
        margin-top: 15px;
        display: none;
        background: rgba(106, 17, 203, 0.1);
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid var(--primary-color);
    }

    .admin-auth {
        display: none;
        text-align: left;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px dashed var(--border-color);
    }

    .register-form {
        display: none;
        text-align: left;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px dashed var(--border-color);
    }

    .user-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
    }

    .user-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid var(--border-color);
    }

    .user-item:last-child {
        border-bottom: none;
    }

    .user-actions {
        display: flex;
        gap: 5px;
    }

    .action-btn {
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 12px;
    }

    .delete-btn {
        background: var(--danger-color);
    }

    .reactivate-btn {
        background: var(--accent-color);
    }

    .edit-btn {
        background: var(--primary-color);
    }

    .user-info {
        flex-grow: 1;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .user-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }

    .user-details {
        flex-grow: 1;
    }

    .user-password {
        font-family: monospace;
        background: var(--input-bg);
        padding: 2px 5px;
        border-radius: 3px;
        margin-left: 10px;
    }

    .expiry-info {
        font-size: 12px;
        color: var(--text-color);
        opacity: 0.8;
        margin-top: 3px;
    }

    .expired {
        color: var(--danger-color);
        font-weight: bold;
    }

    .expiring-soon {
        color: var(--warning-color);
    }

    @media(max-width: 480px){
        .login-container {
            padding: 30px 20px;
        }
    }

    .footer {
        margin-top: 25px;
        font-size: 12px;
        color: var(--text-color);
        opacity: 0.7;
        text-align: center;
    }

    .form-tabs {
        display: flex;
        margin-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }

    .form-tab {
        flex: 1;
        text-align: center;
        padding: 10px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        color: var(--text-color);
    }

    .form-tab.active {
        border-bottom: 3px solid var(--primary-color);
        color: var(--primary-color);
        font-weight: bold;
    }

    .reactivate-form, .edit-form {
        display: none;
        background: var(--input-bg);
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        border-left: 4px solid var(--accent-color);
    }

    .edit-form {
        border-left: 4px solid var(--primary-color);
    }

    .forgot-password {
        text-align: right;
        margin-bottom: 15px;
    }

    .forgot-link {
        color: var(--primary-color);
        text-decoration: none;
        font-size: 14px;
        cursor: pointer;
    }

    .forgot-link:hover {
        text-decoration: underline;
    }

    .blocked-msg {
        color: var(--danger-color);
        font-size: 14px;
        margin-top: 15px;
        background: rgba(231, 76, 60, 0.1);
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid var(--danger-color);
    }

    .custom-alert {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        background: var(--card-bg);
        color: var(--text-color);
        box-shadow: var(--shadow);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }

    .custom-alert.show {
        transform: translateX(0);
    }

    .custom-alert.success {
        border-left: 4px solid var(--accent-color);
    }

    .custom-alert.error {
        border-left: 4px solid var(--danger-color);
    }

    .custom-alert.info {
        border-left: 4px solid var(--primary-color);
    }

    .custom-alert i {
        font-size: 20px;
    }

    .custom-alert.success i {
        color: var(--accent-color);
    }

    .custom-alert.error i {
        color: var(--danger-color);
    }

    .custom-alert.info i {
        color: var(--primary-color);
    }
</style>
</head>
<body>

<div class="login-container" id="login-page">
    <!-- Switch de tema oscuro/claro -->
    <div class="theme-switch" id="theme-switch">
        <i class="fas fa-moon"></i>
    </div>

    <!-- Avatar con iniciales din치micas -->
    <div class="avatar-container" id="user-avatar">
        MS
    </div>
    
    <h2 id="profile-name">Miguel Silverio</h2>
    <p class="user-role" id="profile-role">Docente de Ingl칠s</p>
    <p class="contact-info" id="profile-contact">Tel: 829-801-8462</p>

    <div id="login-form">
        <div class="input-group">
            <label for="usuario">Selecciona usuario</label>
            <select id="usuario" onchange="updateProfile()">
                <option value="">Selecciona una opci칩n</option>
                <option value="Miguel Silverio">Miguel Silverio</option>
                <!-- Los usuarios registrados se cargar치n aqu칤 din치micamente -->
            </select>
        </div>

        <div class="input-group">
            <label for="password">Contrase침a</label>
            <input type="password" id="password" placeholder="Ingresa tu contrase침a">
            <span class="password-toggle" id="password-toggle">
                <i class="far fa-eye"></i>
            </span>
        </div>

        <div class="forgot-password">
            <a class="forgot-link" onclick="forgotPassword()">쯆lvidaste tu contrase침a?</a>
        </div>

        <button onclick="validarLogin()">Ingresar al Sistema</button>
        
        <p class="error-msg" id="error-msg">
            <i class="fas fa-exclamation-circle"></i> <span id="error-text"></span>
        </p>

        <p class="blocked-msg" id="blocked-msg" style="display: none;">
            <i class="fas fa-lock"></i> <span id="blocked-text"></span>
        </p>
        
        <p class="success-msg" id="success-msg">
            <i class="fas fa-check-circle"></i> Credenciales correctas, redirigiendo...
        </p>

        <button class="secondary-btn" onclick="showAdminAuth()">
            <i class="fas fa-user-cog"></i> Administrar usuarios
        </button>
    </div>

    <div id="admin-auth" class="admin-auth">
        <h3 style="text-align: center; margin-bottom: 15px; color: var(--primary-color);">
            <i class="fas fa-lock"></i> Autenticaci칩n Requerida
        </h3>
        <p style="text-align: center; margin-bottom: 15px; color: var(--text-color); opacity: 0.8; font-size: 14px;">
            Para administrar usuarios, debe autenticarse como administrador.
        </p>
        
        <div class="input-group">
            <label for="admin-username">Usuario administrador</label>
            <input type="text" id="admin-username" placeholder="Usuario de administrador">
        </div>
        
        <div class="input-group">
            <label for="admin-password">Contrase침a de administrador</label>
            <input type="password" id="admin-password" placeholder="Contrase침a de administrador">
            <span class="password-toggle" id="admin-password-toggle">
                <i class="far fa-eye"></i>
            </span>
        </div>
        
        <button onclick="verifyAdmin()">Verificar identidad</button>
        <button class="secondary-btn" onclick="hideAdminAuth()">Cancelar</button>
        
        <p class="error-msg" id="admin-error-msg"></p>
    </div>

    <div id="admin-panel" class="register-form">
        <h3 style="text-align: center; margin-bottom: 15px; color: var(--primary-color);">
            <i class="fas fa-users-cog"></i> Panel de Administraci칩n
        </h3>

        <div class="form-tabs">
            <div class="form-tab active" id="tab-create" onclick="switchAdminTab('create')">Crear Usuario</div>
            <div class="form-tab" id="tab-delete" onclick="switchAdminTab('delete')">Gestionar Usuarios</div>
        </div>

        <div id="create-user-form">
            <div class="input-group">
                <label for="new-username">Nombre de usuario *</label>
                <input type="text" id="new-username" placeholder="Nombre completo">
            </div>
            
            <div class="input-group">
                <label for="new-password">Contrase침a *</label>
                <input type="password" id="new-password" placeholder="M칤nimo 4 caracteres">
                <span class="password-toggle" id="new-password-toggle">
                    <i class="far fa-eye"></i>
                </span>
            </div>
            
            <div class="input-group">
                <label for="confirm-password">Confirmar contrase침a *</label>
                <input type="password" id="confirm-password" placeholder="Repite la contrase침a">
                <span class="password-toggle" id="confirm-password-toggle">
                    <i class="far fa-eye"></i>
                </span>
            </div>
            
            <div class="input-group">
                <label for="user-role">Especialidad/Rol *</label>
                <input type="text" id="user-role" placeholder="Ej: Docente de Ingl칠s">
            </div>
            
            <div class="input-group">
                <label for="user-phone">Tel칠fono de contacto</label>
                <input type="text" id="user-phone" placeholder="Ej: 829-801-8462">
            </div>
            
            <div class="input-group">
                <label for="expiry-date">Fecha de caducidad (opcional)</label>
                <input type="date" id="expiry-date" min="2024-01-01">
            </div>

            <div class="input-group">
                <label for="avatar-upload">Foto de perfil (opcional)</label>
                <input type="file" id="avatar-upload" accept="image/*" style="padding: 8px;">
            </div>
            
            <button onclick="registerUser()">Crear usuario</button>
        </div>

        <div id="delete-user-form" style="display: none;">
            <div class="input-group">
                <label>Usuarios registrados</label>
                <div class="user-list" id="user-list">
                    <!-- Los usuarios se cargar치n aqu칤 din치micamente -->
                </div>
            </div>
            
            <div id="reactivate-form" class="reactivate-form">
                <h4>Reactivar Usuario: <span id="reactivate-username"></span></h4>
                <div class="input-group">
                    <label for="new-expiry-date">Nueva fecha de caducidad</label>
                    <input type="date" id="new-expiry-date" min="2024-01-01">
                </div>
                <button class="success-btn" onclick="reactivateUser()">Reactivar Usuario</button>
                <button class="secondary-btn" onclick="hideReactivateForm()">Cancelar</button>
            </div>

            <div id="edit-form" class="edit-form">
                <h4>Editar Usuario: <span id="edit-username"></span></h4>
                <div class="input-group">
                    <label for="edit-role">Especialidad/Rol</label>
                    <input type="text" id="edit-role" placeholder="Ej: Docente de Ingl칠s">
                </div>
                
                <div class="input-group">
                    <label for="edit-phone">Tel칠fono de contacto</label>
                    <input type="text" id="edit-phone" placeholder="Ej: 829-801-8462">
                </div>
                
                <div class="input-group">
                    <label for="edit-expiry-date">Fecha de caducidad</label>
                    <input type="date" id="edit-expiry-date" min="2024-01-01">
                </div>

                <div class="input-group">
                    <label for="edit-avatar-upload">Nueva foto de perfil (opcional)</label>
                    <input type="file" id="edit-avatar-upload" accept="image/*" style="padding: 8px;">
                </div>
                
                <button class="warning-btn" onclick="saveUserEdit()">Guardar Cambios</button>
                <button class="secondary-btn" onclick="hideEditForm()">Cancelar</button>
            </div>
            
            <p style="color: var(--text-color); opacity: 0.8; font-size: 13px; margin-bottom: 15px;">
                <i class="fas fa-exclamation-triangle"></i> Los usuarios por defecto no pueden ser eliminados
            </p>
        </div>

        <button class="secondary-btn" onclick="hideAdminPanel()">Volver al login</button>
        
        <p class="error-msg" id="register-error-msg"></p>
        <p class="success-msg" id="register-success-msg"></p>
    </div>

    <div class="footer">
        Sistema de Registro Anecd칩tico | v4.0<br>
        Desarrollado por Miguel Silverio
    </div>
</div>

<!-- Alertas personalizadas -->
<div class="custom-alert success" id="custom-alert">
    <i class="fas fa-check-circle"></i>
    <span id="alert-message"></span>
</div>

<script>
    // Datos iniciales de usuarios (ahora como objetos)
    const usuarios = {
        "Miguel Silverio": {
            password: "2201", // Esta ser치 encriptada al cargar
            expiryDate: null,
            isDefault: true,
            avatar: null,
            role: "Docente de Ingl칠s",
            phone: "829-801-8462",
            sessionId: null // Para control de sesiones
        }
    };

    // Variables globales
    let usuarioParaReactivar = null;
    let usuarioParaEditar = null;
    let failedAttempts = 0;
    let isBlocked = false;
    let blockUntil = 0;
    let currentSessionId = generateSessionId();

    // Generar ID de sesi칩n 칰nico
    function generateSessionId() {
        return Math.random().toString(36).substring(2) + Date.now().toString(36);
    }

    // Mostrar alerta personalizada
    function showAlert(message, type = "success") {
        const alert = document.getElementById("custom-alert");
        const alertMessage = document.getElementById("alert-message");
        
        alert.className = "custom-alert " + type;
        alertMessage.textContent = message;
        alert.classList.add("show");
        
        setTimeout(() => {
            alert.classList.remove("show");
        }, 3000);
    }

    // Funci칩n para encriptar contrase침as usando SHA-256
    async function hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Cargar usuarios desde localStorage si existen
    async function loadUsers() {
        const storedUsers = localStorage.getItem('registeredUsers');
        if (storedUsers) {
            const parsedUsers = JSON.parse(storedUsers);
            for (const user in parsedUsers) {
                usuarios[user] = parsedUsers[user];
            }
        }
        
        // Encriptar la contrase침a del usuario por defecto si no est치 encriptada
        if (usuarios["Miguel Silverio"] && usuarios["Miguel Silverio"].password === "2201") {
            usuarios["Miguel Silverio"].password = await hashPassword("2201");
            saveUsers();
        }
        
        updateUserDropdown();
        
        // Cargar preferencia de tema
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-switch').innerHTML = '<i class="fas fa-sun"></i>';
        }
        
        // Verificar si hay bloqueo activo
        const blockTime = localStorage.getItem('blockUntil');
        if (blockTime && parseInt(blockTime) > Date.now()) {
            isBlocked = true;
            blockUntil = parseInt(blockTime);
            updateBlockedMessage();
        }
    }

    // Guardar usuarios en localStorage
    // Guardar usuarios en localStorage (incluyendo Miguel Silverio y todos los creados)
    function saveUsers() {
        const usersToSave = {};
        for (const user in usuarios) {
            usersToSave[user] = usuarios[user];
        }
        localStorage.setItem('registeredUsers', JSON.stringify(usersToSave));
        updateUserDropdown();
    }

    // Actualizar el dropdown de usuarios
    function updateUserDropdown() {
        const userSelect = document.getElementById('usuario');
        const currentValue = userSelect.value;
        
        // Limpiar opciones excepto la primera
        while (userSelect.options.length > 1) {
            userSelect.remove(1);
        }
        
        // Agregar usuarios del sistema
        const option1 = document.createElement('option');
        option1.value = "Miguel Silverio";
        option1.textContent = "Miguel Silverio";
        userSelect.appendChild(option1);
        
        // Agregar usuarios registrados
        for (const user in usuarios) {
            if (!usuarios[user].isDefault) {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userSelect.appendChild(option);
            }
        }
        
        // Restaurar selecci칩n previa si existe
        if (currentValue && usuarios[currentValue]) {
            userSelect.value = currentValue;
        }
        updateProfile();
    }

    // Actualizar perfil seg칰n selecci칩n
    function updateProfile() {
        const userSelect = document.getElementById('usuario');
        const avatar = document.getElementById('user-avatar');
        const profileName = document.getElementById('profile-name');
        const profileRole = document.getElementById('profile-role');
        const profileContact = document.getElementById('profile-contact');
        const selectedUser = userSelect.value;
        
        if (selectedUser && usuarios[selectedUser]) {
            const userData = usuarios[selectedUser];
            
            // Actualizar avatar
            if (userData.avatar) {
                avatar.innerHTML = `<img src="${userData.avatar}" alt="${selectedUser}">`;
            } else {
                avatar.textContent = getInitials(selectedUser);
            }
            
            // Actualizar informaci칩n del perfil
            profileName.textContent = selectedUser;
            profileRole.textContent = userData.role || "Usuario del sistema";
            profileContact.textContent = userData.phone ? `Tel: ${userData.phone}` : "";
        } else {
            // Valores por defecto
            avatar.textContent = "MS";
            profileName.textContent = "Miguel Silverio";
            profileRole.textContent = "Docente de Ingl칠s";
            profileContact.textContent = "Tel: 829-801-8462";
        }
    }

    // Funci칩n para obtener las iniciales de un nombre
    function getInitials(name) {
        if (!name) return "MS";
        
        const names = name.split(' ');
        let initials = "";
        
        if (names.length === 1) {
            initials = names[0].charAt(0);
        } else {
            initials = names[0].charAt(0) + names[names.length - 1].charAt(0);
        }
        
        return initials.toUpperCase();
    }

    // Normalizar nombre de usuario (sin importar may칰sculas/min칰sculas)
    function normalizeUsername(username) {
        return username.toLowerCase().trim();
    }

    // Buscar usuario normalizado
    function findUser(username) {
        const normalizedUsername = normalizeUsername(username);
        for (const user in usuarios) {
            if (normalizeUsername(user) === normalizedUsername) {
                return user; // Devuelve el nombre exacto almacenado
            }
        }
        return null;
    }

    // Verificar si un usuario ha expirado
    function isUserExpired(userData) {
        if (!userData.expiryDate) return false;
        
        const today = new Date();
        const expiryDate = new Date(userData.expiryDate);
        return today > expiryDate;
    }

    // Obtener informaci칩n de expiraci칩n para mostrar
    function getExpiryInfo(userData) {
        if (!userData.expiryDate) return "Sin fecha de expiraci칩n";
        
        const today = new Date();
        const expiryDate = new Date(userData.expiryDate);
        const diffTime = expiryDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) {
            return `<span class="expired">Expirado el ${formatDate(userData.expiryDate)}</span>`;
        } else if (diffDays < 7) {
            return `<span class="expiring-soon">Expira en ${diffDays} d칤as (${formatDate(userData.expiryDate)})</span>`;
        } else {
            return `Expira el ${formatDate(userData.expiryDate)}`;
        }
    }

    // Formatear fecha a formato legible (DD/MM/YYYY)
    function formatDate(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        return date.toLocaleDateString('es-ES');
    }

    // Cambiar entre tema claro y oscuro
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
            document.getElementById('theme-switch').innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            localStorage.setItem('theme', 'light');
            document.getElementById('theme-switch').innerHTML = '<i class="fas fa-moon"></i>';
        }
    }

    // Mostrar/ocultar contrase침a
    function togglePassword(inputId, toggleId) {
        const passwordInput = document.getElementById(inputId);
        const toggleIcon = document.getElementById(toggleId).querySelector('i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.classList.remove('fa-eye');
            toggleIcon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
        }
    }

    // Funci칩n para recuperar contrase침a
    function forgotPassword() {
        const username = document.getElementById('usuario').value;
        
        if (!username) {
            showAlert('Por favor, selecciona un usuario primero', 'error');
            return;
        }
        
        const foundUser = findUser(username);
        if (!foundUser) {
            showAlert('Usuario no encontrado', 'error');
            return;
        }
        
        // Mostrar mensaje personalizado para contacto por WhatsApp
        showAlert(`Para recuperar tu contrase침a, contacta a Miguel Silverio por WhatsApp al 829-801-8462 indicando tu usuario: ${foundUser}. Recibir치s respuesta en un plazo de 12 horas.`, 'info');
    }

    // Funci칩n para notificar nuevo usuario
    function notifyNewUser(username, password, role, phone, expiryDate) {
        // En un sistema real, aqu칤 se enviar칤a un correo electr칩nico
        console.log(`Nuevo usuario registrado: ${username}, Contrase침a: ${password}, Rol: ${role}, Tel칠fono: ${phone}, Expiraci칩n: ${expiryDate}`);
        
        // Mostrar alerta de notificaci칩n
        showAlert(`Se ha registrado el usuario ${username}. Se ha notificado por correo electr칩nico.`, 'success');
    }

    // Actualizar mensaje de bloqueo
    function updateBlockedMessage() {
        if (!isBlocked) return;
        
        const now = Date.now();
        if (now >= blockUntil) {
            isBlocked = false;
            localStorage.removeItem('blockUntil');
            document.getElementById('blocked-msg').style.display = 'none';
            return;
        }
        
        const remainingSeconds = Math.ceil((blockUntil - now) / 1000);
        document.getElementById('blocked-text').textContent = `Demasiados intentos fallidos. Intenta nuevamente en ${remainingSeconds} segundos.`;
        document.getElementById('blocked-msg').style.display = 'block';
        
        setTimeout(updateBlockedMessage, 1000);
    }

    // Bloquear acceso temporalmente
    function blockAccess() {
        isBlocked = true;
        blockUntil = Date.now() + 45000; // 45 segundos
        localStorage.setItem('blockUntil', blockUntil.toString());
        updateBlockedMessage();
    }

    // Cargar usuarios al iniciar
    loadUsers();

    // Configurar event listeners para los toggles de contrase침a
    document.getElementById('password-toggle').addEventListener('click', function() {
        togglePassword('password', 'password-toggle');
    });

    document.getElementById('admin-password-toggle').addEventListener('click', function() {
        togglePassword('admin-password', 'admin-password-toggle');
    });

    document.getElementById('new-password-toggle').addEventListener('click', function() {
        togglePassword('new-password', 'new-password-toggle');
    });

    document.getElementById('confirm-password-toggle').addEventListener('click', function() {
        togglePassword('confirm-password', 'confirm-password-toggle');
    });

    // Configurar event listener para el toggle de tema
    document.getElementById('theme-switch').addEventListener('click', toggleTheme);

    // Permitir login con la tecla Enter
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            // Verificar en qu칠 formulario estamos
            if (document.getElementById('login-form').style.display !== 'none') {
                validarLogin();
            } else if (document.getElementById('admin-auth').style.display !== 'none') {
                verifyAdmin();
            } else if (document.getElementById('admin-panel').style.display !== 'none') {
                if (document.getElementById('create-user-form').style.display !== 'none') {
                    registerUser();
                } else if (document.getElementById('reactivate-form').style.display === 'block') {
                    reactivateUser();
                } else if (document.getElementById('edit-form').style.display === 'block') {
                    saveUserEdit();
                }
            }
        }
    });

    // Funciones de administraci칩n
    function showAdminAuth() {
        if (isBlocked) {
            showAlert('El sistema est치 bloqueado temporalmente por demasiados intentos fallidos.', 'error');
            return;
        }
        
        document.getElementById('admin-auth').style.display = 'block';
        document.getElementById('login-form').style.display = 'none';
        
        // Limpiar campos de autenticaci칩n
        document.getElementById('admin-username').value = '';
        document.getElementById('admin-password').value = '';
        document.getElementById('admin-error-msg').style.display = 'none';
    }

    function hideAdminAuth() {
        document.getElementById('admin-auth').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
    }

    function showAdminPanel() {
        document.getElementById('admin-panel').style.display = 'block';
        document.getElementById('admin-auth').style.display = 'none';
        
        // Limpiar mensajes y campos del formulario
        document.getElementById('register-error-msg').style.display = 'none';
        document.getElementById('register-success-msg').style.display = 'none';
        document.getElementById('new-username').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        document.getElementById('user-role').value = '';
        document.getElementById('user-phone').value = '';
        document.getElementById('expiry-date').value = '';
        document.getElementById('avatar-upload').value = '';
        
        // Cargar lista de usuarios para eliminar
        loadUserList();
    }

    function hideAdminPanel() {
        document.getElementById('admin-panel').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
        hideReactivateForm();
        hideEditForm();
    }

    function switchAdminTab(tabName) {
        const createTab = document.getElementById('tab-create');
        const deleteTab = document.getElementById('tab-delete');
        const createForm = document.getElementById('create-user-form');
        const deleteForm = document.getElementById('delete-user-form');
        
        if (tabName === 'create') {
            createTab.classList.add('active');
            deleteTab.classList.remove('active');
            createForm.style.display = 'block';
            deleteForm.style.display = 'none';
            hideReactivateForm();
            hideEditForm();
        } else {
            createTab.classList.remove('active');
            deleteTab.classList.add('active');
            createForm.style.display = 'none';
            deleteForm.style.display = 'block';
            loadUserList(); // Recargar lista al cambiar a la pesta침a de eliminar
        }
    }

    function loadUserList() {
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        
        for (const user in usuarios) {
            const userData = usuarios[user];
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            
            const userInfo = document.createElement('div');
            userInfo.className = 'user-info';
            
            const userIcon = document.createElement('div');
            userIcon.className = 'user-icon';
            
            if (userData.avatar) {
                userIcon.style.backgroundImage = `url(${userData.avatar})`;
                userIcon.style.backgroundSize = 'cover';
                userIcon.innerHTML = '';
            } else {
                userIcon.textContent = getInitials(user).substring(0, 2);
            }
            
            const userDetails = document.createElement('div');
            userDetails.className = 'user-details';
            
            const userName = document.createElement('div');
            userName.innerHTML = `<strong>${user}</strong> - ${userData.role || "Usuario"}`;
            
            const expiryInfo = document.createElement('div');
            expiryInfo.className = 'expiry-info';
            expiryInfo.innerHTML = getExpiryInfo(userData);
            
            userDetails.appendChild(userName);
            userDetails.appendChild(expiryInfo);
            
            userInfo.appendChild(userIcon);
            userInfo.appendChild(userDetails);
            
            userItem.appendChild(userInfo);
            
            // Panel de acciones
            const userActions = document.createElement('div');
            userActions.className = 'user-actions';
            
            // Bot칩n de editar para todos los usuarios (excepto por defecto si se desea)
            const editBtn = document.createElement('button');
            editBtn.className = 'action-btn edit-btn';
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.title = 'Editar usuario';
            editBtn.onclick = function() { showEditForm(user); };
            
            userActions.appendChild(editBtn);
            
            // No permitir eliminar usuarios por defecto
            if (!userData.isDefault) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn delete-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'Eliminar usuario';
                deleteBtn.onclick = function() { deleteUser(user); };
                
                userActions.appendChild(deleteBtn);
                
                // Si el usuario est치 expirado, mostrar bot칩n de reactivaci칩n
                if (isUserExpired(userData)) {
                    const reactivateBtn = document.createElement('button');
                    reactivateBtn.className = 'action-btn reactivate-btn';
                    reactivateBtn.innerHTML = '<i class="fas fa-redo"></i>';
                    reactivateBtn.title = 'Reactivar usuario';
                    reactivateBtn.onclick = function() { showReactivateForm(user); };
                    
                    userActions.appendChild(reactivateBtn);
                }
            }
            
            userItem.appendChild(userActions);
            userList.appendChild(userItem);
        }
    }

    function showReactivateForm(username) {
        usuarioParaReactivar = username;
        document.getElementById('reactivate-username').textContent = username;
        document.getElementById('reactivate-form').style.display = 'block';
        document.getElementById('new-expiry-date').value = '';
        
        // Ocultar formulario de edici칩n si est치 visible
        hideEditForm();
        
        // Desplazar la vista al formulario de reactivaci칩n
        document.getElementById('reactivate-form').scrollIntoView({ behavior: 'smooth' });
    }

    function hideReactivateForm() {
        document.getElementById('reactivate-form').style.display = 'none';
        usuarioParaReactivar = null;
    }

    function showEditForm(username) {
        usuarioParaEditar = username;
        const userData = usuarios[username];
        
        document.getElementById('edit-username').textContent = username;
        document.getElementById('edit-role').value = userData.role || "";
        document.getElementById('edit-phone').value = userData.phone || "";
        document.getElementById('edit-expiry-date').value = userData.expiryDate || "";
        document.getElementById('edit-form').style.display = 'block';
        
        // Ocultar formulario de reactivaci칩n si est치 visible
        hideReactivateForm();
        
        // Desplazar la vista al formulario de edici칩n
        document.getElementById('edit-form').scrollIntoView({ behavior: 'smooth' });
    }

    function hideEditForm() {
        document.getElementById('edit-form').style.display = 'none';
        usuarioParaEditar = null;
    }

    function reactivateUser() {
        if (!usuarioParaReactivar) return;
        
        const newExpiryDate = document.getElementById('new-expiry-date').value;
        
        if (!newExpiryDate) {
            showAlert('Por favor, selecciona una nueva fecha de caducidad', 'error');
            return;
        }
        
        // Actualizar la fecha de caducidad del usuario
        usuarios[usuarioParaReactivar].expiryDate = newExpiryDate;
        saveUsers();
        
        // Mostrar mensaje de 칠xito
        showAlert(`Usuario "${usuarioParaReactivar}" reactivado correctamente. Nueva fecha de expiraci칩n: ${formatDate(newExpiryDate)}`, 'success');
        
        // Recargar lista de usuarios
        updateUserDropdown(); // 游댠 Actualizar desplegable de login y ocultar formulario de reactivaci칩n
        loadUserList();
        hideReactivateForm();
    }

    async function saveUserEdit() {
        if (!usuarioParaEditar) return;
        
        const newRole = document.getElementById('edit-role').value;
        const newPhone = document.getElementById('edit-phone').value;
        const newExpiryDate = document.getElementById('edit-expiry-date').value;
        const newAvatarFile = document.getElementById('edit-avatar-upload').files[0];
        
        // Validar campos obligatorios
        if (!newRole) {
            showAlert('El campo de especialidad/rol es obligatorio', 'error');
            return;
        }
        
        // Actualizar datos del usuario
        usuarios[usuarioParaEditar].role = newRole;
        usuarios[usuarioParaEditar].phone = newPhone;
        usuarios[usuarioParaEditar].expiryDate = newExpiryDate || null;
        
        // Procesar nuevo avatar si se subi칩 uno
        if (newAvatarFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                usuarios[usuarioParaEditar].avatar = e.target.result;
                completeUserEdit();
            };
            reader.readAsDataURL(newAvatarFile);
        } else {
            await completeUserEdit();
        }
    }

    function completeUserEdit() {
        saveUsers();
        
        // Mostrar mensaje de 칠xito
        showAlert(`Usuario "${usuarioParaEditar}" actualizado correctamente`, 'success');
        
        // Recargar lista de usuarios
        updateUserDropdown(); // 游댠 Actualizar desplegable de login y ocultar formulario de edici칩n
        loadUserList();
        hideEditForm();
        
        updateUserDropdown(); // 游댠 Actualizar desplegable de login
        // Actualizar perfil si el usuario editado es el seleccionado
        const currentUser = document.getElementById('usuario').value;
        if (currentUser === usuarioParaEditar) {
            updateProfile();
        }
    }

    function deleteUser(username) {
        showAlert(`쮼st치s seguro de que deseas eliminar al usuario "${username}"? Esta acci칩n no se puede deshacer.`, 'error');
        
        // En una aplicaci칩n real, aqu칤 se mostrar칤a un modal de confirmaci칩n
        // Para este ejemplo, usaremos confirmaci칩n simple
        if (confirm(`쮼st치s seguro de que deseas eliminar al usuario "${username}"?`)) {
            delete usuarios[username];
            saveUsers();
            loadUserList(); // Recargar la lista
            updateUserDropdown(); // 游댠 Refrescar el desplegable del login
            
            // Mostrar mensaje de 칠xito
            showAlert(`Usuario "${username}" eliminado correctamente`, 'success');
        }
    }

    async function verifyAdmin() {
        
    const email = document.getElementById('admin-username').value;
    const password = document.getElementById('admin-password').value;
    const errorMsg = document.getElementById('admin-error-msg');

    errorMsg.style.display = 'none';

    try {

        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        const docRef = doc(db, "usuarios", user.uid);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {

            const userData = docSnap.data();

            if (userData.role === "admin" && userData.activo === true) {
                showAdminPanel();
            } else {
                errorMsg.textContent = "No tienes permisos de administrador";
                errorMsg.style.display = "block";
            }

        } else {
            errorMsg.textContent = "Usuario no registrado en base de datos";
            errorMsg.style.display = "block";
        }

    } catch (error) {
        errorMsg.textContent = "Credenciales incorrectas";
        errorMsg.style.display = "block";
    }
}

        
        const usuario = document.getElementById('usuario').value;
        const password = document.getElementById('password').value;
        const errorMsg = document.getElementById('error-msg');
        const errorText = document.getElementById('error-text');
        const successMsg = document.getElementById('success-msg');

        // Ocultar mensajes previos
        errorMsg.style.display = 'none';
        successMsg.style.display = 'none';
        document.getElementById('blocked-msg').style.display = 'none';

        // Buscar usuario normalizado (sin importar may칰sculas/min칰sculas)
        const foundUser = findUser(usuario);
        const hashedPassword = await hashPassword(password);
        
        // Validar si el usuario existe
        if (foundUser && usuarios[foundUser].password === hashedPassword) {
            // Verificar si el usuario ha expirado
            if (isUserExpired(usuarios[foundUser])) {
                errorText.textContent = `Usuario expirado. Fecha de caducidad: ${formatDate(usuarios[foundUser].expiryDate)}`;
                errorMsg.style.display = "block";
                
                // Efecto de sacudida para indicar error
                document.querySelector('.login-container').animate([
                    { transform: 'translateX(0)' },
                    { transform: 'translateX(-10px)' },
                    { transform: 'translateX(10px)' },
                    { transform: 'translateX(0)' }
                ], {
                    duration: 300,
                    iterations: 1
                });
                return;
            }
            
            // Login exitoso, reiniciar contador de intentos
            failedAttempts = 0;
            successMsg.style.display = "block";
            
            // Simular redirecci칩n despu칠s de un breve delay
            setTimeout(function() {
                showAlert("Redirigiendo al sistema principal...", "success");
                document.getElementById("main-page").style.display = "block";
                document.getElementById("login-page").style.display = "none";
            }, 1500);
        } else {
            failedAttempts++;
            errorText.textContent = 'Usuario o contrase침a incorrecta';
            errorMsg.style.display = "block";
            
            // Efecto de sacudida para indicar error
            document.querySelector('.login-container').animate([
                { transform: 'translateX(0)' },
                { transform: 'translateX(-10px)' },
                { transform: 'translateX(10px)' },
                { transform: 'translateX(0)' }
            ], {
                duration: 300,
                iterations: 1
            });
            
            // Bloquear despu칠s de 3 intentos fallidos
            if (failedAttempts >= 3) {
                blockAccess();
            }
        }
    }

    async function registerUser() {
        const username = document.getElementById('new-username').value;
        const password = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const role = document.getElementById('user-role').value;
        const phone = document.getElementById('user-phone').value;
        const expiryDate = document.getElementById('expiry-date').value;
        const avatarFile = document.getElementById('avatar-upload').files[0];
        const errorMsg = document.getElementById('register-error-msg');
        const successMsg = document.getElementById('register-success-msg');
        
        // Ocultar mensajes previos
        errorMsg.style.display = 'none';
        successMsg.style.display = 'none';
        
        // Validaciones
        if (!username || !password || !confirmPassword || !role) {
            showAlert('Todos los campos marcados con * son obligatorios', 'error');
            return;
        }
        
        if (password.length < 4) {
            showAlert('La contrase침a debe tener al menos 4 caracteres', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showAlert('Las contrase침as no coinciden', 'error');
            return;
        }
        
        // Verificar si el usuario ya existe (sin importar may칰sculas/min칰sculas)
        if (findUser(username)) {
            showAlert('El usuario ya existe', 'error');
            return;
        }
        
        // Procesar avatar si se subi칩 uno
        let avatarData = null;
        if (avatarFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                avatarData = e.target.result;
                completeUserRegistration(username, password, role, phone, expiryDate, avatarData);
            };
            reader.readAsDataURL(avatarFile);
        } else {
            await completeUserRegistration(username, password, role, phone, expiryDate, null);
        }
    }

    async function completeUserRegistration(username, password, role, phone, expiryDate, avatarData) {
        // Encriptar la contrase침a
        const hashedPassword = await hashPassword(password);
        
        // Registrar el nuevo usuario
        usuarios[username] = {
            password: hashedPassword,
            expiryDate: expiryDate || null,
            isDefault: false,
            avatar: avatarData,
            role: role,
            phone: phone,
            sessionId: null
        };
        saveUsers();
        
        // Notificar por correo (simulado)
        notifyNewUser(username, password, role, phone, expiryDate);
        
        // Mostrar mensaje de 칠xito
        showAlert(`Usuario "${username}" registrado correctamente`, 'success');
        
        // Limpiar formulario
        document.getElementById('new-username').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        document.getElementById('user-role').value = '';
        document.getElementById('user-phone').value = '';
        document.getElementById('expiry-date').value = '';
        document.getElementById('avatar-upload').value = '';
        
        // Recargar lista de usuarios
        updateUserDropdown(); // 游댠 Actualizar desplegable de login
        loadUserList();
        
        // Cambiar a la pesta침a de gesti칩n para ver el nuevo usuario
        switchAdminTab('delete');
    }
</script>


<div id="main-page" style="display:none;">

<!-- Bot칩n de Cerrar Sesi칩n -->
<button id="logout-btn" 
        style="position:fixed; top:15px; right:15px; padding:10px 15px; 
               background:linear-gradient(to right,#e74c3c,#c0392b); 
               color:#fff; border:none; border-radius:8px; 
               cursor:pointer; font-weight:bold; z-index:9999;">
    <i class="fas fa-sign-out-alt"></i> Cerrar sesi칩n
</button>

<script>
document.addEventListener("DOMContentLoaded", function() {
    var logoutBtn = document.getElementById("logout-btn");
    if (logoutBtn) {
        logoutBtn.addEventListener("click", function(){
            document.getElementById("main-page").style.display = "none";
            document.getElementById("login-page").style.display = "block";
            if (document.getElementById("usuario")) document.getElementById("usuario").value = "";
            if (document.getElementById("password")) document.getElementById("password").value = "";
            if (document.getElementById("error-msg")) document.getElementById("error-msg").style.display = "none";
            if (document.getElementById("success-msg")) document.getElementById("success-msg").style.display = "none";
            if (document.getElementById("blocked-msg")) document.getElementById("blocked-msg").style.display = "none";
        });
    }
});
</script>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro Anecd칩tico</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --gray: #95a5a6;
            --light-gray: #f5f5f5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            padding-bottom: 120px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            margin-bottom: 2rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .copyright {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 1.2rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
        }
        
        .card-title i {
            margin-right: 10px;
            color: var(--secondary);
        }
        
        .form-group {
            margin-bottom: 1.2rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }
        
        input[type="text"], 
        input[type="date"], 
        textarea, 
        select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s ease, box-shadow 0.3s ease;
        }
        
        input[type="text"]:focus, 
        input[type="date"]:focus, 
        textarea:focus, 
        select:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 20px;
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background-color: var(--primary);
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-warning {
            background-color: var(--warning);
        }
        
        .btn-info {
            background-color: #17a2b8;
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .timeline {
            display: flex;
            justify-content: space-between;
            margin: 1.5rem 0;
        }
        
        .timeline-item {
            text-align: center;
            flex: 1;
            padding: 1rem;
            background: var(--light);
            border-radius: 8px;
            margin: 0 5px;
        }
        
        .timeline-item strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        .student-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--light-gray);
        }
        
        .student-box h3 {
            margin-bottom: 0.8rem;
            color: var(--primary);
        }
        
        .timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            color: var(--secondary);
        }
        
        .event-list, .interpretation-list {
            list-style-type: none;
        }
        
        .event-item, .interpretation-item {
            padding: 1rem;
            background: var(--light-gray);
            border-left: 4px solid var(--secondary);
            margin-bottom: 0.8rem;
            border-radius: 0 4px 4px 0;
        }
        
        .event-time, .interpretation-time {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 5px;
        }
        
        .report-preview {
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-top: 2rem;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light);
        }
        
        .report-section {
            margin-bottom: 1.5rem;
        }
        
        .report-section h3 {
            color: var(--primary);
            margin-bottom: 0.8rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid var(--light);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            background: #f1f1f1;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background: white;
            border: 1px solid #ddd;
            border-bottom: none;
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .exit {
            color: var(--danger);
            font-weight: bold;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
        }
        
        @media (max-width: 992px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .timeline {
                flex-direction: column;
            }
            
            .timeline-item {
                margin: 5px 0;
            }
        }
        
        /* Eliminamos el bot칩n flotante de descarga */
        
        /* Modal para la c치mara */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            text-align: center;
        }
        
        .camera-feed {
            width: 100%;
            max-width: 500px;
            background: #333;
            margin: 1rem 0;
            border-radius: 5px;
        }
        
        .photo-preview {
            max-width: 100%;
            margin-top: 1rem;
            border-radius: 5px;
            border: 2px solid var(--secondary);
        }
        
        .evidence-container {
            margin: 1.5rem 0;
            padding: 1rem;
            background: var(--light-gray);
            border-radius: 8px;
        }
        
        .evidence-image {
            max-width: 100%;
            border-radius: 5px;
            margin-top: 1rem;
        }
        
        .conformity-statement {
            background-color: #f8f9fa;
            border-left: 4px solid var(--success);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
            font-style: italic;
        }
        
        .student-signature {
            display: flex;
            align-items: center;
            margin: 1rem 0;
            gap: 15px;
        }

        .header-image-preview, .footer-image-preview {
            max-width: 100%;
            margin-top: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        /* Nuevos estilos para el sistema de participaci칩n */
        .participation-control {
            margin-top: 2rem;
        }
        
        .participation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .participation-table th, 
        .participation-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .participation-table th {
            background-color: var(--primary);
            color: white;
        }
        
        .participation-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .emoji-selector {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .emoji-btn {
            font-size: 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        
        .emoji-btn:hover {
            transform: scale(1.2);
        }
        
        .emoji-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .emoji-btn:hover .emoji-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        .report-type-selector {
            margin: 15px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        
        .participation-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-right: 5px;
        }
        
        .badge-positive {
            background-color: var(--success);
            color: white;
        }
        
        .badge-negative {
            background-color: var(--danger);
            color: white;
        }
        
        .badge-neutral {
            background-color: var(--warning);
            color: white;
        }
        
        .multiple-students {
            margin-top: 15px;
        }
        
        /* Footer navigation */
        .footer-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--primary);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 99;
        }
        
        .footer-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            text-decoration: none;
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .footer-nav-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .footer-nav-btn i {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        /* Acuerdos form */
        .acuerdo-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #17a2b8;
        }
        
        /* Estilos para el indicador de estudiantes fuera - NUEVA POSICI칍N */
        #studentOutsideIndicator {
            position: fixed;
            top: 100px;
            right: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 300px;
        }
        
        #studentOutsideIndicator h3 {
            color: var(--danger);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .outside-student {
            padding: 10px;
            margin: 8px 0;
            background: #fff4f4;
            border-radius: 5px;
            border-left: 4px solid var(--danger);
        }
        
        .outside-student .student-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .outside-student .student-time {
            font-weight: bold;
            color: var(--danger);
        }
        
        .blinking-light {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: blink 1s infinite;
        }
        
        .red-light {
            background-color: var(--danger);
        }
        
        .yellow-light {
            background-color: var(--warning);
        }
        
        /* Estilos para observaciones de evidencias */
        .evidence-observation {
            margin-top: 10px;
            width: 100%;
        }
        
        /* Estilos para campos ocultos */
        .hidden {
            display: none;
        }

        /* Bot칩n agregar estudiante en header */
        .header-buttons {
            display: flex;
            gap: 10px;
        }

        /* Modal de edici칩n de participaci칩n */
        .edit-modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .edit-emoji-selector {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <h1 class="app-title"><i class="fas fa-clipboard-list"></i> Sistema de Registro Anecd칩tico</h1>
            <div class="header-buttons">
                <button class="btn btn-success" onclick="navigateToStudentSection()">
                    <i class="fas fa-user-plus"></i> Agregar Estudiante
                </button>
            </div>
            <div class="copyright">춸 2025 Prof. Miguel Silverio</div>
        </div>
    </header>

    <!-- Indicador de estudiantes fuera del aula - POSICI칍N MODIFICADA -->
    <div id="studentOutsideIndicator" style="display: none;">
        <h3><span class="blinking-light red-light"></span><span class="blinking-light yellow-light"></span> Estudiante(s) Fuera</h3>
        <div id="outsideStudentsList"></div>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('class-register')">Registro de Clase</div>
            <div class="tab" onclick="switchTab('reports')">Reportes</div>
            <div class="tab" onclick="switchTab('evidence')">Evidencias</div>
        </div>

        <!-- Registro de Clase (combinaci칩n de Informaci칩n de Clase y Estudiantes y Eventos) -->
        <div id="class-register" class="tab-content active">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-school"></i> Datos de la Clase</h2>
                <button class="btn btn-primary" onclick="fillDefaultData()">
                    <i class="fas fa-magic"></i> Autocompletar datos
                </button>
                <div class="grid-3">
                    <div class="form-group">
                        <label for="schoolName">Nombre del Centro:</label>
                        <input type="text" id="schoolName" placeholder="Nombre del Centro Educativo">
                    </div>
                    <div class="form-group">
                        <label for="teacherName">Profesor:</label>
                        <input type="text" id="teacherName" placeholder="Nombre del Profesor" value="Prof. Miguel Silverio">
                    </div>
                    <div class="form-group">
                        <label for="grade">Grado:</label>
                        <input type="text" id="grade" placeholder="Ej: 4to Contabilidad">
                    </div>
                </div>
                <div class="form-group">
                    <label for="subject">Materia:</label>
                    <select id="subject" onchange="toggleOtherSubject()">
                        <option value="">Seleccione una materia</option>
                        <option value="Ofim치tica">Ofim치tica</option>
                        <option value="Ingl칠s T칠cnico">Ingl칠s T칠cnico</option>
                        <option value="Ingl칠s Tur칤stico">Ingl칠s Tur칤stico</option>
                        <option value="Tecnolog칤as Digitales">Tecnolog칤as Digitales</option>
                        <option value="Lengua Espa침ola">Lengua Espa침ola</option>
                        <option value="Otra">Otra</option>
                    </select>
                    <input type="text" id="otherSubject" class="hidden" placeholder="Especifique la materia">
                </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-images"></i> Im치genes del Reporte</h2>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Encabezado:</label>
                        <button class="btn btn-primary" onclick="document.getElementById('headerImageInput').click()">
                            <i class="fas fa-upload"></i> Seleccionar Encabezado
                        </button>
                        <input type="file" id="headerImageInput" accept="image/*" style="display: none;" onchange="handleHeaderImage(event)">
                        <img id="headerImagePreview" class="header-image-preview" style="display: none;">
                    </div>
                    <div class="form-group">
                        <label>Pie de p치gina:</label>
                        <button class="btn btn-primary" onclick="document.getElementById('footerImageInput').click()">
                            <i class="fas fa-upload"></i> Seleccionar Pie de P치gina
                        </button>
                        <input type="file" id="footerImageInput" accept="image/*" style="display: none;" onchange="handleFooterImage(event)">
                        <img id="footerImagePreview" class="footer-image-preview" style="display: none;">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-clock"></i> Control de Tiempo</h2>
                <div class="timeline">
                    <div class="timeline-item">
                        <strong>Inicio de Clase</strong>
                        <span id="startTime">No iniciado</span><br><input type="time" id="manualStartTime" onchange="updateManualTime('start')">
                    </div>
                    <div class="timeline-item">
                        <strong>Fin de Clase</strong>
                        <span id="endTime">No finalizado</span><br><input type="time" id="manualEndTime" onchange="updateManualTime('end')">
                    </div>
                    <div class="timeline-item">
                        <strong>Duraci칩n</strong>
                        <span id="classDuration">--:--</span>
                    </div>
                </div>
                <button class="btn btn-success" onclick="startClass()"><i class="fas fa-play"></i> Iniciar Clase</button>
                <button class="btn btn-danger" onclick="endClass()"><i class="fas fa-stop"></i> Finalizar Clase</button>
            </div>

            <div class="card" id="studentManagementSection">
                <h2 class="card-title"><i class="fas fa-user-graduate"></i> Gesti칩n de Estudiantes</h2>
                <button class="btn btn-primary add-student-btn"><i class="fas fa-plus"></i> Agregar Estudiante</button>
                <div id="studentInputs" class="hidden"></div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-calendar-check"></i> Situaciones del Aula</h2>
                <div class="form-group">
                    <label for="classEvents">Descripci칩n del evento:</label>
                    <textarea id="classEvents" placeholder="Describe el evento ocurrido en clase..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="addEvent()"><i class="fas fa-plus"></i> Agregar Evento</button>
                
                <h3 style="margin-top: 20px;">Eventos Registrados</h3>
                <ul class="event-list" id="eventsList"></ul>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-analytics"></i> Interpretaci칩n de lo Observado</h2>
                <div class="form-group">
                    <textarea id="interpretation" placeholder="Escribe tu interpretaci칩n de lo observado..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="addInterpretation()"><i class="fas fa-plus"></i> Agregar Interpretaci칩n</button>
                
                <h3 style="margin-top: 20px;">Interpretaciones Registradas</h3>
                <ul class="interpretation-list" id="interpretationsList"></ul>
            </div>

            <!-- Registro diario Conductas y Observaciones -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> Registro diario Conductas y Observaciones</h2>
                
                <div class="report-type-selector">
                    <label><input type="radio" name="reportType" value="individual" checked onchange="toggleReportType()"> Reporte Individual</label>
                    <label><input type="radio" name="reportType" value="multiple" onchange="toggleReportType()"> Reporte M칰ltiple</label>
                    <label><input type="radio" name="reportType" value="general" onchange="toggleReportType()"> Reporte General del Curso</label>
                </div>
                
                <div id="individualReportSection">
                    <div class="form-group">
                        <label for="studentNameInput">Nombre del Estudiante:</label>
                        <input type="text" id="studentNameInput" placeholder="Escribe el nombre del estudiante">
                    </div>
                </div>
                
                <div id="multipleReportSection" style="display: none;">
                    <div class="form-group">
                        <label for="multipleStudents">Estudiantes (uno por l칤nea):</label>
                        <textarea id="multipleStudents" placeholder="Escribe los nombres de los estudiantes, uno por l칤nea"></textarea>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Seleccionar Emoji:</label>
                    <div class="emoji-selector">
                        <button class="emoji-btn" onclick="addParticipation('游녨', 'positiva')">
                            游녨
                            <span class="emoji-tooltip">Positiva - Buen trabajo</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游녩', 'negativa')">
                            游녩
                            <span class="emoji-tooltip">Negativa - Necesita mejorar</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游녪', 'participaci칩n')">
                            游녪
                            <span class="emoji-tooltip">Participaci칩n - Buena participaci칩n</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游땕', 'buena conducta')">
                            游땕
                            <span class="emoji-tooltip">Buena conducta - Comportamiento ejemplar</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游', 'mala conducta')">
                            游
                            <span class="emoji-tooltip">Mala conducta - Comportamiento inadecuado</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('仇벒잺', 'ayuda a otros')">
                            仇벒잺
                            <span class="emoji-tooltip">Ayuda a otros - Apoyo a compa침eros</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游눠', 'buena idea')">
                            游눠
                            <span class="emoji-tooltip">Buena idea - Contribuci칩n creativa</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('丘멆잺', 'llamar la atenci칩n')">
                            丘멆잺
                            <span class="emoji-tooltip">Llamar la atenci칩n - Requiere supervisi칩n</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游', 'excelente trabajo')">
                            游
                            <span class="emoji-tooltip">Excelente trabajo - Desempe침o sobresaliente</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游꿢', 'objetivo cumplido')">
                            游꿢
                            <span class="emoji-tooltip">Objetivo cumplido - Meta alcanzada</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游뱂', 'necesita mejorar')">
                            游뱂
                            <span class="emoji-tooltip">Necesita mejorar - Requiere refuerzo</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游땺', 'falta de atenci칩n')">
                            游땺
                            <span class="emoji-tooltip">Falta de atenci칩n - Desinter칠s</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('救', 'destacado')">
                            救
                            <span class="emoji-tooltip">Destacado - Rendimiento excepcional</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游뗿', 'colaboraci칩n')">
                            游뗿
                            <span class="emoji-tooltip">Colaboraci칩n - Trabajo en equipo</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游뱋', 'acuerdo cumplido')">
                            游뱋
                            <span class="emoji-tooltip">Acuerdo cumplido - Compromiso realizado</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游닄', 'estudio')">
                            游닄
                            <span class="emoji-tooltip">Estudio - Dedicaci칩n al aprendizaje</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游꿀', 'celebraci칩n')">
                            游꿀
                            <span class="emoji-tooltip">Celebraci칩n - Logro destacado</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游눩', 'esfuerzo')">
                            游눩
                            <span class="emoji-tooltip">Esfuerzo - Dedicaci칩n y perseverancia</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游', 'inteligencia')">
                            游
                            <span class="emoji-tooltip">Inteligencia - Habilidad cognitiva</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游', 'brillantez')">
                            游
                            <span class="emoji-tooltip">Brillantez - Desempe침o excepcional</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游끥', 'triunfo')">
                            游끥
                            <span class="emoji-tooltip">Triunfo - Victoria o 칠xito</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游댌', 'investigaci칩n')">
                            游댌
                            <span class="emoji-tooltip">Investigaci칩n - Esp칤ritu curioso</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游눫', 'comunicaci칩n')">
                            游눫
                            <span class="emoji-tooltip">Comunicaci칩n - Habilidad para expresarse</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游', 'compartir')">
                            游
                            <span class="emoji-tooltip">Compartir - Generosidad con otros</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游꺔', 'crecimiento')">
                            游꺔
                            <span class="emoji-tooltip">Crecimiento - Desarrollo personal</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游눪', 'inspiraci칩n')">
                            游눪
                            <span class="emoji-tooltip">Inspiraci칩n - Capacidad de motivar</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游때', 'alegr칤a')">
                            游때
                            <span class="emoji-tooltip">Alegr칤a - Expresi칩n de felicidad</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游땩', 'tristeza')">
                            游땩
                            <span class="emoji-tooltip">Tristeza - Expresi칩n de des치nimo</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游땨', 'enojo')">
                            游땨
                            <span class="emoji-tooltip">Enojo - Expresi칩n de frustraci칩n</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游땙', 'confianza')">
                            游땙
                            <span class="emoji-tooltip">Confianza - Seguridad en s칤 mismo</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游땘', 'amor')">
                            游땘
                            <span class="emoji-tooltip">Amor - Afecto hacia el aprendizaje</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游뱔', 'entusiasmo')">
                            游뱔
                            <span class="emoji-tooltip">Entusiasmo - Gran motivaci칩n</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游봅', 'celebraci칩n')">
                            游봅
                            <span class="emoji-tooltip">Celebraci칩n - Logro importante</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游뱚', 'asombro')">
                            游뱚
                            <span class="emoji-tooltip">Asombro - Aprendizaje impactante</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游뱅', 'apoyo')">
                            游뱅
                            <span class="emoji-tooltip">Apoyo - Acompa침amiento emocional</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游뱖', 'silencio')">
                            游뱖
                            <span class="emoji-tooltip">Silencio - Trabajo concentrado</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游뱐', 'deshonestidad')">
                            游뱐
                            <span class="emoji-tooltip">Deshonestidad - Falta de verdad</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游땒', 'bondad')">
                            游땒
                            <span class="emoji-tooltip">Bondad - Comportamiento ejemplar</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游봌', 's칰plica')">
                            游봌
                            <span class="emoji-tooltip">S칰plica - Necesidad de ayuda</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游봄', 'cansancio')">
                            游봄
                            <span class="emoji-tooltip">Cansancio - Falta de energ칤a</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游땷', 'ansiedad')">
                            游땷
                            <span class="emoji-tooltip">Ansiedad - Nerviosismo</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游땝', 'estr칠s')">
                            游땝
                            <span class="emoji-tooltip">Estr칠s - Presi칩n acad칠mica</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游뱀', 'inter칠s')">
                            游뱀
                            <span class="emoji-tooltip">Inter칠s - Motivaci칩n por recompensa</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游', 'enfermedad')">
                            游
                            <span class="emoji-tooltip">Enfermedad - Malestar f칤sico</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游뱃', 'lesi칩n')">
                            游뱃
                            <span class="emoji-tooltip">Lesi칩n - Da침o f칤sico</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游뱍', 'n치useas')">
                            游뱍
                            <span class="emoji-tooltip">N치useas - Malestar estomacal</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游뱙', 'v칩mito')">
                            游뱙
                            <span class="emoji-tooltip">V칩mito - Malestar intenso</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游', 'valent칤a')">
                            游
                            <span class="emoji-tooltip">Valent칤a - Coraje para participar</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游봆', 'confusi칩n')">
                            游봆
                            <span class="emoji-tooltip">Confusi칩n - Falta de comprensi칩n</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游땓', 'travesura')">
                            游땓
                            <span class="emoji-tooltip">Travesura - Comportamiento juguet칩n</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游꿉', 'graduaci칩n')">
                            游꿉
                            <span class="emoji-tooltip">Graduaci칩n - Logro acad칠mico</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游닇', 'tarea')">
                            游닇
                            <span class="emoji-tooltip">Tarea - Entrega de trabajo</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游늵', 'rendimiento')">
                            游늵
                            <span class="emoji-tooltip">Rendimiento - Desempe침o acad칠mico</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游눺', 'responsabilidad')">
                            游눺
                            <span class="emoji-tooltip">Responsabilidad - Cumplimiento de deberes</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游딖勇', 'expresi칩n oral')">
                            游딖勇
                            <span class="emoji-tooltip">Expresi칩n oral - Participaci칩n verbal</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游', 'atenci칩n')">
                            游
                            <span class="emoji-tooltip">Atenci칩n - Enfoque en clase</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('九勇', 'ejercicio')">
                            九勇
                            <span class="emoji-tooltip">Ejercicio - Realizaci칩n de actividades</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游닀', 'lectura')">
                            游닀
                            <span class="emoji-tooltip">Lectura - Participaci칩n lectora</span>
                        </button>
                        <button class="emoji-btn" onclick="addParticipation('游뱡', 'indiferencia')">
                            游뱡
                            <span class="emoji-tooltip">Indiferencia - Falta de inter칠s</span>
                        </button>
                    
<button class="emoji-btn" onclick="addParticipation('游둟勇', 'levant칩 la mano')">
    游둟勇 <span class="emoji-tooltip">Levant칩 la mano - Deseo de participar</span>
</button>
<button class="emoji-btn" onclick="addParticipation('游뗾', 'participaci칩n activa')">
    游뗾 <span class="emoji-tooltip">Participaci칩n activa - Intervenciones frecuentes</span>
</button>
<button class="emoji-btn" onclick="addParticipation('游딢勇', 'opini칩n')">
    游딢勇 <span class="emoji-tooltip">Opini칩n - Expres칩 su punto de vista</span>
</button>
<button class="emoji-btn" onclick="addParticipation('游닇', 'respuesta escrita')">
    游닇 <span class="emoji-tooltip">Respuesta escrita - Aport칩 en la pizarra/cuaderno</span>
</button>
<button class="emoji-btn" onclick="addParticipation('游꿗', 'expuso')">
    游꿗 <span class="emoji-tooltip">Expuso - Presentaci칩n oral</span>
</button>
<button class="emoji-btn" onclick="addParticipation('游뱁', 'inter칠s acad칠mico')">
    游뱁 <span class="emoji-tooltip">Inter칠s acad칠mico - Pregunt칩 o investig칩</span>
</button>
<button class="emoji-btn" onclick="addParticipation('游닉', 'aport칩 idea')">
    游닉 <span class="emoji-tooltip">Aport칩 idea - Comparti칩 con la clase</span>
</button>
<button class="emoji-btn" onclick="addParticipation('游빌', 'resoluci칩n de problema')">
    游빌 <span class="emoji-tooltip">Resoluci칩n de problema - Ayud칩 a resolver</span>
</button>
</div>
                </div>
                
                <div class="form-group">
                    <label for="participationComment">Comentario (opcional):</label>
                    <textarea id="participationComment" placeholder="Agrega un comentario sobre la participaci칩n/conducta (opcional)..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="registerParticipation()"><i class="fas fa-plus"></i> Registrar Participaci칩n/Conducta</button>
                
                <div class="participation-control">
                    <h3>Registro diario Conductas y Observaciones</h3>
                    <table class="participation-table">
                        <thead>
                            <tr>
                                <th>Estudiante(s)</th>
                                <th>Tipo</th>
                                <th>Emoji</th>
                                <th>Comentario</th>
                                <th>Hora</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="participationList">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reportes -->
        <div id="reports" class="tab-content">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-file-pdf"></i> Generar Reportes</h2>
                <button class="btn btn-primary" onclick="generateReport()"><i class="fas fa-file-alt"></i> Generar Reporte</button>
                <button class="btn btn-success" onclick="downloadPDF()"><i class="fas fa-download"></i> Descargar PDF</button>
                <button class="btn btn-warning" onclick="showInasistenciaReportForm()"><i class="fas fa-user-times"></i> Reporte de Inasistencia</button>
                <button class="btn btn-info" onclick="toggleAcuerdosForm()"><i class="fas fa-handshake"></i> Acuerdos Escolares</button>
            </div>

            <div id="inasistenciaReportForm" style="display: none;">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-exclamation-triangle"></i> Reporte de Inasistencia Consecutiva</h2>
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="studentNameInasistencia">Nombre del Estudiante:</label>
                            <input type="text" id="studentNameInasistencia" placeholder="Nombre del Estudiante">
                        </div>
                        <div class="form-group">
                            <label for="lastAttendanceDate">칔ltima Fecha de Asistencia:</label>
                            <input type="date" id="lastAttendanceDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="motivoInasistencia">Motivo del Reporte:</label>
                        <textarea id="motivoInasistencia" placeholder="Escribe el motivo del reporte..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="accionesRealizadas">Acciones Realizadas:</label>
                        <textarea id="accionesRealizadas" placeholder="Escribe las acciones realizadas antes del reporte..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addInasistenciaReport()"><i class="fas fa-plus"></i> Agregar Reporte</button>
                </div>
            </div>

            <!-- Formulario de Acuerdos Escolares - INICIALMENTE OCULTO -->
            <div id="acuerdosForm" class="hidden">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-handshake"></i> Acuerdos y Compromisos Escolares</h2>
                    
                    <div class="form-group">
                        <label for="acuerdoTituloSelect">T칤tulo del Acuerdo:</label>
                        <select id="acuerdoTituloSelect" onchange="toggleAcuerdoOtro()">
                            <option value="">Seleccione un acuerdo</option>
                            <option value="Compromiso de puntualidad">Compromiso de puntualidad</option>
                            <option value="Compromiso de entrega de tareas">Compromiso de entrega de tareas</option>
                            <option value="Compromiso de comportamiento">Compromiso de comportamiento</option>
                            <option value="Compromiso de participaci칩n">Compromiso de participaci칩n</option>
                            <option value="Otro">Otro (especificar)</option>
                        </select>
                        <input type="text" id="acuerdoTituloOtro" class="hidden" placeholder="Especifique el acuerdo">
                    </div>
                    <div class="form-group">
                        <label for="acuerdoDescripcion">Descripci칩n:</label>
                        <textarea id="acuerdoDescripcion" placeholder="Describe el acuerdo o compromiso..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="compromisosSelect">Compromisos Espec칤ficos:</label>
                        <select id="compromisosSelect" onchange="toggleCompromisoOtro()">
                            <option value="">Seleccione un compromiso</option>
                            <option value="Entregar tareas a tiempo">Entregar tareas a tiempo</option>
                            <option value="Mantener el orden en clase">Mantener el orden en clase</option>
                            <option value="Participar activamente">Participar activamente</option>
                            <option value="Respetar a compa침eros y profesor">Respetar a compa침eros y profesor</option>
                            <option value="Otro">Otro (especificar)</option>
                        </select>
                        <input type="text" id="compromisoOtro" class="hidden" placeholder="Especifique el compromiso">
                        <textarea id="acuerdoCompromisos" class="hidden" placeholder="Lista de compromisos (uno por l칤nea)..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="acuerdoParticipantes">Participantes:</label>
                        <textarea id="acuerdoParticipantes" placeholder="Nombres de los participantes..."></textarea>
                    </div>
                    <div class="grid-3">
                        <div class="form-group">
                            <label for="acuerdoFechaCompromiso">Fecha de Compromiso:</label>
                            <input type="date" id="acuerdoFechaCompromiso">
                        </div>
                        <div class="form-group">
                            <label for="acuerdoFechaSeguimiento">Fecha de Seguimiento:</label>
                            <input type="date" id="acuerdoFechaSeguimiento">
                        </div>
                        <div class="form-group">
                            <label for="acuerdoFechaEntrega">Fecha de Entrega:</label>
                            <input type="date" id="acuerdoFechaEntrega">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addAcuerdo()"><i class="fas fa-plus"></i> Agregar Acuerdo</button>
                </div>
                
                <div class="card">
                    <h3 class="card-title">Acuerdos Registrados</h3>
                    <div id="acuerdosList"></div>
                </div>
            </div>

            <div class="report-preview" id="reportPreview">
                <p class="text-center">Presiona "Generar Reporte" para ver la vista previa</p>
            </div>
        </div>

        <!-- Evidencias -->
        <div id="evidence" class="tab-content">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-camera"></i> Capturar Evidencias</h2>
                <p>Utiliza esta funci칩n para capturar evidencia de que los estudiantes han le칤do tu reporte.</p>
                
                <div class="grid-2">
                    <button class="btn btn-primary" onclick="openCamera()"><i class="fas fa-camera"></i> Tomar Foto</button>
                    <button class="btn btn-primary" onclick="document.getElementById('uploadFileInput').click()">
                        <i class="fas fa-upload"></i> Subir Archivo
                    </button>
                    <input type="file" id="uploadFileInput" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx" style="display: none;" onchange="handleFileUpload(event)">
                </div>
                
                <div class="evidence-container">
                    <h3>Evidencias Capturadas</h3>
                    <div id="evidenceList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer navigation - ELIMINADO BOT칍N DE DESCARGA -->
    <div class="footer-nav">
        <a href="javascript:void(0)" onclick="switchTab('class-register')" class="footer-nav-btn">
            <i class="fas fa-chalkboard-teacher"></i>
            <span>Registro</span>
        </a>
        <a href="javascript:void(0)" onclick="switchTab('reports')" class="footer-nav-btn">
            <i class="fas fa-file-pdf"></i>
            <span>Reportes</span>
        </a>
        <a href="javascript:void(0)" onclick="switchTab('evidence')" class="footer-nav-btn">
            <i class="fas fa-camera"></i>
            <span>Evidencias</span>
        </a>
        <a href="javascript:void(0)" onclick="addStudentForm()" class="footer-nav-btn">
            <i class="fas fa-user-plus"></i>
            <span>Agregar Estudiante</span>
        </a>
    </div>

    <!-- Modal para la c치mara -->
    <div id="cameraModal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-camera"></i> Capturar Evidencia</h2>
            <p>Pide al estudiante que se situ칠 frente a la c치mara mientras lee el reporte.</p>
            
            <video id="video" class="camera-feed" autoplay></video>
            <canvas id="canvas" style="display: none;"></canvas>
            
            <div>
                <button class="btn btn-success" onclick="capturePhoto()"><i class="fas fa-camera"></i> Capturar Foto</button>
                <button class="btn btn-danger" onclick="closeCamera()"><i class="fas fa-times"></i> Cerrar</button>
            </div>
            
            <img id="photoPreview" class="photo-preview" style="display: none;">
            
            <div id="captureActions" style="display: none; margin-top: 1rem;">
                <div class="form-group">
                    <label for="evidenceObservation">Observaciones:</label>
                    <textarea id="evidenceObservation" placeholder="Agregar observaciones sobre esta evidencia..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="savePhoto()"><i class="fas fa-save"></i> Guardar Evidencia</button>
                <button class="btn" onclick="retakePhoto()"><i class="fas fa-redo"></i> Volver a Capturar</button>
            </div>
        </div>
    </div>

    <!-- Modal para editar participaci칩n -->
    <div id="editParticipationModal" class="modal">
        <div class="edit-modal-content">
            <h2><i class="fas fa-edit"></i> Editar Participaci칩n/Conducta</h2>
            
            <div class="form-group">
                <label for="editStudentName">Nombre del Estudiante:</label>
                <input type="text" id="editStudentName" placeholder="Nombre del estudiante">
            </div>
            
            <div class="form-group">
                <label>Seleccionar Emoji:</label>
                <div class="edit-emoji-selector">
                    <button class="emoji-btn" onclick="addEmojiToEdit('游녨', 'positiva')">
                        游녨
                        <span class="emoji-tooltip">Positiva - Buen trabajo</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游녩', 'negativa')">
                        游녩
                        <span class="emoji-tooltip">Negativa - Necesita mejorar</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游녪', 'participaci칩n')">
                        游녪
                        <span class="emoji-tooltip">Participaci칩n - Buena participaci칩n</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游땕', 'buena conducta')">
                        游땕
                        <span class="emoji-tooltip">Buena conducta - Comportamiento ejemplar</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游', 'mala conducta')">
                        游
                        <span class="emoji-tooltip">Mala conducta - Comportamiento inadecuado</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('仇벒잺', 'ayuda a otros')">
                        仇벒잺
                        <span class="emoji-tooltip">Ayuda a otros - Apoyo a compa침eros</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游눠', 'buena idea')">
                        游눠
                        <span class="emoji-tooltip">Buena idea - Contribuci칩n creativa</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('丘멆잺', 'llamar la atenci칩n')">
                        丘멆잺
                        <span class="emoji-tooltip">Llamar la atenci칩n - Requiere supervisi칩n</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游', 'excelente trabajo')">
                        游
                        <span class="emoji-tooltip">Excelente trabajo - Desempe침o sobresaliente</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游꿢', 'objetivo cumplido')">
                        游꿢
                        <span class="emoji-tooltip">Objetivo cumplido - Meta alcanzada</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游뱂', 'necesita mejorar')">
                        游뱂
                        <span class="emoji-tooltip">Necesita mejorar - Requiere refuerzo</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游땺', 'falta de atenci칩n')">
                        游땺
                        <span class="emoji-tooltip">Falta de atenci칩n - Desinter칠s</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('救', 'destacado')">
                        救
                        <span class="emoji-tooltip">Destacado - Rendimiento excepcional</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游뗿', 'colaboraci칩n')">
                        游뗿
                        <span class="emoji-tooltip">Colaboraci칩n - Trabajo en equipo</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游뱋', 'acuerdo cumplido')">
                        游뱋
                        <span class="emoji-tooltip">Acuerdo cumplido - Compromiso realizado</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游닄', 'estudio')">
                        游닄
                        <span class="emoji-tooltip">Estudio - Dedicaci칩n al aprendizaje</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游꿀', 'celebraci칩n')">
                        游꿀
                        <span class="emoji-tooltip">Celebraci칩n - Logro destacado</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游눩', 'esfuerzo')">
                        游눩
                        <span class="emoji-tooltip">Esfuerzo - Dedicaci칩n y perseverancia</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游', 'inteligencia')">
                        游
                        <span class="emoji-tooltip">Inteligencia - Habilidad cognitiva</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游', 'brillantez')">
                        游
                        <span class="emoji-tooltip">Brillantez - Desempe침o excepcional</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游끥', 'triunfo')">
                        游끥
                        <span class="emoji-tooltip">Triunfo - Victoria o 칠xito</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游댌', 'investigaci칩n')">
                        游댌
                        <span class="emoji-tooltip">Investigaci칩n - Esp칤ritu curioso</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游눫', 'comunicaci칩n')">
                        游눫
                        <span class="emoji-tooltip">Comunicaci칩n - Habilidad para expresarse</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游', 'compartir')">
                        游
                        <span class="emoji-tooltip">Compartir - Generosidad con otros</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游꺔', 'crecimiento')">
                        游꺔
                        <span class="emoji-tooltip">Crecimiento - Desarrollo personal</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游눪', 'inspiraci칩n')">
                        游눪
                        <span class="emoji-tooltip">Inspiraci칩n - Capacidad de motivar</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游때', 'alegr칤a')">
                        游때
                        <span class="emoji-tooltip">Alegr칤a - Expresi칩n de felicidad</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游땩', 'tristeza')">
                        游땩
                        <span class="emoji-tooltip">Tristeza - Expresi칩n de des치nimo</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游땨', 'enojo')">
                        游땨
                        <span class="emoji-tooltip">Enojo - Expresi칩n de frustraci칩n</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游땙', 'confianza')">
                        游땙
                        <span class="emoji-tooltip">Confianza - Seguridad en s칤 mismo</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游땘', 'amor')">
                        游땘
                        <span class="emoji-tooltip">Amor - Afecto hacia el aprendizaje</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游뱔', 'entusiasmo')">
                        游뱔
                        <span class="emoji-tooltip">Entusiasmo - Gran motivaci칩n</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游봅', 'celebraci칩n')">
                        游봅
                        <span class="emoji-tooltip">Celebraci칩n - Logro importante</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游뱚', 'asombro')">
                        游뱚
                        <span class="emoji-tooltip">Asombro - Aprendizaje impactante</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游뱅', 'apoyo')">
                        游뱅
                        <span class="emoji-tooltip">Apoyo - Acompa침amiento emocional</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游뱖', 'silencio')">
                        游뱖
                        <span class="emoji-tooltip">Silencio - Trabajo concentrado</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游뱐', 'deshonestidad')">
                        游뱐
                        <span class="emoji-tooltip">Deshonestidad - Falta de verdad</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游땒', 'bondad')">
                        游땒
                        <span class="emoji-tooltip">Bondad - Comportamiento ejemplar</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游봌', 's칰plica')">
                        游봌
                        <span class="emoji-tooltip">S칰plica - Necesidad de ayuda</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游봄', 'cansancio')">
                        游봄
                        <span class="emoji-tooltip">Cansancio - Falta de energ칤a</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游땷', 'ansiedad')">
                        游땷
                        <span class="emoji-tooltip">Ansiedad - Nerviosismo</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游땝', 'estr칠s')">
                        游땝
                        <span class="emoji-tooltip">Estr칠s - Presi칩n acad칠mica</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游뱀', 'inter칠s')">
                        游뱀
                        <span class="emoji-tooltip">Inter칠s - Motivaci칩n por recompensa</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游', 'enfermedad')">
                        游
                        <span class="emoji-tooltip">Enfermedad - Malestar f칤sico</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游뱃', 'lesi칩n')">
                        游뱃
                        <span class="emoji-tooltip">Lesi칩n - Da침o f칤sico</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游뱍', 'n치useas')">
                        游뱍
                        <span class="emoji-tooltip">N치useas - Malestar estomacal</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游뱙', 'v칩mito')">
                        游뱙
                        <span class="emoji-tooltip">V칩mito - Malestar intenso</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游', 'valent칤a')">
                        游
                        <span class="emoji-tooltip">Valent칤a - Coraje para participar</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游봆', 'confusi칩n')">
                        游봆
                        <span class="emoji-tooltip">Confusi칩n - Falta de comprensi칩n</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游땓', 'travesura')">
                        游땓
                        <span class="emoji-tooltip">Travesura - Comportamiento juguet칩n</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游꿉', 'graduaci칩n')">
                        游꿉
                        <span class="emoji-tooltip">Graduaci칩n - Logro acad칠mico</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游닇', 'tarea')">
                        游닇
                        <span class="emoji-tooltip">Tarea - Entrega de trabajo</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游늵', 'rendimiento')">
                        游늵
                        <span class="emoji-tooltip">Rendimiento - Desempe침o acad칠mico</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游눺', 'responsabilidad')">
                        游눺
                        <span class="emoji-tooltip">Responsabilidad - Cumplimiento de deberes</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游딖勇', 'expresi칩n oral')">
                        游딖勇
                        <span class="emoji-tooltip">Expresi칩n oral - Participaci칩n verbal</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游', 'atenci칩n')">
                        游
                        <span class="emoji-tooltip">Atenci칩n - Enfoque en clase</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('九勇', 'ejercicio')">
                        九勇
                        <span class="emoji-tooltip">Ejercicio - Realizaci칩n de actividades</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游닀', 'lectura')">
                        游닀
                        <span class="emoji-tooltip">Lectura - Participaci칩n lectora</span>
                    </button>
                    <button class="emoji-btn" onclick="addEmojiToEdit('游뱡', 'indiferencia')">
                        游뱡
                        <span class="emoji-tooltip">Indiferencia - Falta de inter칠s</span>
                    </button>
                
<button class="emoji-btn" onclick="addParticipation('游둟勇', 'levant칩 la mano')">
    游둟勇 <span class="emoji-tooltip">Levant칩 la mano - Deseo de participar</span>
</button>
<button class="emoji-btn" onclick="addParticipation('游뗾', 'participaci칩n activa')">
    游뗾 <span class="emoji-tooltip">Participaci칩n activa - Intervenciones frecuentes</span>
</button>
<button class="emoji-btn" onclick="addParticipation('游딢勇', 'opini칩n')">
    游딢勇 <span class="emoji-tooltip">Opini칩n - Expres칩 su punto de vista</span>
</button>
<button class="emoji-btn" onclick="addParticipation('游닇', 'respuesta escrita')">
    游닇 <span class="emoji-tooltip">Respuesta escrita - Aport칩 en la pizarra/cuaderno</span>
</button>
<button class="emoji-btn" onclick="addParticipation('游꿗', 'expuso')">
    游꿗 <span class="emoji-tooltip">Expuso - Presentaci칩n oral</span>
</button>
<button class="emoji-btn" onclick="addParticipation('游뱁', 'inter칠s acad칠mico')">
    游뱁 <span class="emoji-tooltip">Inter칠s acad칠mico - Pregunt칩 o investig칩</span>
</button>
<button class="emoji-btn" onclick="addParticipation('游닉', 'aport칩 idea')">
    游닉 <span class="emoji-tooltip">Aport칩 idea - Comparti칩 con la clase</span>
</button>
<button class="emoji-btn" onclick="addParticipation('游빌', 'resoluci칩n de problema')">
    游빌 <span class="emoji-tooltip">Resoluci칩n de problema - Ayud칩 a resolver</span>
</button>
</div>
            </div>
            
            <div class="form-group">
                <label for="editComment">Comentario:</label>
                <textarea id="editComment" placeholder="Agrega un comentario sobre la participaci칩n/conducta..." rows="4"></textarea>
<select id="quickComments" onchange="document.getElementById('editComment').value = this.value;">
  <option value="">-- Seleccionar comentario r치pido --</option>
  <option value="游뱡 Ausente: El o La estudiante no asisti칩 a clase, sali칩 con permiso o present칩 excusa. Favor verificar el pase de lista en el registro para validar la informaci칩n.">游뱡 Ausente</option>
</select>
            </div>
            
            <input type="hidden" id="editIndex">
            
            <button class="btn btn-primary" onclick="saveEditedParticipation()"><i class="fas fa-save"></i> Guardar Cambios</button>
            <button class="btn btn-danger" onclick="closeEditModal()"><i class="fas fa-times"></i> Cancelar</button>
        </div>
    </div>

    <script>
        // Variables globales
        let students = [];
        let events = [];
        let interpretations = [];
        let inasistenciaReports = [];
        let acuerdos = [];
        let startTime = null;
        let endTime = null;
        let classDurationInterval = null;
        let capturedEvidence = [];
        let stream = null;
        let headerImage = null;
        let footerImage = null;
        let participationRecords = [];
        let currentStudentIndex = 1;
        let outsideStudents = [];
        let studentFormVisible = false;
        let outsideStudentsInterval = null;

        
    function updateManualTime(type) {
        if (type === 'start') {
            const manual = document.getElementById('manualStartTime').value;
            if (manual) {
                document.getElementById('startTime').textContent = manual;
            }
        } else if (type === 'end') {
            const manual = document.getElementById('manualEndTime').value;
            if (manual) {
                document.getElementById('endTime').textContent = manual;
            }
        }
    }
    
// Inicializar la p치gina
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar el tipo de reporte
            toggleReportType();
            
            // Configurar la fecha actual en los reportes
            const today = new Date();
            document.getElementById('lastAttendanceDate').valueAsDate = today;
            document.getElementById('acuerdoFechaCompromiso').valueAsDate = today;
            
            // Establecer fecha de seguimiento para 7 d칤as despu칠s
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            document.getElementById('acuerdoFechaSeguimiento').valueAsDate = nextWeek;
            document.getElementById('acuerdoFechaEntrega').valueAsDate = nextWeek;

            // Iniciar intervalo para actualizar el tiempo de estudiantes fuera
            startOutsideStudentsInterval();
        });

        // Funci칩n para iniciar el intervalo de actualizaci칩n de tiempo fuera
        function startOutsideStudentsInterval() {
            if (outsideStudentsInterval) clearInterval(outsideStudentsInterval);
            
            outsideStudentsInterval = setInterval(() => {
                updateOutsideStudentsList();
            }, 1000);
        }

        // Funci칩n para navegar a la secci칩n de estudiantes
        function navigateToStudentSection() {
            switchTab('class-register');
            document.getElementById('studentManagementSection').scrollIntoView({
                behavior: 'smooth'
            });
            toggleStudentForm();
        }

        // Funci칩n para autocompletar datos
        function fillDefaultData() {
            document.getElementById('schoolName').value = "Polit칠cnico Santo Esteban Rivera";
            document.getElementById('teacherName').value = "Miguel Silverio";
            document.getElementById('subject').value = "Ingl칠s";
            showNotification("Datos autocompletados correctamente", "success");
        }

        // Funciones de la interfaz
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab:nth-child(${Array.from(document.querySelectorAll('.tab')).findIndex(t => t.getAttribute('onclick').includes(tabId)) + 1})`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        function toggleReportType() {
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            
            // Ocultar todas las secciones primero
            document.getElementById('individualReportSection').style.display = 'none';
            document.getElementById('multipleReportSection').style.display = 'none';
            
            // Mostrar la secci칩n correspondiente
            if (reportType === 'individual') {
                document.getElementById('individualReportSection').style.display = 'block';
            } else if (reportType === 'multiple') {
                document.getElementById('multipleReportSection').style.display = 'block';
            }
            // Para 'general' no se muestra ninguna secci칩n adicional
        }

        function showInasistenciaReportForm() {
            document.getElementById("inasistenciaReportForm").style.display = "block";
            document.getElementById("acuerdosForm").classList.add("hidden");
        }

        function toggleAcuerdosForm() {
            const acuerdosForm = document.getElementById("acuerdosForm");
            if (acuerdosForm.classList.contains("hidden")) {
                acuerdosForm.classList.remove("hidden");
                document.getElementById("inasistenciaReportForm").style.display = "none";
                
                // Actualizar la lista de acuerdos
                updateAcuerdosList();
            } else {
                acuerdosForm.classList.add("hidden");
            }
        }

        function toggleOtherSubject() {
            const subjectSelect = document.getElementById('subject');
            const otherSubjectInput = document.getElementById('otherSubject');
            
            if (subjectSelect.value === 'Otra') {
                otherSubjectInput.classList.remove('hidden');
            } else {
                otherSubjectInput.classList.add('hidden');
            }
        }

        function toggleAcuerdoOtro() {
            const select = document.getElementById('acuerdoTituloSelect');
            const otroInput = document.getElementById('acuerdoTituloOtro');
            
            if (select.value === 'Otro') {
                otroInput.classList.remove('hidden');
            } else {
                otroInput.classList.add('hidden');
            }
        }

        function toggleCompromisoOtro() {
            const select = document.getElementById('compromisosSelect');
            const otroInput = document.getElementById('compromisoOtro');
            const textarea = document.getElementById('acuerdoCompromisos');
            
            if (select.value === 'Otro') {
                otroInput.classList.remove('hidden');
                textarea.classList.add('hidden');
            } else if (select.value) {
                otroInput.classList.add('hidden');
                textarea.classList.remove('hidden');
                textarea.value = select.value;
            } else {
                otroInput.classList.add('hidden');
                textarea.classList.add('hidden');
            }
        }

        function handleHeaderImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    headerImage = e.target.result;
                    const preview = document.getElementById('headerImagePreview');
                    preview.src = headerImage;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function handleFooterImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    footerImage = e.target.result;
                    const preview = document.getElementById('footerImagePreview');
                    preview.src = footerImage;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Guardar el archivo en el array de evidencias
                    capturedEvidence.push({
                        type: file.type.includes('image') ? "image" : "document",
                        data: e.target.result,
                        timestamp: new Date(),
                        formattedTime: formatDateTime(new Date()),
                        filename: file.name,
                        observation: ""
                    });
                    
                    // Actualizar la lista de evidencias
                    updateEvidenceList();
                    
                    showNotification("Archivo subido correctamente", "success");
                };
                reader.readAsDataURL(file);
            }
        }

        function startClass() {
            startTime = new Date();
            document.getElementById("startTime").textContent = formatDateTime(startTime);
            
            // Iniciar contador de duraci칩n
            if (classDurationInterval) clearInterval(classDurationInterval);
            classDurationInterval = setInterval(updateClassDuration, 1000);
            
            // Mostrar notificaci칩n
            showNotification("Clase iniciada", "success");
        }

        function endClass() {
            endTime = new Date();
            document.getElementById("endTime").textContent = formatDateTime(endTime);
            
            // Detener contador de duraci칩n
            if (classDurationInterval) clearInterval(classDurationInterval);
            updateClassDuration();
            
            // Mostrar notificaci칩n
            showNotification("Clase finalizada", "success");
        }

        function updateClassDuration() {
            if (!startTime) return;
            
            const now = endTime || new Date();
            const duration = Math.floor((now - startTime) / 1000);
            const hours = Math.floor(duration / 3600);
            const minutes = Math.floor((duration % 3600) / 60);
            const seconds = duration % 60;
            
            document.getElementById("classDuration").textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function toggleStudentForm() {
            const studentInputs = document.getElementById("studentInputs");
            if (studentInputs.classList.contains("hidden")) {
                studentInputs.classList.remove("hidden");
                studentFormVisible = true;
            } else {
                studentInputs.classList.add("hidden");
                studentFormVisible = false;
            }
        }

        function addStudentForm() {
            navigateToStudentSection();
        }

        function addStudentFormFields() {
            const studentCount = currentStudentIndex;
            const studentForm = `
                <div id="student${studentCount}" class="student-box">
                    <h3>Estudiante ${studentCount}</h3>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Nombre:</label>
                            <input type="text" id="studentNameInput${studentCount}" placeholder="Nombre del estudiante">
                        </div>
                        <div class="form-group">
                            <label>Raz칩n:</label>
                            <input type="text" id="reason${studentCount}" placeholder="Raz칩n de salida">
                        </div>
                    </div>
                    <button class="btn btn-sm btn-warning" onclick="startStudentTimer(${studentCount})"><i class="fas fa-sign-out-alt"></i> Registrar Salida</button>
                    <button class="btn btn-sm btn-success" onclick="stopStudentTimer(${studentCount})"><i class="fas fa-sign-in-alt"></i> Registrar Retorno</button>
                    <div class="timer-display" id="timer${studentCount}">00:00</div>
                    <p id="exitTime${studentCount}"></p>
                    <p id="returnTime${studentCount}"></p>
                    <p id="totalTime${studentCount}"></p>
                </div>
            `;
            document.getElementById("studentInputs").insertAdjacentHTML('beforeend', studentForm);
            students.push({ 
                name: "", 
                reason: "", 
                startTime: null, 
                returnTime: null, 
                duration: 0, 
                comment: "",
                timerInterval: null,
                timerElement: `timer${studentCount}`
            });
            
            currentStudentIndex++;
        }

        function startStudentTimer(studentIndex) {
            const student = students[studentIndex - 1];
            student.name = document.getElementById(`studentNameInput${studentIndex}`).value;
            student.reason = document.getElementById(`reason${studentIndex}`).value;
            
            if (!student.name || !student.reason) {
                showNotification("Completa los campos antes de registrar la salida", "error");
                return;
            }
            
            student.startTime = new Date();
            document.getElementById(`exitTime${studentIndex}`).textContent = `Hora de salida: ${formatDateTime(student.startTime)}`;
            
            // Cambiar estilo para indicar que el estudiante sali칩
            document.getElementById(`student${studentIndex}`).style.borderLeftColor = "#e74c3c";
            
            // Iniciar temporizador
            student.timerInterval = setInterval(() => {
                const elapsed = new Date() - student.startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById(`timer${studentIndex}`).innerText = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
            
            // Agregar estudiante a la lista de fuera del aula
            outsideStudents.push({
                id: studentIndex,
                name: student.name,
                reason: student.reason,
                startTime: student.startTime,
                timerInterval: student.timerInterval
            });
            
            updateOutsideStudentsList();
            
            showNotification(`Salida registrada para ${student.name}`, "success");
        }

        function stopStudentTimer(studentIndex) {
            const student = students[studentIndex - 1];
            
            if (!student.startTime) {
                showNotification("Primero debe registrar la salida del estudiante", "error");
                return;
            }
            
            student.returnTime = new Date();
            clearInterval(student.timerInterval);
            
            const duration = Math.floor((student.returnTime - student.startTime) / 60000);
            student.duration = duration;
            
            document.getElementById(`returnTime${studentIndex}`).textContent = `Hora de retorno: ${formatDateTime(student.returnTime)}`;
            document.getElementById(`totalTime${studentIndex}`).textContent = `Tiempo fuera: ${duration} minutos`;
            
            // Asignar comentario seg칰n el tiempo
            if (duration <= 2) {
                student.comment = "Regres칩 en un tiempo prudente.";
            } else if (duration <= 3) {
                student.comment = "Regres칩 con una ligera demora.";
            } else {
                student.comment = "Regres칩 con una tardanza considerable.";
            }
            
            // Restaurar estilo
            document.getElementById(`student${studentIndex}`).style.borderLeftColor = "#3498db";
            
            // Ocultar el formulario despu칠s de registrar el retorno
            document.getElementById(`student${studentIndex}`).style.display = "none";
            
            // Limpiar campos despu칠s de registrar el retorno
            document.getElementById(`studentNameInput${studentIndex}`).value = "";
            document.getElementById(`reason${studentIndex}`).value = "";
            document.getElementById(`timer${studentIndex}`).innerText = "00:00";
            
            // Remover estudiante de la lista de fuera del aula
            outsideStudents = outsideStudents.filter(s => s.id !== studentIndex);
            updateOutsideStudentsList();
            
            showNotification(`Retorno registrado para ${student.name}`, "success");
        }

        function updateOutsideStudentsList() {
            const outsideList = document.getElementById("outsideStudentsList");
            const indicator = document.getElementById("studentOutsideIndicator");
            if (!outsideList || !indicator) return;
            
            if (outsideStudents.length === 0) {
                indicator.style.display = "none";
                return;
            }
            
            indicator.style.display = "block";
            
            // Map existing elements by student id to update in place (avoid flicker)
            const existing = {};
            Array.from(outsideList.children).forEach(child => {
                const id = child.getAttribute('data-student-id');
                if (id) existing[id] = child;
            });
            
            const currentIds = outsideStudents.map(s => String(s.id));
            
            outsideStudents.forEach(student => {
                const sid = String(student.id);
                const now = new Date();
                const elapsed = Math.floor((now - student.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeText = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
                
                if (existing[sid]) {
                    // actualizar solo el texto
                    const el = existing[sid];
                    const timeEl = el.querySelector('.student-time');
                    const nameEl = el.querySelector('.student-name');
                    const reasonEl = el.querySelector('.student-reason');
                    if (timeEl) timeEl.textContent = timeText;
                    if (nameEl) nameEl.textContent = student.name;
                    if (reasonEl) reasonEl.textContent = student.reason;
                    delete existing[sid];
                } else {
                    // crear nuevo elemento
                    const studentElement = document.createElement("div");
                    studentElement.className = "outside-student";
                    studentElement.setAttribute('data-student-id', sid);
                    studentElement.innerHTML = `
                        <div class="student-info" style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span class="blinking-light red-light"></span>
                                <span class="student-name"><strong>${student.name}</strong></span>
                            </div>
                            <span class="student-time">${timeText}</span>
                        </div>
                        <div class="student-reason">${student.reason}</div>
                        <button class="btn btn-sm btn-success" onclick="stopStudentTimer(${student.id})" style="margin-top: 8px;">
                            <i class="fas fa-sign-in-alt"></i> Registrar Retorno
                        </button>
                    `;
                    outsideList.appendChild(studentElement);
                }
            });
            
            // eliminar nodos que ya no est치n en outsideStudents
            Object.keys(existing).forEach(id => {
                const node = existing[id];
                if (node && node.parentNode) node.parentNode.removeChild(node);
            });
        }

        function addEvent() {
            const eventText = document.getElementById("classEvents").value;
            if (!eventText.trim()) {
                showNotification("Escribe un evento antes de agregarlo", "error");
                return;
            }
            
            const event = {
                text: eventText,
                time: new Date(),
                formattedTime: formatDateTime(new Date())
            };
            
            events.push(event);
            updateEventsList();
            document.getElementById("classEvents").value = "";
            
            showNotification("Evento agregado correctamente", "success");
        }

        function updateEventsList() {
            const eventsList = document.getElementById("eventsList");
            if (!eventsList) return;
            eventsList.innerHTML = "";
            
            events.forEach((event, index) => {
                const li = document.createElement("li");
                li.className = "event-item";
                li.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                        <div>
                            <strong>Evento ${index + 1}:</strong> ${event.text}
                            <div class="event-time">${event.formattedTime}</div>
                        </div>
                        <div style="display:flex; gap:6px;">
                            <button class="btn btn-sm btn-primary" onclick="editEvent(${index})"><i class="fas fa-edit"></i> Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEvent(${index})"><i class="fas fa-trash"></i> Eliminar</button>
                        </div>
                    </div>
                `;
                eventsList.appendChild(li);
            });
        }

        function addInterpretation() {
            const interpretationText = document.getElementById("interpretation").value;
            if (!interpretationText.trim()) {
                showNotification("Escribe una interpretaci칩n antes de agregarla", "error");
                return;
            }
            
            const interpretation = {
                text: interpretationText,
                time: new Date(),
                formattedTime: formatDateTime(new Date())
            };
            
            interpretations.push(interpretation);
            updateInterpretationsList();
            document.getElementById("interpretation").value = "";
            
            showNotification("Interpretaci칩n agregada correctamente", "success");
        }

        function updateInterpretationsList() {
            const interpretationsList = document.getElementById("interpretationsList");
            if (!interpretationsList) return;
            interpretationsList.innerHTML = "";
            
            interpretations.forEach((interpretation, index) => {
                const li = document.createElement("li");
                li.className = "interpretation-item";
                li.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                        <div>
                            <strong>Interpretaci칩n ${index + 1}:</strong> ${interpretation.text}
                            <div class="interpretation-time">${interpretation.formattedTime}</div>
                        </div>
                        <div style="display:flex; gap:6px;">
                            <button class="btn btn-sm btn-primary" onclick="editInterpretation(${index})"><i class="fas fa-edit"></i> Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteInterpretation(${index})"><i class="fas fa-trash"></i> Eliminar</button>
                        </div>
                    </div>
                `;
                interpretationsList.appendChild(li);
            });
        }

        function addInasistenciaReport() {
            const studentName = document.getElementById("studentNameInasistencia").value;
            const lastAttendanceDate = document.getElementById("lastAttendanceDate").value;
            const motivo = document.getElementById("motivoInasistencia").value;
            const acciones = document.getElementById("accionesRealizadas").value;
            
            if (!studentName || !lastAttendanceDate || !motivo || !acciones) {
                showNotification("Completa todos los campos antes de agregar el reporte", "error");
                return;
            }
            
            const report = {
                studentName,
                lastAttendanceDate,
                motivo,
                acciones,
                reportDate: formatDate(new Date()),
                teacherName: document.getElementById("teacherName").value || "Prof. Miguel Silverio",
                grade: document.getElementById("grade").value,
                subject: document.getElementById("subject").value
            };
            
            inasistenciaReports.push(report);
            
            // Limpiar formulario
            document.getElementById("studentNameInasistencia").value = "";
            document.getElementById("lastAttendanceDate").value = "";
            document.getElementById("motivoInasistencia").value = "";
            document.getElementById("accionesRealizadas").value = "";
            document.getElementById("inasistenciaReportForm").style.display = "none";
            
            showNotification("Reporte de inasistencia agregado correctamente", "success");
        }

        function addAcuerdo() {
            let titulo = document.getElementById("acuerdoTituloSelect").value;
            if (titulo === "Otro") {
                titulo = document.getElementById("acuerdoTituloOtro").value;
            }
            
            const descripcion = document.getElementById("acuerdoDescripcion").value;
            
            let compromisos = document.getElementById("acuerdoCompromisos").value;
            if (document.getElementById("compromisoOtro").value) {
                compromisos = document.getElementById("compromisoOtro").value;
            }
            
            const participantes = document.getElementById("acuerdoParticipantes").value;
            const fechaCompromiso = document.getElementById("acuerdoFechaCompromiso").value;
            const fechaSeguimiento = document.getElementById("acuerdoFechaSeguimiento").value;
            const fechaEntrega = document.getElementById("acuerdoFechaEntrega").value;
            
            if (!titulo || !descripcion) {
                showNotification("Completa al menos el t칤tulo y la descripci칩n del acuerdo", "error");
                return;
            }
            
            // Obtener datos autom치ticos de la clase
            const teacherName = document.getElementById("teacherName").value || "Prof. Miguel Silverio";
            const grade = document.getElementById("grade").value;
            const subjectSelect = document.getElementById("subject");
            const subject = subjectSelect.value === "Otra" ? document.getElementById("otherSubject").value : subjectSelect.value;
            const schoolName = document.getElementById("schoolName").value;
            
            const acuerdo = {
                titulo,
                descripcion,
                compromisos,
                participantes,
                fechaCompromiso: formatDate(new Date(fechaCompromiso)),
                fechaSeguimiento: formatDate(new Date(fechaSeguimiento)),
                fechaEntrega: formatDate(new Date(fechaEntrega)),
                fechaCreacion: formatDate(new Date()),
                teacherName,
                grade,
                subject,
                schoolName
            };
            
            acuerdos.push(acuerdo);
            
            // Limpiar formulario
            document.getElementById("acuerdoTituloSelect").value = "";
            document.getElementById("acuerdoTituloOtro").value = "";
            document.getElementById("acuerdoTituloOtro").classList.add("hidden");
            document.getElementById("acuerdoDescripcion").value = "";
            document.getElementById("compromisosSelect").value = "";
            document.getElementById("compromisoOtro").value = "";
            document.getElementById("compromisoOtro").classList.add("hidden");
            document.getElementById("acuerdoCompromisos").value = "";
            document.getElementById("acuerdoCompromisos").classList.add("hidden");
            document.getElementById("acuerdoParticipantes").value = "";
            
            // Ocultar formulario despu칠s de agregar
            document.getElementById("acuerdosForm").classList.add("hidden");
            
            // Actualizar lista de acuerdos
            updateAcuerdosList();
            
            showNotification("Acuerdo escolar agregado correctamente", "success");
        }

        function updateAcuerdosList() {
            const acuerdosList = document.getElementById("acuerdosList");
            acuerdosList.innerHTML = "";
            
            if (acuerdos.length === 0) {
                acuerdosList.innerHTML = "<p>No hay acuerdos registrados a칰n.</p>";
                return;
            }
            
            acuerdos.forEach((acuerdo, index) => {
                const acuerdoItem = document.createElement("div");
                acuerdoItem.className = "acuerdo-item";
                
                acuerdoItem.innerHTML = `
                    <h4>${acuerdo.titulo}</h4>
                    <p><strong>Fecha de creaci칩n:</strong> ${acuerdo.fechaCreacion}</p>
                    <p><strong>Descripci칩n:</strong> ${acuerdo.descripcion}</p>
                    ${acuerdo.compromisos ? `<p><strong>Compromisos:</strong><br>${acuerdo.compromisos.replace(/\n/g, '<br>')}</p>` : ''}
                    ${acuerdo.participantes ? `<p><strong>Participantes:</strong> ${acuerdo.participantes}</p>` : ''}
                    <p><strong>Fecha de compromiso:</strong> ${acuerdo.fechaCompromiso}</p>
                    <p><strong>Fecha de seguimiento:</strong> ${acuerdo.fechaSeguimiento}</p>
                    <p><strong>Fecha de entrega:</strong> ${acuerdo.fechaEntrega}</p>
                    <button class="btn btn-sm btn-danger" onclick="deleteAcuerdo(${index})"><i class="fas fa-trash"></i> Eliminar</button>
                `;
                
                acuerdosList.appendChild(acuerdoItem);
            });
        }

        function deleteAcuerdo(index) {
            acuerdos.splice(index, 1);
            updateAcuerdosList();
            showNotification("Acuerdo eliminado", "info");
        }

        // Funciones para el nuevo sistema de participaci칩n
        function addParticipation(emoji, type) {
            document.getElementById("participationComment").value += ` ${emoji} (${type})`;
        }

        function registerParticipation() {
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            const comment = document.getElementById("participationComment").value;
            
            let students = [];
            
            if (reportType === "individual") {
                const studentName = document.getElementById("studentNameInput").value;
                
                if (!studentName.trim()) {
                    showNotification("Escribe el nombre del estudiante para el reporte individual", "error");
                    return;
                }
                
                students = [studentName];
            } else if (reportType === "multiple") {
                const multipleStudentsText = document.getElementById("multipleStudents").value;
                
                if (!multipleStudentsText.trim()) {
                    showNotification("Escribe los nombres de los estudiantes para el reporte m칰ltiple", "error");
                    return;
                }
                
                // Dividir por l칤neas y filtrar vac칤os
                students = multipleStudentsText.split('\n')
                    .map(name => name.trim())
                    .filter(name => name !== "");
            } else if (reportType === "general") {
                students = ["Todo el curso"];
            }
            
            // Crear un registro por cada estudiante
            students.forEach(studentName => {
                const participation = {
                    studentName,
                    comment,
                    time: new Date(),
                    formattedTime: formatDateTime(new Date())
                };
                
                participationRecords.push(participation);
            });
            
            updateParticipationList();
            document.getElementById("participationComment").value = "";
            document.getElementById("studentNameInput").value = "";
            document.getElementById("multipleStudents").value = "";
            
            showNotification("Participaci칩n/conducta registrada correctamente", "success");
        }

        function updateParticipationList() {
            const participationList = document.getElementById("participationList");
            participationList.innerHTML = "";
            
            if (participationRecords.length === 0) {
                participationList.innerHTML = "<tr><td colspan='6'>No hay registros de participaci칩n/conducta a칰n.</td></tr>";
                return;
            }
            
            participationRecords.forEach((record, index) => {
                const row = document.createElement("tr");
                
                // Extraer emojis y tipo del comentario
                const emojiMatch = record.comment.match(/([\u{1F300}-\u{1F9FF}])/gu);
                const emoji = emojiMatch ? emojiMatch[0] : "游닇";
                
                const typeMatch = record.comment.match(/\(([^)]+)\)/);
                const type = typeMatch ? typeMatch[1] : "comentario";
                
                // Determinar clase de badge seg칰n el tipo
                let badgeClass = "badge-neutral";
                if (type.includes("positiva") || type.includes("buena") || type.includes("participaci칩n") || type.includes("ayuda") || type.includes("excelente") || type.includes("objetivo") || type.includes("destacado") || type.includes("colaboraci칩n") || type.includes("acuerdo") || type.includes("estudio") || type.includes("celebraci칩n") || type.includes("esfuerzo") || type.includes("inteligencia") || type.includes("brillantez") || type.includes("triunfo") || type.includes("investigaci칩n") || type.includes("comunicaci칩n") || type.includes("compartir") || type.includes("crecimiento") || type.includes("inspiraci칩n")) {
                    badgeClass = "badge-positive";
                } else if (type.includes("negativa") || type.includes("mala") || type.includes("atenci칩n") || type.includes("mejorar") || type.includes("falta")) {
                    badgeClass = "badge-negative";
                }
                
                row.innerHTML = `
                    <td>${record.studentName}</td>
                    <td><span class="participation-badge ${badgeClass}">${type}</span></td>
                    <td>${emoji}</td>
                    <td>${record.comment}</td>
                    <td>${record.formattedTime}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editParticipation(${index})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteParticipation(${index})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                
                participationList.appendChild(row);
            });
        }

        function editParticipation(index) {
            const record = participationRecords[index];
            
            // Llenar el modal con los datos actuales
            document.getElementById('editStudentName').value = record.studentName;
            document.getElementById('editComment').value = record.comment;
            document.getElementById('editIndex').value = index;
            
            // Mostrar el modal
            document.getElementById('editParticipationModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editParticipationModal').style.display = 'none';
        }

        function addEmojiToEdit(emoji, type) {
            const commentTextarea = document.getElementById('editComment');
            commentTextarea.value += ` ${emoji} (${type})`;
        }

        function saveEditedParticipation() {
            const index = document.getElementById('editIndex').value;
            if (index === "") return;
            
            const studentName = document.getElementById('editStudentName').value;
            const comment = document.getElementById('editComment').value;
            
            if (!studentName) {
                showNotification("El nombre del estudiante es obligatorio", "error");
                return;
            }
            
            participationRecords[index].studentName = studentName;
            participationRecords[index].comment = comment;
            
            updateParticipationList();
            closeEditModal();
            showNotification("Registro actualizado correctamente", "success");
        }

        function deleteParticipation(index) {
            participationRecords.splice(index, 1);
            updateParticipationList();
            showNotification("Registro de participaci칩n eliminado", "info");
        }

        // Funciones para la c치mara y captura de evidencias
        function openCamera() {
            const modal = document.getElementById("cameraModal");
            modal.style.display = "flex";
            
            const video = document.getElementById("video");
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(mediaStream) {
                        video.srcObject = mediaStream;
                        stream = mediaStream;
                    })
                    .catch(function(error) {
                        console.error("Error al acceder a la c치mara: ", error);
                        showNotification("Error al acceder a la c치mara", "error");
                    });
            } else {
                showNotification("Tu navegador no soporta acceso a la c치mara", "error");
            }
        }

        function closeCamera() {
            const modal = document.getElementById("cameraModal");
            modal.style.display = "none";
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Restablecer elementos de la c치mara
            document.getElementById("photoPreview").style.display = "none";
            document.getElementById("captureActions").style.display = "none";
            const video = document.getElementById("video");
            video.style.display = "block";
        }

        function capturePhoto() {
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const context = canvas.getContext('2d');
            const photoPreview = document.getElementById("photoPreview");
            
            // Configurar las dimensiones del canvas con las del video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Dibujar el frame actual del video en el canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convertir el canvas a una imagen y mostrarla
            photoPreview.src = canvas.toDataURL('image/png');
            photoPreview.style.display = "block";
            
            // Ocultar el video y mostrar las opciones de guardar/recapturar
            video.style.display = "none";
            document.getElementById("captureActions").style.display = "block";
        }

        function retakePhoto() {
            const video = document.getElementById("video");
            const photoPreview = document.getElementById("photoPreview");
            
            // Volver a mostrar el video y ocultar la foto preview
            video.style.display = "block";
            photoPreview.style.display = "none";
            document.getElementById("captureActions").style.display = "none";
        }

        function savePhoto() {
            const canvas = document.getElementById("canvas");
            const imageData = canvas.toDataURL('image/png');
            const observation = document.getElementById("evidenceObservation").value;
            
            // Guardar la foto en el array de evidencias
            capturedEvidence.push({
                type: "image",
                data: imageData,
                timestamp: new Date(),
                formattedTime: formatDateTime(new Date()),
                filename: "foto_evidencia.png",
                observation: observation
            });
            
            // Actualizar la lista de evidencias
            updateEvidenceList();
            
            // Limpiar campo de observaciones
            document.getElementById("evidenceObservation").value = "";
            
            // Cerrar la c치mara
            closeCamera();
            
            showNotification("Evidencia capturada correctamente", "success");
        }

        function updateEvidenceList() {
            const evidenceList = document.getElementById("evidenceList");
            evidenceList.innerHTML = "";
            
            if (capturedEvidence.length === 0) {
                evidenceList.innerHTML = "<p>No hay evidencias capturadas a칰n.</p>";
                return;
            }
            
            capturedEvidence.forEach((evidence, index) => {
                const evidenceItem = document.createElement("div");
                evidenceItem.className = "evidence-item";
                
                if (evidence.type === "image") {
                    evidenceItem.innerHTML = `
                        <p><strong>Foto de evidencia</strong> - ${evidence.formattedTime}</p>
                        <img src="${evidence.data}" class="evidence-image" alt="Evidencia ${index + 1}">
                    `;
                } else if (evidence.type === "document") {
                    evidenceItem.innerHTML = `
                        <p><strong>Documento:</strong> ${evidence.filename} - ${evidence.formattedTime}</p>
                        <a href="${evidence.data}" download="${evidence.filename}" class="btn btn-sm btn-primary">
                            <i class="fas fa-download"></i> Descargar documento
                        </a>
                    `;
                }
                
                // Agregar observaciones si existen
                if (evidence.observation) {
                    evidenceItem.innerHTML += `
                        <p><strong>Observaciones:</strong> ${evidence.observation}</p>
                    `;
                }
                
                // Agregar campo para editar observaciones
                evidenceItem.innerHTML += `
                    <div class="form-group evidence-observation">
                        <label>Agregar/Editar observaciones:</label>
                        <textarea id="evidenceObservation${index}" placeholder="Agregar observaciones sobre esta evidencia...">${evidence.observation || ''}</textarea>
                        <button class="btn btn-sm btn-primary" onclick="updateEvidenceObservation(${index})">
                            <i class="fas fa-save"></i> Guardar observaci칩n
                        </button>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="deleteEvidence(${index})"><i class="fas fa-trash"></i> Eliminar</button>
                    <hr>
                `;
                
                evidenceList.appendChild(evidenceItem);
            });
        }

        function updateEvidenceObservation(index) {
            const observation = document.getElementById(`evidenceObservation${index}`).value;
            capturedEvidence[index].observation = observation;
            showNotification("Observaci칩n guardada correctamente", "success");
        }

        function deleteEvidence(index) {
            capturedEvidence.splice(index, 1);
            updateEvidenceList();
            showNotification("Evidencia eliminada", "info");
        }

        

        // Funciones para editar/eliminar eventos e interpretaciones
        function editEvent(index) {
            const current = events[index];
            if (!current) return;
            const nuevo = prompt('Editar evento:', current.text);
            if (nuevo === null) return;
            events[index].text = nuevo.trim();
            updateEventsList();
            showNotification('Evento editado', 'success');
        }

        function deleteEvent(index) {
            if (!confirm('쮼liminar este evento?')) return;
            events.splice(index, 1);
            updateEventsList();
            showNotification('Evento eliminado', 'info');
        }

        function editInterpretation(index) {
            const current = interpretations[index];
            if (!current) return;
            const nuevo = prompt('Editar interpretaci칩n:', current.text);
            if (nuevo === null) return;
            interpretations[index].text = nuevo.trim();
            updateInterpretationsList();
            showNotification('Interpretaci칩n editada', 'success');
        }

        function deleteInterpretation(index) {
            if (!confirm('쮼liminar esta interpretaci칩n?')) return;
            interpretations.splice(index, 1);
            updateInterpretationsList();
            showNotification('Interpretaci칩n eliminada', 'info');
        }

function generateReport() {
            const teacherName = document.getElementById("teacherName").value || "Prof. Miguel Silverio";
            const grade = document.getElementById("grade").value;
            const subjectSelect = document.getElementById("subject");
            const subject = subjectSelect.value === "Otra" ? document.getElementById("otherSubject").value : subjectSelect.value;
            const schoolName = document.getElementById("schoolName").value;
            const date = formatDate(new Date());
            
            let content = '';
            
            // Agregar encabezado con imagen si existe
            if (headerImage) {
                content += `<div style="text-align: center; margin-bottom: 20px;">
                    <img src="${headerImage}" style="max-width: 100%;">
                </div>`;
            }
            
            content += `
                <div class="report-header">
                    <h2>REGISTRO ANECD칍TICO DE ${grade}</h2>
                    <p><strong>Centro Educativo:</strong> ${schoolName}</p>
                    <p><strong>Fecha:</strong> ${date}</p>
                </div>
                
                <div class="report-section">
                    <h3>Informaci칩n General</h3>
                    <p><strong>Profesor:</strong> ${teacherName}</p>
                    <p><strong>Grado/Secci칩n:</strong> ${grade}</p>
                    <p><strong>Materia:</strong> ${subject}</p>
                    <p><strong>Inicio:</strong> ${startTime ? formatDateTime(startTime) : "No registrado"}</p>
                    <p><strong>Fin:</strong> ${endTime ? formatDateTime(endTime) : "No registrado"}</p>
                    <p><strong>Duraci칩n:</strong> ${document.getElementById("classDuration").textContent}</p>
                </div>
            `;
            
            if (students.length > 0) {
                content += `
                    <div class="report-section">
                        <h3>Registro de Salidas de Estudiantes</h3>
                `;
                
                students.forEach((student, index) => {
                    if (student.name) {
                        content += `
                            <p><strong>Estudiante ${index + 1}:</strong> ${student.name}</p>
                            <p><strong>Raz칩n:</strong> ${student.reason}</p>
                            <p><strong>Hora de salida:</strong> ${student.startTime ? formatDateTime(student.startTime) : "No registrada"}</p>
                            <p><strong>Hora de retorno:</strong> ${student.returnTime ? formatDateTime(student.returnTime) : "No registrada"}</p>
                            <p><strong>Tiempo fuera:</strong> ${student.duration} minutos</p>
                            <p><strong>Observaci칩n:</strong> ${student.comment}</p>
                            <hr>
                        `;
                    }
                });
                
                content += `</div>`;
            }
            
            if (events.length > 0) {
                content += `
                    <div class="report-section">
                        <h3>Situaciones Ocurridas en el Aula</h3>
                        <ul>
                `;
                
                events.forEach((event, index) => {
                    content += `
                        <li>
                            <strong>Evento ${index + 1}:</strong> ${event.text}
                            <div><small>${event.formattedTime}</small></div>
                        </li>
                    `;
                });
                
                content += `
                        </ul>
                    </div>
                `;
            }
            
            if (interpretations.length > 0) {
                content += `
                    <div class="report-section">
                        <h3>Interpretaci칩n de lo Observado</h3>
                        <ul>
                `;
                
                interpretations.forEach((interpretation, index) => {
                    content += `
                        <li>
                            <strong>Interpretaci칩n ${index + 1}:</strong> ${interpretation.text}
                            <div><small>${interpretation.formattedTime}</small></div>
                        </li>
                    `;
                });
                
                content += `
                        </ul>
                    </div>
                `;
            }
            
            if (participationRecords.length > 0) {
                content += `
                    <div class="report-section">
                        <h3>Registro de Participaci칩n y Conducta</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="background-color: #2c3e50; color: white;">
                                <th style="padding: 10px; text-align: left;">Estudiante(s)</th>
                                <th style="padding: 10px; text-align: left;">Comentario</th>
                                <th style="padding: 10px; text-align: left;">Hora</th>
                            </tr>
                `;
                
                participationRecords.forEach((record, index) => {
                    content += `
                        <tr style="${index % 2 === 0 ? 'background-color: #f2f2f2;' : ''}">
                            <td style="padding: 10px; border: 1px solid #ddd;">${record.studentName}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${record.comment}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${record.formattedTime}</td>
                        </tr>
                    `;
                });
                
                content += `</table></div>`;
            }
            
            if (inasistenciaReports.length > 0) {
                content += `
                    <div class="report-section">
                        <h3>Reportes de Inasistencia</h3>
                `;
                
                inasistenciaReports.forEach((report, index) => {
                    content += `
                        <p><strong>Reporte ${index + 1}:</strong> ${report.studentName}</p>
                        <p><strong>칔ltima fecha de asistencia:</strong> ${report.lastAttendanceDate}</p>
                        <p><strong>Motivo:</strong> ${report.motivo}</p>
                        <p><strong>Acciones realizadas:</strong> ${report.acciones}</p>
                        <p><strong>Fecha del reporte:</strong> ${report.reportDate}</p>
                        <hr>
                    `;
                });
                
                content += `</div>`;
            }
            
            if (acuerdos.length > 0) {
                content += `
                    <div class="report-section">
                        <h3>Acuerdos and Compromisos Escolares</h3>
                `;
                
                acuerdos.forEach((acuerdo, index) => {
                    content += `
                        <p><strong>Acuerdo ${index + 1}:</strong> ${acuerdo.titulo}</p>
                        <p><strong>Fecha de creaci칩n:</strong> ${acuerdo.fechaCreacion}</p>
                        <p><strong>Descripci칩n:</strong> ${acuerdo.descripcion}</p>
                        ${acuerdo.compromisos ? `<p><strong>Compromisos:</strong><br>${acuerdo.compromisos.replace(/\n/g, '<br>')}</p>` : ''}
                        ${acuerdo.participantes ? `<p><strong>Participantes:</strong> ${acuerdo.participantes}</p>` : ''}
                        <p><strong>Fecha de compromiso:</strong> ${acuerdo.fechaCompromiso}</p>
                        <p><strong>Fecha de seguimiento:</strong> ${acuerdo.fechaSeguimiento}</p>
                        <p><strong>Fecha de entrega:</strong> ${acuerdo.fechaEntrega}</p>
                        <hr>
                    `;
                });
                
                content += `</div>`;
            }
            
            if (capturedEvidence.length > 0) {
                content += `
                    <div class="report-section">
                        <h3>Evidencias de Revisi칩n</h3>
                        <div class="conformity-statement">
                            <h4>Declaraci칩n de Conformidad</h4>
                            <p>Confirmo que he le칤do y acepto el contenido de este reporte, comprometi칠ndome a cumplir los acuerdos establecidos. El profesor certifica que las evidencias en este registro de tareas o disciplinario han sido verificadas y son aut칠nticas, suficientes y pertinentes para los fines acad칠micos.</p>
                        </div>
                `;
                
                capturedEvidence.forEach((evidence, index) => {
                    if (evidence.type === "image") {
                        content += `
                            <p><strong>Foto de evidencia ${index + 1}</strong> - ${evidence.formattedTime}</p>
                            <img src="${evidence.data}" style="max-width: 300px; border-radius: 5px; margin: 10px 0;" alt="Evidencia ${index + 1}">
                        `;
                    } else if (evidence.type === "document") {
                        content += `
                            <p><strong>Documento ${index + 1}:</strong> ${evidence.filename} - ${evidence.formattedTime}</p>
                        `;
                    }
                    
                    if (evidence.observation) {
                        content += `<p><strong>Observaciones:</strong> ${evidence.observation}</p>`;
                    }
                    
                    content += `<hr>`;
                });
                
                content += `</div>`;
            }
            
            // Agregar pie de p치gina con imagen si existe
            if (footerImage) {
                content += `<div style="text-align: center; margin-top: 30px;">
                    <img src="${footerImage}" style="max-width: 100%;">
                </div>`;
            }
            
            document.getElementById("reportPreview").innerHTML = content;
        }

        async function downloadPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Obtener el grado para el nombre del archivo
                const grade = document.getElementById("grade").value || "Grado";
                
                // Obtener la fecha actual en formato DD-MMM-YYYY
                const today = new Date();
                const day = today.getDate();
                const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                const month = monthNames[today.getMonth()];
                const year = today.getFullYear();
                const dateString = `${day}-${month}-${year}`;
                
                const fileName = `${grade} - ${dateString}.pdf`;
                
                // Capturar el contenido del reporte con html2canvas
                const element = document.getElementById('reportPreview');
                
                // A침adir m치rgenes
                const margin = 15;
                const pdfWidth = doc.internal.pageSize.getWidth() - 2 * margin;
                
                // Calcular la altura del contenido
                const canvas = await html2canvas(element, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = pdfWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // A침adir la imagen al PDF
                let heightLeft = imgHeight;
                let position = 0;
                
                doc.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                heightLeft -= doc.internal.pageSize.getHeight();
                
                // Agregar p치ginas adicionales si es necesario
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                    heightLeft -= doc.internal.pageSize.getHeight();
                }
                
                // Guardar el PDF
                doc.save(fileName);
                showNotification("PDF generado y descargado", "success");
            } catch (error) {
                console.error("Error al generar el PDF:", error);
                showNotification("Error al generar el PDF. Por favor, intente nuevamente.", "error");
            }
        }

        function showNotification(message, type) {
            // Crear notificaci칩n toast
            const toast = document.createElement("div");
            toast.style.position = "fixed";
            toast.style.bottom = "70px";
            toast.style.left = "50%";
            toast.style.transform = "translateX(-50%)";
            toast.style.padding = "10px 20px";
            toast.style.borderRadius = "5px";
            toast.style.color = "white";
            toast.style.zIndex = "1000";
            toast.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)";
            
            if (type === "success") {
                toast.style.backgroundColor = "#2ecc71";
            } else if (type === "error") {
                toast.style.backgroundColor = "#e74c3c";
            } else if (type === "warning") {
                toast.style.backgroundColor = "#f39c12";
            } else {
                toast.style.backgroundColor = "#3498db";
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Eliminar despu칠s de 3 segundos
            setTimeout(() => {
                toast.style.opacity = "0";
                toast.style.transition = "opacity 0.5s";
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 500);
            }, 3000);
        }

        function formatDate(date) {
            const options = { day: '2-digit', month: 'short', year: 'numeric' };
            return date.toLocaleDateString('es-ES', options).toUpperCase();
        }

        function formatDateTime(date) {
            const options = { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            };
            return date.toLocaleDateString('es-ES', options).toUpperCase();
        }
    </script>

<script>
// Funci칩n para alternar la visibilidad del formulario de agregar estudiante
function toggleStudentForm() {
    const form = document.getElementById("formAgregarEstudiante");
    if (form) {
        form.style.display = form.style.display === "none" ? "block" : "none";
    }
}

// Funci칩n para agregar estudiante a la tabla existente
function agregarEstudiante(event) {
    event.preventDefault();
    const nombre = document.getElementById("nombreEstudiante").value.trim();
    const telefono = document.getElementById("telefonoEstudiante").value.trim();
    const correo = document.getElementById("correoEstudiante").value.trim();
    if (!nombre || !telefono || !correo) {
        alert("Por favor, completa todos los campos.");
        return;
    }

    const tabla = document.getElementById("tablaEstudiantes");
    if (tabla) {
        const fila = document.createElement("tr");
        fila.innerHTML = `
            <td>${nombre}</td>
            <td>${telefono}</td>
            <td>${correo}</td>
        `;
        tabla.appendChild(fila);
    }

    document.getElementById("nombreEstudiante").value = "";
    document.getElementById("telefonoEstudiante").value = "";
    document.getElementById("correoEstudiante").value = "";
    document.getElementById("formAgregarEstudiante").style.display = "none";
}
</script>


<!-- MODAL PARA AGREGAR ESTUDIANTE -->
<div class="modal" id="addStudentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Agregar Estudiante</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="studentName">Nombre del estudiante</label>
                <input type="text" id="studentName" class="form-control" placeholder="Ingrese el nombre del estudiante">
            </div>
            <div class="form-group">
                <label for="reason">Motivo de salida</label>
                <textarea id="reason" placeholder="Ingrese el motivo de salida"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" id="confirmExit">Confirmar salida</button>
        </div>
    </div>
</div>

<!-- CONTENEDOR PARA TARJETAS DE ESTUDIANTES FUERA DEL AULA -->
<div class="floating-students" id="floatingStudents"></div>

<!-- SCRIPTS NECESARIOS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Abrir modal
    $('.add-student-btn').click(function() {
        $('#addStudentModal').fadeIn();
    });

    // Cerrar modal
    $('.close').click(function() {
        $('#addStudentModal').fadeOut();
    });

    // Confirmar salida
    $('#confirmExit').click(function() {
        const studentName = $('#studentName').val().trim();
        const reason = $('#reason').val().trim();
        
        if (!studentName || !reason) {
            alert('Por favor, complete todos los campos');
            return;
        }

        // Integrar con la l칩gica existente: crear el formulario interno y usar startStudentTimer
        if (typeof addStudentFormFields === 'function') {
            addStudentFormFields();
            // el 칤ndice del nuevo estudiante es currentStudentIndex - 1
            const newIndex = currentStudentIndex - 1;
            // llenar campos justo despu칠s de insertarlos
            setTimeout(function() {
                const nameInput = document.getElementById(`studentNameInput${newIndex}`);
                const reasonInput = document.getElementById(`reason${newIndex}`);
                if (nameInput) nameInput.value = studentName;
                if (reasonInput) reasonInput.value = reason;
                
                if (typeof startStudentTimer === 'function') {
                    startStudentTimer(newIndex);
                }
                // actualizar indicador
                if (typeof updateOutsideStudentsList === 'function') updateOutsideStudentsList();
                // hacer scroll al nuevo registro
                const el = document.getElementById(`student${newIndex}`);
                if (el) el.scrollIntoView({behavior: 'smooth', block: 'center'});
            }, 50);
        } else {
            // Fallback: crear tarjeta flotante si no existe la funci칩n
            if (typeof createStudentOutCard === 'function') createStudentOutCard(studentName, reason);
        }

        // cerrar modal y limpiar
        $('#addStudentModal').fadeOut();
        $('#studentName').val('');
        $('#reason').val('');
    });
// Crear tarjeta flotante
    function createStudentOutCard(name, reason) {
        const cardId = 'student-' + Date.now();
        const card = $(`
            <div class="student-out-card" id="${cardId}">
                <div class="student-out-header">
                    <div class="student-name">${name}</div>
                    <div class="student-timer">00:00:00</div>
                </div>
                <div class="student-reason">${reason}</div>
                <button class="return-btn">Registrar regreso</button>
            </div>`
        );

        $('#floatingStudents').append(card);
        startTimer(cardId);

        card.find('.return-btn').click(function() {
            card.remove();
            updateStudentStatus(name, 'present');
        });
    }

    // Temporizador en tiempo real
    function startTimer(cardId) {
        const startTime = new Date();
        const timerElement = $('#' + cardId).find('.student-timer');
        
        const timerInterval = setInterval(function() {
            const now = new Date();
            const diff = now - startTime;
            
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            timerElement.text(
                `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`
            );

            if (!$('#' + cardId).length) {
                clearInterval(timerInterval);
            }
        }, 1000);
    }

    // Simular actualizaci칩n de estado
    function updateStudentStatus(name, status) {
        console.log(`Estudiante ${name} ha regresado. Estado actualizado a: ${status}`);
    }
});
</script>

</body>
</html>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

  import { 
    getAuth,
    createUserWithEmailAndPassword,
    sendPasswordResetEmail,
    sendEmailVerification
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  import { 
    getFirestore 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


  const firebaseConfig = {
    apiKey: "AIzaSyCY14LkfciAkiQK8tqFedBR1oNsSJYy_NM",
    authDomain: "registro-anecdotico-4e9f9.firebaseapp.com",
    projectId: "registro-anecdotico-4e9f9",
    storageBucket: "registro-anecdotico-4e9f9.firebasestorage.app",
    messagingSenderId: "452165916569",
    appId: "1:452165916569:web:38eba932b3a9b13cdd6508"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  console.log("游댠 Firebase conectado correctamente");
</script>
</body>
// CREAR USUARIO DESDE PANEL ADMIN
window.crearUsuarioAdmin = async function(email) {
  try {

    const passwordTemporal = Math.random().toString(36).slice(-8);

    const userCredential = await createUserWithEmailAndPassword(auth, email, passwordTemporal);

    await sendPasswordResetEmail(auth, email);

    alert("九 Usuario creado y correo enviado para crear contrase침a.");

    console.log("Usuario creado:", userCredential.user.uid);

  } catch (error) {
    alert("仇 Error: " + error.message);
  }
};
</html>
