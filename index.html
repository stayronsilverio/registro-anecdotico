<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Registro Anecd√≥tico</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- FIREBASE COMPAT -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
    :root {
        --primary: #2c3e50;
        --secondary: #3498db;
        --accent: #e74c3c;
        --light: #ecf0f1;
        --dark: #2c3e50;
        --success: #2ecc71;
        --warning: #f39c12;
        --danger: #e74c3c;
        --gray: #95a5a6;
        --light-gray: #f5f5f5;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
        background-color: #f8f9fa;
        color: #333;
        line-height: 1.6;
        padding-bottom: 120px;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }
    
    header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
        padding: 1.5rem 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        position: relative;
        margin-bottom: 2rem;
    }
    
    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .app-title {
        font-size: 1.8rem;
        font-weight: 600;
    }
    
    .copyright {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .card-title {
        font-size: 1.3rem;
        color: var(--primary);
        margin-bottom: 1.2rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--light);
        display: flex;
        align-items: center;
    }
    
    .card-title i {
        margin-right: 10px;
        color: var(--secondary);
    }
    
    .form-group {
        margin-bottom: 1.2rem;
    }
    
    label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--dark);
    }
    
    input[type="text"], 
    input[type="date"], 
    input[type="time"],
    input[type="file"],
    textarea, 
    select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        transition: border 0.3s ease, box-shadow 0.3s ease;
    }
    
    input[type="text"]:focus, 
    input[type="date"]:focus, 
    input[type="time"]:focus,
    textarea:focus, 
    select:focus {
        border-color: var(--secondary);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        outline: none;
    }
    
    textarea {
        min-height: 100px;
        resize: vertical;
    }
    
    .btn {
        display: inline-block;
        padding: 12px 20px;
        background-color: var(--secondary);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
    }
    
    .btn:hover {
        opacity: 0.9;
        transform: translateY(-2px);
    }
    
    .btn-primary {
        background-color: var(--primary);
    }
    
    .btn-success {
        background-color: var(--success);
    }
    
    .btn-danger {
        background-color: var(--danger);
    }
    
    .btn-warning {
        background-color: var(--warning);
    }
    
    .btn-info {
        background-color: #17a2b8;
    }
    
    .btn-sm {
        padding: 8px 15px;
        font-size: 0.9rem;
    }
    
    .timeline {
        display: flex;
        justify-content: space-between;
        margin: 1.5rem 0;
        gap: 1rem;
    }
    
    .timeline-item {
        text-align: center;
        flex: 1;
        padding: 1rem;
        background: var(--light);
        border-radius: 8px;
    }
    
    .timeline-item strong {
        display: block;
        font-size: 1.1rem;
        margin-bottom: 5px;
        color: var(--primary);
    }
    
    .student-box {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: var(--light-gray);
    }
    
    .student-box h3 {
        margin-bottom: 0.8rem;
        color: var(--primary);
    }
    
    .timer-display {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
        margin: 10px 0;
        color: var(--secondary);
    }
    
    .event-list, .interpretation-list {
        list-style-type: none;
    }
    
    .event-item, .interpretation-item {
        padding: 1rem;
        background: var(--light-gray);
        border-left: 4px solid var(--secondary);
        margin-bottom: 0.8rem;
        border-radius: 0 4px 4px 0;
    }
    
    .event-time, .interpretation-time {
        font-size: 0.85rem;
        color: var(--gray);
        margin-top: 5px;
    }
    
    .report-preview {
        padding: 2rem;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        margin-top: 2rem;
    }
    
    .report-header {
        text-align: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--light);
    }
    
    .report-section {
        margin-bottom: 1.5rem;
    }
    
    .report-section h3 {
        color: var(--primary);
        margin-bottom: 0.8rem;
        padding-bottom: 0.3rem;
        border-bottom: 1px solid var(--light);
    }
    
    .tabs {
        display: flex;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #ddd;
    }
    
    .tab {
        padding: 12px 20px;
        cursor: pointer;
        background: #f1f1f1;
        border-radius: 5px 5px 0 0;
        margin-right: 5px;
    }
    
    .tab.active {
        background: white;
        border: 1px solid #ddd;
        border-bottom: none;
        font-weight: 500;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }
    
    .grid-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1.5rem;
    }
    
    @media (max-width: 992px) {
        .grid-2, .grid-3 {
            grid-template-columns: 1fr;
        }
        
        .timeline {
            flex-direction: column;
        }
    }
    
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        max-width: 90%;
        max-height: 90%;
        overflow: auto;
        text-align: center;
    }
    
    .camera-feed {
        width: 100%;
        max-width: 500px;
        background: #333;
        margin: 1rem 0;
        border-radius: 5px;
    }
    
    .photo-preview {
        max-width: 100%;
        margin-top: 1rem;
        border-radius: 5px;
        border: 2px solid var(--secondary);
    }
    
    .evidence-container {
        margin: 1.5rem 0;
        padding: 1rem;
        background: var(--light-gray);
        border-radius: 8px;
    }
    
    .evidence-image {
        max-width: 100%;
        border-radius: 5px;
        margin-top: 1rem;
    }
    
    .footer-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--primary);
        display: flex;
        justify-content: space-around;
        padding: 10px 0;
        z-index: 99;
    }
    
    .footer-nav-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: white;
        text-decoration: none;
        font-size: 0.8rem;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        background: none;
        border: none;
        transition: background 0.3s;
    }
    
    .footer-nav-btn:hover {
        background: rgba(255,255,255,0.1);
    }
    
    .footer-nav-btn i {
        font-size: 1.2rem;
        margin-bottom: 5px;
    }
    
    .participation-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    
    .participation-table th, 
    .participation-table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
    }
    
    .participation-table th {
        background-color: var(--primary);
        color: white;
    }
    
    .participation-table tr:nth-child(even) {
        background-color: #f2f2f2;
    }
    
    .emoji-selector {
        display: flex;
        gap: 10px;
        margin: 10px 0;
        flex-wrap: wrap;
    }
    
    .emoji-btn {
        font-size: 1.5rem;
        background: none;
        border: none;
        cursor: pointer;
        transition: transform 0.2s;
        position: relative;
    }
    
    .emoji-btn:hover {
        transform: scale(1.2);
    }
    
    .emoji-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
        z-index: 1000;
    }
    
    .emoji-btn:hover .emoji-tooltip {
        opacity: 1;
        visibility: visible;
    }
    
    .participation-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 20px;
        font-size: 0.8rem;
        margin-right: 5px;
    }
    
    .badge-positive {
        background-color: var(--success);
        color: white;
    }
    
    .badge-negative {
        background-color: var(--danger);
        color: white;
    }
    
    .hidden {
        display: none;
    }
    
    .header-buttons {
        display: flex;
        gap: 10px;
    }
</style>
</head>
<body>

<div id="login-page">
    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); display: flex; align-items: center; justify-content: center; z-index: 999;">
        <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center;">
            <h2 style="color: #2c3e50; margin-bottom: 10px;">Sistema de Registro Anecd√≥tico</h2>
            <p style="color: #7f8c8d; margin-bottom: 30px;">Inicia sesi√≥n para continuar</p>
            
            <div style="margin-bottom: 15px; text-align: left;">
                <label style="color: #2c3e50; font-weight: 500; display: block; margin-bottom: 5px;">Correo electr√≥nico</label>
                <input type="email" id="usuario" placeholder="ejemplo@correo.com" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
            </div>
            
            <div style="margin-bottom: 15px; text-align: left;">
                <label style="color: #2c3e50; font-weight: 500; display: block; margin-bottom: 5px;">Contrase√±a</label>
                <input type="password" id="password" placeholder="Ingresa tu contrase√±a" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
            </div>
            
            <button onclick="validarLogin()" style="width: 100%; padding: 12px; background: linear-gradient(to right, #2c3e50, #3498db); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                <i class="fas fa-sign-in-alt"></i> Ingresar al Sistema
            </button>
            
            <p id="error-msg" style="color: #e74c3c; margin-top: 15px; display: none;"></p>
            <p id="success-msg" style="color: #2ecc71; margin-top: 15px; display: none;"><i class="fas fa-check-circle"></i> Credenciales correctas, redirigiendo...</p>
            
            <div style="margin-top: 25px; font-size: 12px; color: #7f8c8d;">
                Sistema de Registro Anecd√≥tico | v5.0<br>
                Desarrollado por Miguel Silverio
            </div>
        </div>
    </div>
</div>

<div id="main-page" style="display:none;">
    <button id="logout-btn" style="position:fixed; top:15px; right:15px; padding:10px 15px; background:linear-gradient(to right,#e74c3c,#c0392b); color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; z-index:9999;">
        <i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n
    </button>

    <header>
        <div class="container header-content">
            <h1 class="app-title"><i class="fas fa-clipboard-list"></i> Sistema de Registro Anecd√≥tico</h1>
            <div class="copyright">¬© 2026 Prof. Miguel Silverio</div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('class-register')">Registro de Clase</div>
            <div class="tab" onclick="switchTab('reports')">Reportes</div>
            <div class="tab" onclick="switchTab('evidence')">Evidencias</div>
        </div>

        <!-- TAB 1: Registro de Clase -->
        <div id="class-register" class="tab-content active">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-school"></i> Datos de la Clase</h2>
                <div class="grid-3">
                    <div class="form-group">
                        <label for="schoolName">Nombre del Centro:</label>
                        <input type="text" id="schoolName" placeholder="Nombre del Centro Educativo">
                    </div>
                    <div class="form-group">
                        <label for="teacherName">Profesor:</label>
                        <input type="text" id="teacherName" placeholder="Nombre del Profesor" value="Prof. Miguel Silverio">
                    </div>
                    <div class="form-group">
                        <label for="grade">Grado:</label>
                        <input type="text" id="grade" placeholder="Ej: 4to Contabilidad">
                    </div>
                </div>
                <div class="form-group">
                    <label for="subject">Materia:</label>
                    <select id="subject">
                        <option value="">Seleccione una materia</option>
                        <option value="Ofim√°tica">Ofim√°tica</option>
                        <option value="Ingl√©s T√©cnico">Ingl√©s T√©cnico</option>
                        <option value="Ingl√©s Tur√≠stico">Ingl√©s Tur√≠stico</option>
                        <option value="Lengua Espa√±ola">Lengua Espa√±ola</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-clock"></i> Control de Tiempo</h2>
                <div class="timeline">
                    <div class="timeline-item">
                        <strong>Inicio de Clase</strong>
                        <span id="startTime">No iniciado</span>
                    </div>
                    <div class="timeline-item">
                        <strong>Fin de Clase</strong>
                        <span id="endTime">No finalizado</span>
                    </div>
                    <div class="timeline-item">
                        <strong>Duraci√≥n</strong>
                        <span id="classDuration">--:--</span>
                    </div>
                </div>
                <button class="btn btn-success" onclick="startClass()"><i class="fas fa-play"></i> Iniciar Clase</button>
                <button class="btn btn-danger" onclick="endClass()"><i class="fas fa-stop"></i> Finalizar Clase</button>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-calendar-check"></i> Situaciones del Aula</h2>
                <div class="form-group">
                    <label for="classEvents">Descripci√≥n del evento:</label>
                    <textarea id="classEvents" placeholder="Describe el evento ocurrido en clase..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="addEvent()"><i class="fas fa-plus"></i> Agregar Evento</button>
                
                <h3 style="margin-top: 20px;">Eventos Registrados</h3>
                <ul class="event-list" id="eventsList"></ul>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-analytics"></i> Interpretaci√≥n de lo Observado</h2>
                <div class="form-group">
                    <textarea id="interpretation" placeholder="Escribe tu interpretaci√≥n de lo observado..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="addInterpretation()"><i class="fas fa-plus"></i> Agregar Interpretaci√≥n</button>
                
                <h3 style="margin-top: 20px;">Interpretaciones Registradas</h3>
                <ul class="interpretation-list" id="interpretationsList"></ul>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> Registro de Conductas y Observaciones</h2>
                
                <div class="form-group">
                    <label for="studentNameInput">Nombre del Estudiante:</label>
                    <input type="text" id="studentNameInput" placeholder="Escribe el nombre del estudiante">
                </div>
                
                <div class="form-group">
                    <label>Seleccionar Emoji:</label>
                    <div class="emoji-selector">
                        <button class="emoji-btn" onclick="addParticipation('üëç', 'positiva')">üëç<span class="emoji-tooltip">Positiva</span></button>
                        <button class="emoji-btn" onclick="addParticipation('üëé', 'negativa')">üëé<span class="emoji-tooltip">Negativa</span></button>
                        <button class="emoji-btn" onclick="addParticipation('üëè', 'participaci√≥n')">üëè<span class="emoji-tooltip">Participaci√≥n</span></button>
                        <button class="emoji-btn" onclick="addParticipation('üòä', 'buena conducta')">üòä<span class="emoji-tooltip">Buena conducta</span></button>
                        <button class="emoji-btn" onclick="addParticipation('üòû', 'mala conducta')">üòû<span class="emoji-tooltip">Mala conducta</span></button>
                        <button class="emoji-btn" onclick="addParticipation('‚ù§Ô∏è', 'ayuda a otros')">‚ù§Ô∏è<span class="emoji-tooltip">Ayuda a otros</span></button>
                        <button class="emoji-btn" onclick="addParticipation('üí°', 'buena idea')">üí°<span class="emoji-tooltip">Buena idea</span></button>
                        <button class="emoji-btn" onclick="addParticipation('‚ö†Ô∏è', 'llamar la atenci√≥n')">‚ö†Ô∏è<span class="emoji-tooltip">Llamar atenci√≥n</span></button>
                        <button class="emoji-btn" onclick="addParticipation('üöÄ', 'excelente trabajo')">üöÄ<span class="emoji-tooltip">Excelente trabajo</span></button>
                        <button class="emoji-btn" onclick="addParticipation('‚≠ê', 'destacado')">‚≠ê<span class="emoji-tooltip">Destacado</span></button>
                        <button class="emoji-btn" onclick="addParticipation('üôå', 'colaboraci√≥n')">üôå<span class="emoji-tooltip">Colaboraci√≥n</span></button>
                        <button class="emoji-btn" onclick="addParticipation('üí™', 'esfuerzo')">üí™<span class="emoji-tooltip">Esfuerzo</span></button>
                        <button class="emoji-btn" onclick="addParticipation('üéØ', 'objetivo cumplido')">üéØ<span class="emoji-tooltip">Objetivo cumplido</span></button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="participationComment">Comentario (opcional):</label>
                    <textarea id="participationComment" placeholder="Agrega un comentario sobre la participaci√≥n/conducta..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="registerParticipation()"><i class="fas fa-plus"></i> Registrar Participaci√≥n</button>
                
                <h3 style="margin-top: 20px;">Historial de Participaci√≥n</h3>
                <div style="overflow-x: auto;">
                    <table class="participation-table">
                        <thead>
                            <tr>
                                <th>Estudiante</th>
                                <th>Emoji</th>
                                <th>Comentario</th>
                                <th>Hora</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="participationList">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 2: Reportes -->
        <div id="reports" class="tab-content">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-file-pdf"></i> Generar Reportes</h2>
                <button class="btn btn-primary" onclick="generateReport()"><i class="fas fa-file-alt"></i> Generar Reporte</button>
                <button class="btn btn-success" onclick="downloadPDF()"><i class="fas fa-download"></i> Descargar PDF</button>
            </div>

            <div class="report-preview" id="reportPreview">
                <p style="text-align: center; color: #999;">Presiona "Generar Reporte" para ver la vista previa</p>
            </div>
        </div>

        <!-- TAB 3: Evidencias -->
        <div id="evidence" class="tab-content">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-camera"></i> Capturar Evidencias</h2>
                <button class="btn btn-primary" onclick="openCamera()"><i class="fas fa-camera"></i> Tomar Foto</button>
                <button class="btn btn-primary" onclick="document.getElementById('uploadFileInput').click()"><i class="fas fa-upload"></i> Subir Archivo</button>
                <input type="file" id="uploadFileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
                
                <div class="evidence-container">
                    <h3>Evidencias Capturadas</h3>
                    <div id="evidenceList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para la c√°mara -->
    <div id="cameraModal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-camera"></i> Capturar Evidencia</h2>
            <video id="video" class="camera-feed" autoplay></video>
            <canvas id="canvas" style="display: none;"></canvas>
            
            <div>
                <button class="btn btn-success" onclick="capturePhoto()"><i class="fas fa-camera"></i> Capturar Foto</button>
                <button class="btn btn-danger" onclick="closeCamera()"><i class="fas fa-times"></i> Cerrar</button>
            </div>
            
            <img id="photoPreview" class="photo-preview" style="display: none;">
            
            <div id="captureActions" style="display: none; margin-top: 1rem;">
                <button class="btn btn-primary" onclick="savePhoto()"><i class="fas fa-save"></i> Guardar Evidencia</button>
                <button class="btn" onclick="retakePhoto()"><i class="fas fa-redo"></i> Volver a Capturar</button>
            </div>
        </div>
    </div>

    <!-- Footer navigation -->
    <div class="footer-nav">
        <button onclick="switchTab('class-register')" class="footer-nav-btn">
            <i class="fas fa-chalkboard-teacher"></i>
            <span>Registro</span>
        </button>
        <button onclick="switchTab('reports')" class="footer-nav-btn">
            <i class="fas fa-file-pdf"></i>
            <span>Reportes</span>
        </button>
        <button onclick="switchTab('evidence')" class="footer-nav-btn">
            <i class="fas fa-camera"></i>
            <span>Evidencias</span>
        </button>
    </div>
</div>

<script>
    // ============ FIREBASE INITIALIZATION ============
    const firebaseConfig = {
        apiKey: "AIzaSyCY14LkfciAkiQK8tqFedBR1oNsSJYy_NM",
        authDomain: "registro-anecdotico-4e9f9.firebaseapp.com",
        projectId: "registro-anecdotico-4e9f9",
        storageBucket: "registro-anecdotico-4e9f9.firebasestorage.app",
        messagingSenderId: "452165916569",
        appId: "1:452165916569:web:38eba932b3a9b13cdd6508"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    console.log("üî• Firebase conectado en modo COMPAT");

    // ============ VARIABLES GLOBALES ============
    let currentUser = null;
    let events = [];
    let interpretations = [];
    let participationRecords = [];
    let capturedEvidence = [];
    let stream = null;
    let startTime = null;
    let endTime = null;
    let classDurationInterval = null;

    // ============ FUNCIONES DE AUTENTICACI√ìN ============
    window.validarLogin = async function() {
        const email = document.getElementById('usuario').value;
        const password = document.getElementById('password').value;
        const errorMsg = document.getElementById('error-msg');
        const successMsg = document.getElementById('success-msg');

        errorMsg.style.display = 'none';
        successMsg.style.display = 'none';

        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            currentUser = userCredential.user;
            
            console.log("‚úÖ Usuario autenticado:", currentUser.email);
            successMsg.style.display = "block";

            setTimeout(() => {
                document.getElementById("login-page").style.display = "none";
                document.getElementById("main-page").style.display = "block";
                loadUserData();
            }, 1500);

        } catch (error) {
            errorMsg.textContent = `‚ùå Error: ${error.message}`;
            errorMsg.style.display = "block";
            console.error("Error de autenticaci√≥n:", error);
        }
    };

    document.getElementById('logout-btn').addEventListener('click', async function() {
        try {
            await auth.signOut();
            console.log("‚úÖ Sesi√≥n cerrada");
            document.getElementById("main-page").style.display = "none";
            document.getElementById("login-page").style.display = "block";
            document.getElementById('usuario').value = '';
            document.getElementById('password').value = '';
            currentUser = null;
        } catch (error) {
            console.error("Error al cerrar sesi√≥n:", error);
        }
    });

    // ============ CARGAR DATOS DEL USUARIO ============
    async function loadUserData() {
        try {
            const docSnap = await db.collection("registros").doc(currentUser.uid).get();
            if (docSnap.exists) {
                const data = docSnap.data();
                document.getElementById('schoolName').value = data.schoolName || '';
                document.getElementById('grade').value = data.grade || '';
                document.getElementById('subject').value = data.subject || '';
                events = data.events || [];
                interpretations = data.interpretations || [];
                participationRecords = data.participation || [];
                capturedEvidence = data.evidence || [];
                
                updateEventsList();
                updateInterpretationsList();
                updateParticipationList();
                updateEvidenceList();
            }
            console.log("‚úÖ Datos cargados desde Firebase");
        } catch (error) {
            console.error("Error al cargar datos:", error);
        }
    }

    // ============ GUARDAR DATOS EN FIREBASE ============
    async function saveToFirebase() {
        if (!currentUser) return;

        try {
            await db.collection("registros").doc(currentUser.uid).set({
                schoolName: document.getElementById('schoolName').value,
                grade: document.getElementById('grade').value,
                subject: document.getElementById('subject').value,
                events: events,
                interpretations: interpretations,
                participation: participationRecords,
                evidence: capturedEvidence,
                lastUpdated: new Date().toISOString()
            }, { merge: true });

            console.log("‚úÖ Datos guardados en Firebase");
        } catch (error) {
            console.error("Error al guardar:", error);
        }
    }

    // ============ FUNCIONES DE CLASE ============
    function startClass() {
        startTime = new Date();
        document.getElementById("startTime").textContent = formatDateTime(startTime);
        
        if (classDurationInterval) clearInterval(classDurationInterval);
        classDurationInterval = setInterval(updateClassDuration, 1000);
        
        showNotification("Clase iniciada", "success");
    }

    function endClass() {
        endTime = new Date();
        document.getElementById("endTime").textContent = formatDateTime(endTime);
        
        if (classDurationInterval) clearInterval(classDurationInterval);
        updateClassDuration();
        
        showNotification("Clase finalizada", "success");
    }

    function updateClassDuration() {
        if (!startTime) return;
        
        const now = endTime || new Date();
        const duration = Math.floor((now - startTime) / 1000);
        const hours = Math.floor(duration / 3600);
        const minutes = Math.floor((duration % 3600) / 60);
        const seconds = duration % 60;
        
        document.getElementById("classDuration").textContent = 
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // ============ FUNCIONES DE EVENTOS ============
    function addEvent() {
        const eventText = document.getElementById("classEvents").value;
        if (!eventText.trim()) {
            showNotification("Escribe un evento", "error");
            return;
        }
        
        events.push({
            text: eventText,
            time: new Date(),
            formattedTime: formatDateTime(new Date())
        });
        
        updateEventsList();
        document.getElementById("classEvents").value = "";
        saveToFirebase();
        showNotification("Evento agregado", "success");
    }

    function updateEventsList() {
        const eventsList = document.getElementById("eventsList");
        eventsList.innerHTML = "";
        
        events.forEach((event, index) => {
            const li = document.createElement("li");
            li.className = "event-item";
            li.innerHTML = `
                <strong>Evento ${index + 1}:</strong> ${event.text}
                <div class="event-time">${event.formattedTime}</div>
                <button class="btn btn-sm btn-danger" onclick="deleteEvent(${index})"><i class="fas fa-trash"></i></button>
            `;
            eventsList.appendChild(li);
        });
    }

    function deleteEvent(index) {
        events.splice(index, 1);
        updateEventsList();
        saveToFirebase();
    }

    // ============ FUNCIONES DE INTERPRETACIONES ============
    function addInterpretation() {
        const interpretationText = document.getElementById("interpretation").value;
        if (!interpretationText.trim()) {
            showNotification("Escribe una interpretaci√≥n", "error");
            return;
        }
        
        interpretations.push({
            text: interpretationText,
            time: new Date(),
            formattedTime: formatDateTime(new Date())
        });
        
        updateInterpretationsList();
        document.getElementById("interpretation").value = "";
        saveToFirebase();
        showNotification("Interpretaci√≥n agregada", "success");
    }

    function updateInterpretationsList() {
        const interpretationsList = document.getElementById("interpretationsList");
        interpretationsList.innerHTML = "";
        
        interpretations.forEach((interpretation, index) => {
            const li = document.createElement("li");
            li.className = "interpretation-item";
            li.innerHTML = `
                <strong>Interpretaci√≥n ${index + 1}:</strong> ${interpretation.text}
                <div class="interpretation-time">${interpretation.formattedTime}</div>
                <button class="btn btn-sm btn-danger" onclick="deleteInterpretation(${index})"><i class="fas fa-trash"></i></button>
            `;
            interpretationsList.appendChild(li);
        });
    }

    function deleteInterpretation(index) {
        interpretations.splice(index, 1);
        updateInterpretationsList();
        saveToFirebase();
    }

    // ============ FUNCIONES DE PARTICIPACI√ìN ============
    function addParticipation(emoji, type) {
        document.getElementById("participationComment").value += ` ${emoji}`;
    }

    function registerParticipation() {
        const studentName = document.getElementById("studentNameInput").value;
        const comment = document.getElementById("participationComment").value;
        
        if (!studentName.trim()) {
            showNotification("Escribe el nombre del estudiante", "error");
            return;
        }
        
        participationRecords.push({
            studentName,
            comment,
            time: new Date(),
            formattedTime: formatDateTime(new Date())
        });
        
        updateParticipationList();
        document.getElementById("studentNameInput").value = "";
        document.getElementById("participationComment").value = "";
        saveToFirebase();
        showNotification("Participaci√≥n registrada", "success");
    }

    function updateParticipationList() {
        const participationList = document.getElementById("participationList");
        participationList.innerHTML = "";
        
        participationRecords.forEach((record, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${record.studentName}</td>
                <td>${record.comment}</td>
                <td>${record.comment}</td>
                <td>${record.formattedTime}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteParticipation(${index})"><i class="fas fa-trash"></i></button>
                </td>
            `;
            participationList.appendChild(row);
        });
    }

    function deleteParticipation(index) {
        participationRecords.splice(index, 1);
        updateParticipationList();
        saveToFirebase();
    }

    // ============ FUNCIONES DE C√ÅMARA ============
    function openCamera() {
        const modal = document.getElementById("cameraModal");
        modal.style.display = "flex";
        
        const video = document.getElementById("video");
        
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(mediaStream) {
                    video.srcObject = mediaStream;
                    stream = mediaStream;
                })
                .catch(function(error) {
                    showNotification("Error al acceder a la c√°mara", "error");
                });
        }
    }

    function closeCamera() {
        const modal = document.getElementById("cameraModal");
        modal.style.display = "none";
        
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        
        document.getElementById("photoPreview").style.display = "none";
        document.getElementById("captureActions").style.display = "none";
        document.getElementById("video").style.display = "block";
    }

    function capturePhoto() {
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext('2d');
        const photoPreview = document.getElementById("photoPreview");
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        photoPreview.src = canvas.toDataURL('image/png');
        photoPreview.style.display = "block";
        
        video.style.display = "none";
        document.getElementById("captureActions").style.display = "block";
    }

    function retakePhoto() {
        const video = document.getElementById("video");
        video.style.display = "block";
        document.getElementById("photoPreview").style.display = "none";
        document.getElementById("captureActions").style.display = "none";
    }

    function savePhoto() {
        const canvas = document.getElementById("canvas");
        const imageData = canvas.toDataURL('image/png');
        
        capturedEvidence.push({
            type: "image",
            data: imageData,
            timestamp: new Date(),
            formattedTime: formatDateTime(new Date())
        });
        
        updateEvidenceList();
        closeCamera();
        saveToFirebase();
        showNotification("Foto guardada", "success");
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                capturedEvidence.push({
                    type: "file",
                    data: e.target.result,
                    filename: file.name,
                    timestamp: new Date(),
                    formattedTime: formatDateTime(new Date())
                });
                
                updateEvidenceList();
                saveToFirebase();
                showNotification("Archivo subido", "success");
            };
            reader.readAsDataURL(file);
        }
    }

    function updateEvidenceList() {
        const evidenceList = document.getElementById("evidenceList");
        evidenceList.innerHTML = "";
        
        if (capturedEvidence.length === 0) {
            evidenceList.innerHTML = "<p>No hay evidencias</p>";
            return;
        }
        
        capturedEvidence.forEach((evidence, index) => {
            const item = document.createElement("div");
            item.style.border = "1px solid #ddd";
            item.style.borderRadius = "8px";
            item.style.padding = "1rem";
            
            if (evidence.type === "image") {
                item.innerHTML = `
                    <img src="${evidence.data}" class="evidence-image" alt="Evidencia ${index + 1}">
                    <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">${evidence.formattedTime}</p>
                    <button class="btn btn-sm btn-danger" onclick="deleteEvidence(${index})"><i class="fas fa-trash"></i></button>
                `;
            } else {
                item.innerHTML = `
                    <p><strong>${evidence.filename}</strong></p>
                    <p style="font-size: 0.9rem; color: #666;">${evidence.formattedTime}</p>
                    <button class="btn btn-sm btn-danger" onclick="deleteEvidence(${index})"><i class="fas fa-trash"></i></button>
                `;
            }
            
            evidenceList.appendChild(item);
        });
    }

    function deleteEvidence(index) {
        capturedEvidence.splice(index, 1);
        updateEvidenceList();
        saveToFirebase();
    }

    // ============ FUNCIONES DE REPORTES ============
    function generateReport() {
        const teacherName = document.getElementById("teacherName").value;
        const grade = document.getElementById("grade").value;
        const subject = document.getElementById("subject").value;
        const schoolName = document.getElementById("schoolName").value;
        const date = formatDate(new Date());
        
        let content = `
            <div class="report-header">
                <h2>REGISTRO ANECD√ìTICO DE ${grade}</h2>
                <p><strong>Centro Educativo:</strong> ${schoolName}</p>
                <p><strong>Profesor:</strong> ${teacherName}</p>
                <p><strong>Materia:</strong> ${subject}</p>
                <p><strong>Fecha:</strong> ${date}</p>
                <p><strong>Duraci√≥n:</strong> ${document.getElementById("classDuration").textContent}</p>
            </div>
        `;
        
        if (events.length > 0) {
            content += `
                <div class="report-section">
                    <h3>Situaciones Ocurridas en el Aula</h3>
                    <ul>
            `;
            events.forEach((event, index) => {
                content += `<li><strong>Evento ${index + 1}:</strong> ${event.text} <small>(${event.formattedTime})</small></li>`;
            });
            content += `</ul></div>`;
        }
        
        if (interpretations.length > 0) {
            content += `
                <div class="report-section">
                    <h3>Interpretaci√≥n de lo Observado</h3>
                    <ul>
            `;
            interpretations.forEach((interpretation, index) => {
                content += `<li><strong>Interpretaci√≥n ${index + 1}:</strong> ${interpretation.text} <small>(${interpretation.formattedTime})</small></li>`;
            });
            content += `</ul></div>`;
        }
        
        if (participationRecords.length > 0) {
            content += `
                <div class="report-section">
                    <h3>Registro de Participaci√≥n y Conducta</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="background-color: #2c3e50; color: white;">
                            <th style="padding: 10px; text-align: left;">Estudiante</th>
                            <th style="padding: 10px; text-align: left;">Comentario</th>
                            <th style="padding: 10px; text-align: left;">Hora</th>
                        </tr>
            `;
            participationRecords.forEach((record, index) => {
                content += `
                    <tr style="${index % 2 === 0 ? 'background-color: #f2f2f2;' : ''}">
                        <td style="padding: 10px; border: 1px solid #ddd;">${record.studentName}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${record.comment}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${record.formattedTime}</td>
                    </tr>
                `;
            });
            content += `</table></div>`;
        }
        
        document.getElementById("reportPreview").innerHTML = content;
    }

    async function downloadPDF() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const grade = document.getElementById("grade").value || "Grado";
            const today = new Date();
            const dateString = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;
            
            const element = document.getElementById('reportPreview');
            const canvas = await html2canvas(element, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 190;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
            doc.save(`${grade} - ${dateString}.pdf`);
            
            showNotification("PDF descargado", "success");
        } catch (error) {
            showNotification("Error al generar PDF", "error");
        }
    }

    // ============ FUNCIONES DE UTILIDAD ============
    function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    function formatDateTime(date) {
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    function formatDate(date) {
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    function showNotification(message, type) {
        const toast = document.createElement("div");
        toast.style.position = "fixed";
        toast.style.bottom = "100px";
        toast.style.left = "50%";
        toast.style.transform = "translateX(-50%)";
        toast.style.padding = "15px 20px";
        toast.style.borderRadius = "5px";
        toast.style.color = "white";
        toast.style.zIndex = "1000";
        toast.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)";
        toast.style.backgroundColor = type === "success" ? "#2ecc71" : type === "error" ? "#e74c3c" : "#3498db";
        
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = "0";
            toast.style.transition = "opacity 0.5s";
            setTimeout(() => document.body.removeChild(toast), 500);
        }, 3000);
    }

    // Monitor de autenticaci√≥n
    auth.onAuthStateChanged((user) => {
        if (user) {
            console.log("‚úÖ Usuario detectado:", user.email);
            currentUser = user;
            loadUserData();
        } else {
            console.log("‚ùå Sin usuario autenticado");
            currentUser = null;
        }
    });
</script>

</body>
</html>
