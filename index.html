// ============ CONFIGURACIÓN DE FIREBASE Y FUNCIONES ACTUALIZADAS ============

// Variables globales
const usuarios = {}; // Será llenado desde Firestore
let usuarioParaReactivar = null;
let usuarioParaEditar = null;
let failedAttempts = 0;
let isBlocked = false;
let blockUntil = 0;
let currentSessionId = generateSessionId();
let usuarioAutenticado = null;
let firebaseReady = false;

// Generar ID de sesión único
function generateSessionId() {
    return Math.random().toString(36).substring(2) + Date.now().toString(36);
}

// ============ VERIFICAR FIREBASE CARGADO ============
function waitForFirebase() {
    return new Promise((resolve) => {
        if (typeof firebase !== 'undefined' && firebase.firestore) {
            firebaseReady = true;
            resolve();
            return;
        }
        
        let attempts = 0;
        const checkFirebase = setInterval(() => {
            attempts++;
            if (typeof firebase !== 'undefined' && firebase.firestore) {
                clearInterval(checkFirebase);
                firebaseReady = true;
                resolve();
            } else if (attempts > 50) {
                clearInterval(checkFirebase);
                console.error('❌ Firebase no se cargó correctamente');
                showAlert('Error: Firebase no se inicializó. Recarga la página.', 'error');
                resolve();
            }
        }, 100);
    });
}

// ============ FIREBASE FIRESTORE FUNCTIONS ============

const getDb = () => {
    if (!firebase || !firebase.firestore) {
        console.error('Firebase no está disponible');
        return null;
    }
    return firebase.firestore();
};

// Cargar todos los usuarios desde Firestore
async function loadUsers() {
    try {
        // Esperar a que Firebase esté listo
        await waitForFirebase();
        
        const db = getDb();
        if (!db) {
            console.error('❌ No se pudo acceder a Firestore');
            showAlert('Error conectando con la base de datos', 'error');
            return;
        }

        const snapshot = await db.collection("usuarios").get();
        
        for (const doc of snapshot.docs) {
            const userData = doc.data();
            usuarios[doc.id] = {
                password: userData.password,
                expiryDate: userData.expiryDate || null,
                isDefault: userData.isDefault || false,
                avatar: userData.avatar || null,
                role: userData.role || "Usuario del sistema",
                phone: userData.phone || "",
                sessionId: null,
                email: userData.email || "",
                activo: userData.activo !== false
            };
        }

        console.log("✅ Usuarios cargados desde Firestore:", Object.keys(usuarios));

        // Cargar tema
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            const themeBtn = document.getElementById('theme-switch');
            if (themeBtn) themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
        }

        // Verificar bloqueo
        const blockTime = localStorage.getItem('blockUntil');
        if (blockTime && parseInt(blockTime) > Date.now()) {
            isBlocked = true;
            blockUntil = parseInt(blockTime);
            updateBlockedMessage();
        }

        updateUserDropdown();
        
        // Mostrar formulario de login
        const loginPage = document.getElementById('login-page');
        if (loginPage) loginPage.style.display = 'block';

    } catch (error) {
        console.error("❌ Error cargando usuarios:", error);
        showAlert('Error cargando usuarios de la base de datos: ' + error.message, 'error');
    }
}

// Guardar usuario en Firestore
async function saveUserToFirestore(userId, userData) {
    try {
        const db = getDb();
        if (!db) return;
        
        await db.collection("usuarios").doc(userId).set(userData, { merge: true });
        console.log("✅ Usuario guardado en Firestore:", userId);
    } catch (error) {
        console.error("❌ Error guardando usuario:", error);
        showAlert('Error al guardar el usuario', 'error');
    }
}

// Actualizar usuario en Firestore
async function updateUserInFirestore(userId, updates) {
    try {
        const db = getDb();
        if (!db) return;
        
        await db.collection("usuarios").doc(userId).update(updates);
        console.log("✅ Usuario actualizado en Firestore:", userId);
    } catch (error) {
        console.error("❌ Error actualizando usuario:", error);
        showAlert('Error al actualizar el usuario', 'error');
    }
}

// Eliminar usuario de Firestore
async function deleteUserFromFirestore(userId) {
    try {
        const db = getDb();
        if (!db) return;
        
        await db.collection("usuarios").doc(userId).delete();
        console.log("✅ Usuario eliminado de Firestore:", userId);
    } catch (error) {
        console.error("❌ Error eliminando usuario:", error);
        showAlert('Error al eliminar el usuario', 'error');
    }
}

// ============ FUNCIONES DE AUTENTICACIÓN ============

// Función para encriptar contraseñas usando SHA-256
async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
}

// Mostrar alerta personalizada
function showAlert(message, type = "success") {
    const alert = document.getElementById("custom-alert");
    const alertMessage = document.getElementById("alert-message");
    
    if (!alert || !alertMessage) {
        console.error('Elementos de alerta no encontrados en el DOM');
        return;
    }
    
    alert.className = "custom-alert " + type;
    alertMessage.textContent = message;
    alert.classList.add("show");
    
    setTimeout(() => {
        alert.classList.remove("show");
    }, 3000);
}

// Actualizar el dropdown de usuarios
function updateUserDropdown() {
    const userSelect = document.getElementById('usuario');
    if (!userSelect) {
        console.error('Elemento de selección de usuario no encontrado');
        return;
    }
    
    const currentValue = userSelect.value;
    
    // Limpiar opciones excepto la primera
    while (userSelect.options.length > 1) {
        userSelect.remove(1);
    }
    
    // Agregar usuarios registrados
    for (const user in usuarios) {
        const option = document.createElement('option');
        option.value = user;
        option.textContent = user;
        userSelect.appendChild(option);
    }
    
    // Restaurar selección previa
    if (currentValue && usuarios[currentValue]) {
        userSelect.value = currentValue;
    }
    updateProfile();
}

// Actualizar perfil según selección
function updateProfile() {
    const userSelect = document.getElementById('usuario');
    const avatar = document.getElementById('user-avatar');
    const profileName = document.getElementById('profile-name');
    const profileRole = document.getElementById('profile-role');
    const profileContact = document.getElementById('profile-contact');
    
    if (!userSelect || !avatar || !profileName || !profileRole || !profileContact) {
        console.error('Elementos de perfil no encontrados en el DOM');
        return;
    }
    
    const selectedUser = userSelect.value;
    
    if (selectedUser && usuarios[selectedUser]) {
        const userData = usuarios[selectedUser];
        
        if (userData.avatar) {
            avatar.innerHTML = `<img src="${userData.avatar}" alt="${selectedUser}">`;
        } else {
            avatar.textContent = getInitials(selectedUser);
        }
        
        profileName.textContent = selectedUser;
        profileRole.textContent = userData.role || "Usuario del sistema";
        profileContact.textContent = userData.phone ? `Tel: ${userData.phone}` : "";
    }
}

// Obtener iniciales de un nombre
function getInitials(name) {
    if (!name) return "MS";
    const names = name.split(' ');
    let initials = "";
    
    if (names.length === 1) {
        initials = names[0].charAt(0);
    } else {
        initials = names[0].charAt(0) + names[names.length - 1].charAt(0);
    }
    
    return initials.toUpperCase();
}

// Normalizar nombre de usuario
function normalizeUsername(username) {
    return username.toLowerCase().trim();
}

// Buscar usuario normalizado
function findUser(username) {
    const normalizedUsername = normalizeUsername(username);
    for (const user in usuarios) {
        if (normalizeUsername(user) === normalizedUsername) {
            return user;
        }
    }
    return null;
}

// Verificar si un usuario ha expirado
function isUserExpired(userData) {
    if (!userData.expiryDate) return false;
    const today = new Date();
    const expiryDate = new Date(userData.expiryDate);
    return today > expiryDate;
}

// Obtener información de expiración
function getExpiryInfo(userData) {
    if (!userData.expiryDate) return "Sin fecha de expiración";
    
    const today = new Date();
    const expiryDate = new Date(userData.expiryDate);
    const diffTime = expiryDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 0) {
        return `<span class="expired">Expirado el ${formatDate(userData.expiryDate)}</span>`;
    } else if (diffDays < 7) {
        return `<span class="expiring-soon">Expira en ${diffDays} días (${formatDate(userData.expiryDate)})</span>`;
    } else {
        return `Expira el ${formatDate(userData.expiryDate)}`;
    }
}

// Formatear fecha
function formatDate(dateString) {
    if (!dateString) return "";
    const date = new Date(dateString);
    return date.toLocaleDateString('es-ES');
}

// Cambiar entre tema claro y oscuro
function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    if (document.body.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark');
        document.getElementById('theme-switch').innerHTML = '<i class="fas fa-sun"></i>';
    } else {
        localStorage.setItem('theme', 'light');
        document.getElementById('theme-switch').innerHTML = '<i class="fas fa-moon"></i>';
    }
}

// Mostrar/ocultar contraseña
function togglePassword(inputId, toggleId) {
    const passwordInput = document.getElementById(inputId);
    const toggleIcon = document.getElementById(toggleId).querySelector('i');
    
    if (!passwordInput || !toggleIcon) return;
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.classList.remove('fa-eye');
        toggleIcon.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        toggleIcon.classList.remove('fa-eye-slash');
        toggleIcon.classList.add('fa-eye');
    }
}

// Recuperar contraseña
function forgotPassword() {
    const username = document.getElementById('usuario').value;
    
    if (!username) {
        showAlert('Por favor, selecciona un usuario primero', 'error');
        return;
    }
    
    const foundUser = findUser(username);
    if (!foundUser) {
        showAlert('Usuario no encontrado', 'error');
        return;
    }
    
    showAlert(`Para recuperar tu contraseña, contacta a Miguel Silverio por WhatsApp al 829-801-8462 indicando tu usuario: ${foundUser}. Recibirás respuesta en un plazo de 12 horas.`, 'info');
}

// Actualizar mensaje de bloqueo
function updateBlockedMessage() {
    if (!isBlocked) return;
    
    const blockedMsgElement = document.getElementById('blocked-msg');
    const blockedTextElement = document.getElementById('blocked-text');
    
    if (!blockedMsgElement || !blockedTextElement) return;
    
    const now = Date.now();
    if (now >= blockUntil) {
        isBlocked = false;
        localStorage.removeItem('blockUntil');
        blockedMsgElement.style.display = 'none';
        return;
    }
    
    const remainingSeconds = Math.ceil((blockUntil - now) / 1000);
    blockedTextElement.textContent = `Demasiados intentos fallidos. Intenta nuevamente en ${remainingSeconds} segundos.`;
    blockedMsgElement.style.display = 'block';
    
    setTimeout(updateBlockedMessage, 1000);
}

// Bloquear acceso temporalmente
function blockAccess() {
    isBlocked = true;
    blockUntil = Date.now() + 45000;
    localStorage.setItem('blockUntil', blockUntil.toString());
    updateBlockedMessage();
}

// ============ FUNCIONES DE ADMINISTRACIÓN ============

function showAdminAuth() {
    if (isBlocked) {
        showAlert('El sistema está bloqueado temporalmente por demasiados intentos fallidos.', 'error');
        return;
    }
    
    const adminAuth = document.getElementById('admin-auth');
    const loginForm = document.getElementById('login-form');
    
    if (adminAuth && loginForm) {
        adminAuth.style.display = 'block';
        loginForm.style.display = 'none';
    }
    
    const adminUsername = document.getElementById('admin-username');
    const adminPassword = document.getElementById('admin-password');
    const adminErrorMsg = document.getElementById('admin-error-msg');
    
    if (adminUsername) adminUsername.value = '';
    if (adminPassword) adminPassword.value = '';
    if (adminErrorMsg) adminErrorMsg.style.display = 'none';
}

function hideAdminAuth() {
    const adminAuth = document.getElementById('admin-auth');
    const loginForm = document.getElementById('login-form');
    
    if (adminAuth && loginForm) {
        adminAuth.style.display = 'none';
        loginForm.style.display = 'block';
    }
}

function showAdminPanel() {
    const adminPanel = document.getElementById('admin-panel');
    const adminAuth = document.getElementById('admin-auth');
    
    if (adminPanel && adminAuth) {
        adminPanel.style.display = 'block';
        adminAuth.style.display = 'none';
    }
    
    // Limpiar campos
    const elements = [
        'register-error-msg', 'register-success-msg', 'new-username',
        'new-password', 'confirm-password', 'user-role', 'user-phone',
        'expiry-date', 'avatar-upload'
    ];
    
    elements.forEach(id => {
        const elem = document.getElementById(id);
        if (elem) {
            if (elem.type === 'text' || elem.type === 'password' || elem.type === 'date' || elem.type === 'file') {
                elem.value = '';
            } else if (elem.id.includes('msg')) {
                elem.style.display = 'none';
            }
        }
    });
    
    loadUserList();
}

function hideAdminPanel() {
    const adminPanel = document.getElementById('admin-panel');
    const loginForm = document.getElementById('login-form');
    
    if (adminPanel && loginForm) {
        adminPanel.style.display = 'none';
        loginForm.style.display = 'block';
    }
    
    hideReactivateForm();
    hideEditForm();
}

function switchAdminTab(tabName) {
    const createTab = document.getElementById('tab-create');
    const deleteTab = document.getElementById('tab-delete');
    const createForm = document.getElementById('create-user-form');
    const deleteForm = document.getElementById('delete-user-form');
    
    if (!createTab || !deleteTab || !createForm || !deleteForm) {
        console.error('Elementos de tab no encontrados');
        return;
    }
    
    if (tabName === 'create') {
        createTab.classList.add('active');
        deleteTab.classList.remove('active');
        createForm.style.display = 'block';
        deleteForm.style.display = 'none';
        hideReactivateForm();
        hideEditForm();
    } else {
        createTab.classList.remove('active');
        deleteTab.classList.add('active');
        createForm.style.display = 'none';
        deleteForm.style.display = 'block';
        loadUserList();
    }
}

function loadUserList() {
    const userList = document.getElementById('user-list');
    if (!userList) {
        console.error('user-list no encontrado');
        return;
    }
    
    userList.innerHTML = '';
    
    for (const user in usuarios) {
        const userData = usuarios[user];
        const userItem = document.createElement('div');
        userItem.className = 'user-item';
        
        const userInfo = document.createElement('div');
        userInfo.className = 'user-info';
        
        const userIcon = document.createElement('div');
        userIcon.className = 'user-icon';
        
        if (userData.avatar) {
            userIcon.style.backgroundImage = `url(${userData.avatar})`;
            userIcon.style.backgroundSize = 'cover';
            userIcon.innerHTML = '';
        } else {
            userIcon.textContent = getInitials(user).substring(0, 2);
        }
        
        const userDetails = document.createElement('div');
        userDetails.className = 'user-details';
        
        const userName = document.createElement('div');
        userName.innerHTML = `<strong>${user}</strong> - ${userData.role || "Usuario"}`;
        
        const expiryInfo = document.createElement('div');
        expiryInfo.className = 'expiry-info';
        expiryInfo.innerHTML = getExpiryInfo(userData);
        
        userDetails.appendChild(userName);
        userDetails.appendChild(expiryInfo);
        
        userInfo.appendChild(userIcon);
        userInfo.appendChild(userDetails);
        
        userItem.appendChild(userInfo);
        
        const userActions = document.createElement('div');
        userActions.className = 'user-actions';
        
        const editBtn = document.createElement('button');
        editBtn.className = 'action-btn edit-btn';
        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
        editBtn.title = 'Editar usuario';
        editBtn.onclick = function() { showEditForm(user); };
        
        userActions.appendChild(editBtn);
        
        if (!userData.isDefault) {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'action-btn delete-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.title = 'Eliminar usuario';
            deleteBtn.onclick = function() { deleteUser(user); };
            
            userActions.appendChild(deleteBtn);
            
            if (isUserExpired(userData)) {
                const reactivateBtn = document.createElement('button');
                reactivateBtn.className = 'action-btn reactivate-btn';
                reactivateBtn.innerHTML = '<i class="fas fa-redo"></i>';
                reactivateBtn.title = 'Reactivar usuario';
                reactivateBtn.onclick = function() { showReactivateForm(user); };
                
                userActions.appendChild(reactivateBtn);
            }
        }
        
        userItem.appendChild(userActions);
        userList.appendChild(userItem);
    }
}

function showReactivateForm(username) {
    usuarioParaReactivar = username;
    const reactivateUsername = document.getElementById('reactivate-username');
    const reactivateForm = document.getElementById('reactivate-form');
    const newExpiryDate = document.getElementById('new-expiry-date');
    
    if (reactivateUsername) reactivateUsername.textContent = username;
    if (reactivateForm) reactivateForm.style.display = 'block';
    if (newExpiryDate) newExpiryDate.value = '';
    
    hideEditForm();
    
    if (reactivateForm) {
        reactivateForm.scrollIntoView({ behavior: 'smooth' });
    }
}

function hideReactivateForm() {
    const reactivateForm = document.getElementById('reactivate-form');
    if (reactivateForm) reactivateForm.style.display = 'none';
    usuarioParaReactivar = null;
}

function showEditForm(username) {
    usuarioParaEditar = username;
    const userData = usuarios[username];
    
    const editUsername = document.getElementById('edit-username');
    const editRole = document.getElementById('edit-role');
    const editPhone = document.getElementById('edit-phone');
    const editExpiryDate = document.getElementById('edit-expiry-date');
    const editForm = document.getElementById('edit-form');
    
    if (editUsername) editUsername.textContent = username;
    if (editRole) editRole.value = userData.role || "";
    if (editPhone) editPhone.value = userData.phone || "";
    if (editExpiryDate) editExpiryDate.value = userData.expiryDate || "";
    if (editForm) editForm.style.display = 'block';
    
    hideReactivateForm();
    
    if (editForm) {
        editForm.scrollIntoView({ behavior: 'smooth' });
    }
}

function hideEditForm() {
    const editForm = document.getElementById('edit-form');
    if (editForm) editForm.style.display = 'none';
    usuarioParaEditar = null;
}

async function reactivateUser() {
    if (!usuarioParaReactivar) return;
    
    const newExpiryDate = document.getElementById('new-expiry-date');
    if (!newExpiryDate || !newExpiryDate.value) {
        showAlert('Por favor, selecciona una nueva fecha de caducidad', 'error');
        return;
    }
    
    usuarios[usuarioParaReactivar].expiryDate = newExpiryDate.value;
    await updateUserInFirestore(usuarioParaReactivar, { expiryDate: newExpiryDate.value });
    
    showAlert(`Usuario "${usuarioParaReactivar}" reactivado correctamente. Nueva fecha de expiración: ${formatDate(newExpiryDate.value)}`, 'success');
    
    loadUserList();
    hideReactivateForm();
}

async function saveUserEdit() {
    if (!usuarioParaEditar) return;
    
    const editRole = document.getElementById('edit-role');
    const editPhone = document.getElementById('edit-phone');
    const editExpiryDate = document.getElementById('edit-expiry-date');
    const editAvatarUpload = document.getElementById('edit-avatar-upload');
    
    if (!editRole || !editRole.value) {
        showAlert('El campo de especialidad/rol es obligatorio', 'error');
        return;
    }
    
    usuarios[usuarioParaEditar].role = editRole.value;
    usuarios[usuarioParaEditar].phone = editPhone ? editPhone.value : '';
    usuarios[usuarioParaEditar].expiryDate = editExpiryDate ? editExpiryDate.value : null;
    
    const newAvatarFile = editAvatarUpload ? editAvatarUpload.files[0] : null;
    
    if (newAvatarFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
            usuarios[usuarioParaEditar].avatar = e.target.result;
            completeUserEdit();
        };
        reader.readAsDataURL(newAvatarFile);
    } else {
        await completeUserEdit();
    }
}

async function completeUserEdit() {
    const updateData = {
        role: usuarios[usuarioParaEditar].role,
        phone: usuarios[usuarioParaEditar].phone,
        expiryDate: usuarios[usuarioParaEditar].expiryDate || null
    };

    if (usuarios[usuarioParaEditar].avatar) {
        updateData.avatar = usuarios[usuarioParaEditar].avatar;
    }

    await updateUserInFirestore(usuarioParaEditar, updateData);
    
    showAlert(`Usuario "${usuarioParaEditar}" actualizado correctamente`, 'success');
    
    loadUserList();
    hideEditForm();
    
    const userSelect = document.getElementById('usuario');
    if (userSelect && userSelect.value === usuarioParaEditar) {
        updateProfile();
    }
}

async function deleteUser(username) {
    if (confirm(`¿Estás seguro de que deseas eliminar al usuario "${username}"?`)) {
        delete usuarios[username];
        await deleteUserFromFirestore(username);
        loadUserList();
        
        showAlert(`Usuario "${username}" eliminado correctamente`, 'success');
    }
}

async function verifyAdmin() {
    const adminUsername = document.getElementById('admin-username');
    const adminPassword = document.getElementById('admin-password');
    const errorMsg = document.getElementById('admin-error-msg');
    
    if (!adminUsername || !adminPassword || !errorMsg) {
        console.error('Elementos de admin no encontrados');
        return;
    }
    
    errorMsg.style.display = 'none';
    
    const foundUser = findUser(adminUsername.value);
    const hashedPassword = await hashPassword(adminPassword.value);
    
    if (foundUser === "Miguel Silverio" && usuarios[foundUser] && usuarios[foundUser].password === hashedPassword) {
        showAdminPanel();
    } else {
        errorMsg.textContent = 'Credenciales de administrador incorrectas';
        errorMsg.style.display = 'block';
        
        const loginContainer = document.querySelector('.login-container');
        if (loginContainer) {
            loginContainer.animate([
                { transform: 'translateX(0)' },
                { transform: 'translateX(-10px)' },
                { transform: 'translateX(10px)' },
                { transform: 'translateX(0)' }
            ], {
                duration: 300,
                iterations: 1
            });
        }
    }
}

window.validarLogin = async function() {
    if (isBlocked) {
        updateBlockedMessage();
        return;
    }

    const emailInput = document.getElementById('usuario');
    const passwordInput = document.getElementById('password');
    const errorMsg = document.getElementById('error-msg');
    const errorText = document.getElementById('error-text');
    const successMsg = document.getElementById('success-msg');

    if (!emailInput || !passwordInput || !errorMsg || !errorText || !successMsg) {
        console.error('Elementos de login no encontrados');
        return;
    }

    const email = emailInput.value;
    const password = passwordInput.value;

    errorMsg.style.display = 'none';
    successMsg.style.display = 'none';
    const blockedMsg = document.getElementById('blocked-msg');
    if (blockedMsg) blockedMsg.style.display = 'none';

    try {
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        const user = userCredential.user;

        const db = getDb();
        if (!db) {
            errorText.textContent = "Error conectando con la base de datos";
            errorMsg.style.display = "block";
            return;
        }

        const docRef = db.collection("usuarios").doc(user.uid);
        const docSnap = await docRef.get();

        if (!docSnap.exists) {
            errorText.textContent = "Usuario no registrado en base de datos";
            errorMsg.style.display = "block";
            return;
        }

        const userData = docSnap.data();

        if (!userData.activo) {
            errorText.textContent = "Usuario desactivado";
            errorMsg.style.display = "block";
            return;
        }

        if (userData.expiryDate) {
            const today = new Date();
            const expiry = new Date(userData.expiryDate);

            if (expiry < today) {
                errorText.textContent = "Usuario expirado";
                errorMsg.style.display = "block";
                return;
            }
        }

        failedAttempts = 0;
        usuarioAutenticado = user.uid;
        successMsg.style.display = "block";

        setTimeout(function() {
            showAlert("Redirigiendo al sistema principal...", "success");
            const mainPage = document.getElementById("main-page");
            const loginPage = document.getElementById("login-page");
            
            if (mainPage && loginPage) {
                mainPage.style.display = "block";
                loginPage.style.display = "none";
            }
        }, 1500);

    } catch (error) {
        failedAttempts++;
        errorText.textContent = "Correo o contraseña incorrectos";
        errorMsg.style.display = "block";

        if (failedAttempts >= 3) {
            blockAccess();
        }
    }
};

async function registerUser() {
    const usernameInput = document.getElementById('new-username');
    const passwordInput = document.getElementById('new-password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const roleInput = document.getElementById('user-role');
    const phoneInput = document.getElementById('user-phone');
    const expiryDateInput = document.getElementById('expiry-date');
    const avatarUploadInput = document.getElementById('avatar-upload');
    
    if (!usernameInput || !passwordInput || !confirmPasswordInput || !roleInput) {
        console.error('Elementos de registro no encontrados');
        return;
    }
    
    const username = usernameInput.value;
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    const role = roleInput.value;
    const phone = phoneInput ? phoneInput.value : '';
    const expiryDate = expiryDateInput ? expiryDateInput.value : '';
    const avatarFile = avatarUploadInput ? avatarUploadInput.files[0] : null;
    
    if (!username || !password || !confirmPassword || !role) {
        showAlert('Todos los campos marcados con * son obligatorios', 'error');
        return;
    }
    
    if (password.length < 4) {
        showAlert('La contraseña debe tener al menos 4 caracteres', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showAlert('Las contraseñas no coinciden', 'error');
        return;
    }
    
    if (findUser(username)) {
        showAlert('El usuario ya existe', 'error');
        return;
    }
    
    let avatarData = null;
    if (avatarFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
            avatarData = e.target.result;
            completeUserRegistration(username, password, role, phone, expiryDate, avatarData);
        };
        reader.readAsDataURL(avatarFile);
    } else {
        await completeUserRegistration(username, password, role, phone, expiryDate, null);
    }
}

async function completeUserRegistration(username, password, role, phone, expiryDate, avatarData) {
    const hashedPassword = await hashPassword(password);
    
    const userData = {
        password: hashedPassword,
        expiryDate: expiryDate || null,
        isDefault: false,
        avatar: avatarData,
        role: role,
        phone: phone,
        email: `${username.toLowerCase().replace(/\s+/g, '.')}@usuarios.local`,
        activo: true,
        createdAt: new Date().toISOString()
    };

    try {
        const db = getDb();
        if (!db) {
            showAlert('Error: No se pudo conectar a la base de datos', 'error');
            return;
        }
        
        await db.collection("usuarios").doc(username).set(userData);
        usuarios[username] = userData;

        showAlert(`Usuario "${username}" registrado correctamente`, 'success');
        
        // Limpiar campos
        const elements = ['new-username', 'new-password', 'confirm-password', 'user-role', 'user-phone', 'expiry-date', 'avatar-upload'];
        elements.forEach(id => {
            const elem = document.getElementById(id);
            if (elem) elem.value = '';
        });
        
        loadUserList();
        switchAdminTab('delete');
    } catch (error) {
        console.error("Error registrando usuario:", error);
        showAlert('Error al registrar el usuario: ' + error.message, 'error');
    }
}

// ============ CONFIGURAR EVENT LISTENERS ============

document.addEventListener('DOMContentLoaded', async function() {
    console.log('✅ DOM Contenido cargado');
    
    // Cargar usuarios al iniciar
    await loadUsers();

    const passwordToggle = document.getElementById('password-toggle');
    if (passwordToggle) {
        passwordToggle.addEventListener('click', function() {
            togglePassword('password', 'password-toggle');
        });
    }

    const adminPasswordToggle = document.getElementById('admin-password-toggle');
    if (adminPasswordToggle) {
        adminPasswordToggle.addEventListener('click', function() {
            togglePassword('admin-password', 'admin-password-toggle');
        });
    }

    const newPasswordToggle = document.getElementById('new-password-toggle');
    if (newPasswordToggle) {
        newPasswordToggle.addEventListener('click', function() {
            togglePassword('new-password', 'new-password-toggle');
        });
    }

    const confirmPasswordToggle = document.getElementById('confirm-password-toggle');
    if (confirmPasswordToggle) {
        confirmPasswordToggle.addEventListener('click', function() {
            togglePassword('confirm-password', 'confirm-password-toggle');
        });
    }

    const themeSwitch = document.getElementById('theme-switch');
    if (themeSwitch) {
        themeSwitch.addEventListener('click', toggleTheme);
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            const loginForm = document.getElementById('login-form');
            const adminAuth = document.getElementById('admin-auth');
            const adminPanel = document.getElementById('admin-panel');
            const createUserForm = document.getElementById('create-user-form');
            const reactivateForm = document.getElementById('reactivate-form');
            const editForm = document.getElementById('edit-form');
            
            if (loginForm && loginForm.style.display !== 'none') {
                validarLogin();
            } else if (adminAuth && adminAuth.style.display !== 'none') {
                verifyAdmin();
            } else if (adminPanel && adminPanel.style.display !== 'none') {
                if (createUserForm && createUserForm.style.display !== 'none') {
                    registerUser();
                } else if (reactivateForm && reactivateForm.style.display === 'block') {
                    reactivateUser();
                } else if (editForm && editForm.style.display === 'block') {
                    saveUserEdit();
                }
            }
        }
    });
});
