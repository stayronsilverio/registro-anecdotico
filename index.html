<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - Registro Anecd√≥tico</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --primary-color: #6a11cb;
        --secondary-color: #2575fc;
        --accent-color: #2ecc71;
        --danger-color: #e74c3c;
        --warning-color: #f39c12;
        --text-color: #333;
        --bg-color: #f8f9fa;
        --card-bg: #ffffff;
        --input-bg: #ffffff;
        --border-color: #ddd;
        --shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }

    .dark-mode {
        --primary-color: #8c68cd;
        --secondary-color: #5e97fc;
        --accent-color: #35de7d;
        --danger-color: #ff6b6b;
        --warning-color: #ffd166;
        --text-color: #f0f0f0;
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --input-bg: #2d2d2d;
        --border-color: #444;
        --shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        transition: background-color 0.3s, color 0.3s;
    }

    body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        padding: 20px;
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    .login-container {
        background: var(--card-bg);
        padding: 40px;
        border-radius: 20px;
        box-shadow: var(--shadow);
        width: 100%;
        max-width: 500px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .login-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
    }

    .theme-switch {
        position: absolute;
        top: 20px;
        right: 20px;
        cursor: pointer;
        font-size: 24px;
        color: var(--primary-color);
    }

    .avatar-container {
        width: 130px;
        height: 130px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 40px;
        font-weight: bold;
        border: 4px solid var(--card-bg);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        overflow: hidden;
    }

    .avatar-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .login-container h2 {
        font-size: 24px;
        margin-bottom: 5px;
        color: var(--text-color);
        font-weight: 600;
    }

    .user-role {
        font-size: 16px;
        color: var(--primary-color);
        font-weight: 500;
        margin-bottom: 5px;
    }

    .contact-info {
        font-size: 14px;
        color: var(--text-color);
        opacity: 0.8;
        margin-bottom: 25px;
    }

    .input-group {
        margin-bottom: 15px;
        text-align: left;
        position: relative;
    }

    .input-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
        color: var(--text-color);
        font-weight: 500;
    }

    .login-container select,
    .login-container input {
        width: 100%;
        padding: 12px 15px;
        border-radius: 10px;
        border: 2px solid var(--border-color);
        font-size: 15px;
        transition: all 0.3s;
        background-color: var(--input-bg);
        color: var(--text-color);
    }

    .login-container select:focus,
    .login-container input:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.2);
    }

    .password-toggle {
        position: absolute;
        right: 15px;
        top: 38px;
        cursor: pointer;
        color: var(--text-color);
        opacity: 0.7;
    }

    .login-container button {
        width: 100%;
        padding: 14px;
        margin-top: 10px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 10px rgba(106, 17, 203, 0.3);
    }

    .login-container button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(106, 17, 203, 0.4);
    }

    .secondary-btn {
        background: linear-gradient(to right, #fd746c, #ff9068) !important;
        box-shadow: 0 4px 10px rgba(253, 116, 108, 0.3) !important;
    }

    .secondary-btn:hover {
        box-shadow: 0 6px 15px rgba(253, 116, 108, 0.4) !important;
    }

    .danger-btn {
        background: linear-gradient(to right, var(--danger-color), #c0392b) !important;
        box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3) !important;
    }

    .danger-btn:hover {
        box-shadow: 0 6px 15px rgba(231, 76, 60, 0.4) !important;
    }

    .success-btn {
        background: linear-gradient(to right, var(--accent-color), #27ae60) !important;
        box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3) !important;
    }

    .success-btn:hover {
        box-shadow: 0 6px 15px rgba(46, 204, 113, 0.4) !important;
    }

    .warning-btn {
        background: linear-gradient(to right, var(--warning-color), #e67e22) !important;
        box-shadow: 0 4px 10px rgba(243, 156, 18, 0.3) !important;
    }

    .warning-btn:hover {
        box-shadow: 0 6px 15px rgba(243, 156, 18, 0.4) !important;
    }

    .error-msg {
        color: var(--danger-color);
        font-size: 14px;
        margin-top: 15px;
        display: none;
        background: rgba(231, 76, 60, 0.1);
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid var(--danger-color);
    }

    .success-msg {
        color: var(--accent-color);
        font-size: 14px;
        margin-top: 15px;
        display: none;
        background: rgba(46, 204, 113, 0.1);
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid var(--accent-color);
    }

    .info-msg {
        color: var(--primary-color);
        font-size: 14px;
        margin-top: 15px;
        display: none;
        background: rgba(106, 17, 203, 0.1);
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid var(--primary-color);
    }

    .admin-auth {
        display: none;
        text-align: left;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px dashed var(--border-color);
    }

    .register-form {
        display: none;
        text-align: left;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px dashed var(--border-color);
    }

    .user-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
    }

    .user-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid var(--border-color);
    }

    .user-item:last-child {
        border-bottom: none;
    }

    .user-actions {
        display: flex;
        gap: 5px;
    }

    .action-btn {
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 12px;
    }

    .delete-btn {
        background: var(--danger-color);
    }

    .reactivate-btn {
        background: var(--accent-color);
    }

    .edit-btn {
        background: var(--primary-color);
    }

    .user-info {
        flex-grow: 1;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .user-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }

    .user-details {
        flex-grow: 1;
    }

    .user-password {
        font-family: monospace;
        background: var(--input-bg);
        padding: 2px 5px;
        border-radius: 3px;
        margin-left: 10px;
    }

    .expiry-info {
        font-size: 12px;
        color: var(--text-color);
        opacity: 0.8;
        margin-top: 3px;
    }

    .expired {
        color: var(--danger-color);
        font-weight: bold;
    }

    .expiring-soon {
        color: var(--warning-color);
    }

    @media(max-width: 480px){
        .login-container {
            padding: 30px 20px;
        }
    }

    .footer {
        margin-top: 25px;
        font-size: 12px;
        color: var(--text-color);
        opacity: 0.7;
        text-align: center;
    }

    .form-tabs {
        display: flex;
        margin-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }

    .form-tab {
        flex: 1;
        text-align: center;
        padding: 10px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        color: var(--text-color);
    }

    .form-tab.active {
        border-bottom: 3px solid var(--primary-color);
        color: var(--primary-color);
        font-weight: bold;
    }

    .reactivate-form, .edit-form {
        display: none;
        background: var(--input-bg);
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        border-left: 4px solid var(--accent-color);
    }

    .edit-form {
        border-left: 4px solid var(--primary-color);
    }

    .forgot-password {
        text-align: right;
        margin-bottom: 15px;
    }

    .forgot-link {
        color: var(--primary-color);
        text-decoration: none;
        font-size: 14px;
        cursor: pointer;
    }

    .forgot-link:hover {
        text-decoration: underline;
    }

    .blocked-msg {
        color: var(--danger-color);
        font-size: 14px;
        margin-top: 15px;
        background: rgba(231, 76, 60, 0.1);
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid var(--danger-color);
    }

    .custom-alert {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        background: var(--card-bg);
        color: var(--text-color);
        box-shadow: var(--shadow);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }

    .custom-alert.show {
        transform: translateX(0);
    }

    .custom-alert.success {
        border-left: 4px solid var(--accent-color);
    }

    .custom-alert.error {
        border-left: 4px solid var(--danger-color);
    }

    .custom-alert.info {
        border-left: 4px solid var(--primary-color);
    }

    .custom-alert i {
        font-size: 20px;
    }

    .custom-alert.success i {
        color: var(--accent-color);
    }

    .custom-alert.error i {
        color: var(--danger-color);
    }

    .custom-alert.info i {
        color: var(--primary-color);
    }
</style>
</head>
<body>

<div class="login-container" id="login-page">
    <!-- Switch de tema oscuro/claro -->
    <div class="theme-switch" id="theme-switch">
        <i class="fas fa-moon"></i>
    </div>

    <!-- Avatar con iniciales din√°micas -->
    <div class="avatar-container" id="user-avatar">
        MS
    </div>
    
    <h2 id="profile-name">Miguel Silverio</h2>
    <p class="user-role" id="profile-role">Docente de Ingl√©s</p>
    <p class="contact-info" id="profile-contact">Tel: 829-801-8462</p>

    <div id="login-form">
    <div class="input-group">
        <label for="usuario">Correo electr√≥nico</label>
        <input type="email" id="usuario" placeholder="ejemplo@correo.com" required>
    </div>


        </div>

        <div class="input-group">
            <label for="password">Contrase√±a</label>
            <input type="password" id="password" placeholder="Ingresa tu contrase√±a">
            <span class="password-toggle" id="password-toggle">
                <i class="far fa-eye"></i>
            </span>
        </div>

        <div class="forgot-password">
            <a class="forgot-link" onclick="forgotPassword()">¬øOlvidaste tu contrase√±a?</a>
        </div>

        <button onclick="validarLogin()">Ingresar al Sistema</button>
        
        <p class="error-msg" id="error-msg">
            <i class="fas fa-exclamation-circle"></i> <span id="error-text"></span>
        </p>

        <p class="blocked-msg" id="blocked-msg" style="display: none;">
            <i class="fas fa-lock"></i> <span id="blocked-text"></span>
        </p>
        
        <p class="success-msg" id="success-msg">
            <i class="fas fa-check-circle"></i> Credenciales correctas, redirigiendo...
        </p>

        <button class="secondary-btn" onclick="showAdminAuth()">
            <i class="fas fa-user-cog"></i> Administrar usuarios
        </button>
    </div>

    <div id="admin-auth" class="admin-auth">
        <h3 style="text-align: center; margin-bottom: 15px; color: var(--primary-color);">
            <i class="fas fa-lock"></i> Autenticaci√≥n Requerida
        </h3>
        <p style="text-align: center; margin-bottom: 15px; color: var(--text-color); opacity: 0.8; font-size: 14px;">
            Para administrar usuarios, debe autenticarse como administrador.
        </p>
        
        <div class="input-group">
            <label for="admin-username">Usuario administrador</label>
            <input type="text" id="admin-username" placeholder="Usuario de administrador">
        </div>
        
        <div class="input-group">
            <label for="admin-password">Contrase√±a de administrador</label>
            <input type="password" id="admin-password" placeholder="Contrase√±a de administrador">
            <span class="password-toggle" id="admin-password-toggle">
                <i class="far fa-eye"></i>
            </span>
        </div>
        
        <button onclick="verifyAdmin()">Verificar identidad</button>
        <button class="secondary-btn" onclick="hideAdminAuth()">Cancelar</button>
        
        <p class="error-msg" id="admin-error-msg"></p>
    </div>

    <div id="admin-panel" class="register-form">
        <h3 style="text-align: center; margin-bottom: 15px; color: var(--primary-color);">
            <i class="fas fa-users-cog"></i> Panel de Administraci√≥n
        </h3>

        <div class="form-tabs">
            <div class="form-tab active" id="tab-create" onclick="switchAdminTab('create')">Crear Usuario</div>
            <div class="form-tab" id="tab-delete" onclick="switchAdminTab('delete')">Gestionar Usuarios</div>
        </div>

        <div id="create-user-form">
            <div class="input-group">
                <label for="new-username">Nombre de usuario *</label>
                <input type="text" id="new-username" placeholder="Nombre completo">
            </div>
            
            <div class="input-group">
                <label for="new-password">Contrase√±a *</label>
                <input type="password" id="new-password" placeholder="M√≠nimo 4 caracteres">
                <span class="password-toggle" id="new-password-toggle">
                    <i class="far fa-eye"></i>
                </span>
            </div>
            
            <div class="input-group">
                <label for="confirm-password">Confirmar contrase√±a *</label>
                <input type="password" id="confirm-password" placeholder="Repite la contrase√±a">
                <span class="password-toggle" id="confirm-password-toggle">
                    <i class="far fa-eye"></i>
                </span>
            </div>
            
            <div class="input-group">
                <label for="user-role">Especialidad/Rol *</label>
                <input type="text" id="user-role" placeholder="Ej: Docente de Ingl√©s">
            </div>
            
            <div class="input-group">
                <label for="user-phone">Tel√©fono de contacto</label>
                <input type="text" id="user-phone" placeholder="Ej: 829-801-8462">
            </div>
            
            <div class="input-group">
                <label for="expiry-date">Fecha de caducidad (opcional)</label>
                <input type="date" id="expiry-date" min="2024-01-01">
            </div>

            <div class="input-group">
                <label for="avatar-upload">Foto de perfil (opcional)</label>
                <input type="file" id="avatar-upload" accept="image/*" style="padding: 8px;">
            </div>
            
            <button onclick="registerUser()">Crear usuario</button>
        </div>

        <div id="delete-user-form" style="display: none;">
            <div class="input-group">
                <label>Usuarios registrados</label>
                <div class="user-list" id="user-list">
                    <!-- Los usuarios se cargar√°n aqu√≠ din√°micamente -->
                </div>
            </div>
            
            <div id="reactivate-form" class="reactivate-form">
                <h4>Reactivar Usuario: <span id="reactivate-username"></span></h4>
                <div class="input-group">
                    <label for="new-expiry-date">Nueva fecha de caducidad</label>
                    <input type="date" id="new-expiry-date" min="2024-01-01">
                </div>
                <button class="success-btn" onclick="reactivateUser()">Reactivar Usuario</button>
                <button class="secondary-btn" onclick="hideReactivateForm()">Cancelar</button>
            </div>

            <div id="edit-form" class="edit-form">
                <h4>Editar Usuario: <span id="edit-username"></span></h4>
                <div class="input-group">
                    <label for="edit-role">Especialidad/Rol</label>
                    <input type="text" id="edit-role" placeholder="Ej: Docente de Ingl√©s">
                </div>
                
                <div class="input-group">
                    <label for="edit-phone">Tel√©fono de contacto</label>
                    <input type="text" id="edit-phone" placeholder="Ej: 829-801-8462">
                </div>
                
                <div class="input-group">
                    <label for="edit-expiry-date">Fecha de caducidad</label>
                    <input type="date" id="edit-expiry-date" min="2024-01-01">
                </div>

                <div class="input-group">
                    <label for="edit-avatar-upload">Nueva foto de perfil (opcional)</label>
                    <input type="file" id="edit-avatar-upload" accept="image/*" style="padding: 8px;">
                </div>
                
                <button class="warning-btn" onclick="saveUserEdit()">Guardar Cambios</button>
                <button class="secondary-btn" onclick="hideEditForm()">Cancelar</button>
            </div>
            
            <p style="color: var(--text-color); opacity: 0.8; font-size: 13px; margin-bottom: 15px;">
                <i class="fas fa-exclamation-triangle"></i> Los usuarios por defecto no pueden ser eliminados
            </p>
        </div>

        <button class="secondary-btn" onclick="hideAdminPanel()">Volver al login</button>
        
        <p class="error-msg" id="register-error-msg"></p>
        <p class="success-msg" id="register-success-msg"></p>
    </div>

    <div class="footer">
        Sistema de Registro Anecd√≥tico | v4.0<br>
        Desarrollado por Miguel Silverio
    </div>
</div>

<!-- Alertas personalizadas -->
<div class="custom-alert success" id="custom-alert">
    <i class="fas fa-check-circle"></i>
    <span id="alert-message"></span>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCY14LkfciAkiQK8tqFedBR1oNsSJYy_NM",
    authDomain: "registro-anecdotico-4e9f9.firebaseapp.com",
    projectId: "registro-anecdotico-4e9f9",
    storageBucket: "registro-anecdotico-4e9f9.firebasestorage.app",
    messagingSenderId: "452165916569",
    appId: "1:452165916569:web:38eba932b3a9b13cdd6508"
  };

  firebase.initializeApp(firebaseConfig);
  console.log("üî• Firebase conectado en modo COMPAT");
</script>

<script>
    // Variables globales
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    let usuarioParaReactivar = null;
    let usuarioParaEditar = null;
    let failedAttempts = 0;
    let isBlocked = false;
    let blockUntil = 0;
    let currentSessionId = generateSessionId();
    let currentUser = null;

    // Generar ID de sesi√≥n √∫nico
    function generateSessionId() {
        return Math.random().toString(36).substring(2) + Date.now().toString(36);
    }

    // Mostrar alerta personalizada
    function showAlert(message, type = "success") {
        const alert = document.getElementById("custom-alert");
        const alertMessage = document.getElementById("alert-message");
        
        alert.className = "custom-alert " + type;
        alertMessage.textContent = message;
        alert.classList.add("show");
        
        setTimeout(() => {
            alert.classList.remove("show");
        }, 3000);
    }

    // Funci√≥n para encriptar contrase√±as usando SHA-256
    async function hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Cargar usuarios desde Firebase
    async function loadUsers() {
        try {
            const usersSnapshot = await db.collection("usuarios").get();
            const users = {};
            
            usersSnapshot.forEach((doc) => {
                users[doc.id] = doc.data();
            });

            // Si no existe Miguel Silverio, crearlo
            if (!users["Miguel Silverio"]) {
                const hashedPassword = await hashPassword("2201");
                await db.collection("usuarios").doc("Miguel Silverio").set({
                    password: hashedPassword,
                    expiryDate: null,
                    isDefault: true,
                    avatar: null,
                    role: "Docente de Ingl√©s",
                    phone: "829-801-8462",
                    sessionId: null,
                    email: "miguel@example.com",
                    activo: true
                });
                users["Miguel Silverio"] = {
                    password: hashedPassword,
                    expiryDate: null,
                    isDefault: true,
                    avatar: null,
                    role: "Docente de Ingl√©s",
                    phone: "829-801-8462",
                    sessionId: null,
                    email: "miguel@example.com",
                    activo: true
                };
            }

            // Cargar preferencia de tema
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-switch').innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            // Verificar si hay bloqueo activo
            const blockTime = localStorage.getItem('blockUntil');
            if (blockTime && parseInt(blockTime) > Date.now()) {
                isBlocked = true;
                blockUntil = parseInt(blockTime);
                updateBlockedMessage();
            }

            console.log("‚úÖ Usuarios cargados desde Firebase");
            return users;
        } catch (error) {
            console.error("‚ùå Error al cargar usuarios:", error);
            showAlert("Error al cargar usuarios de Firebase", "error");
            return {};
        }
    }

    // Guardar usuario en Firebase
    async function saveUserToFirebase(username, userData) {
        try {
            await db.collection("usuarios").doc(username).set(userData, { merge: true });
            console.log(`‚úÖ Usuario ${username} guardado en Firebase`);
        } catch (error) {
            console.error(`‚ùå Error al guardar usuario ${username}:`, error);
            showAlert(`Error al guardar usuario: ${error.message}`, "error");
        }
    }

    // Eliminar usuario de Firebase
    async function deleteUserFromFirebase(username) {
        try {
            await db.collection("usuarios").doc(username).delete();
            console.log(`‚úÖ Usuario ${username} eliminado de Firebase`);
        } catch (error) {
            console.error(`‚ùå Error al eliminar usuario ${username}:`, error);
            showAlert(`Error al eliminar usuario: ${error.message}`, "error");
        }
    }

    // Actualizar mensaje de bloqueo
    function updateBlockedMessage() {
        if (!isBlocked) return;
        
        const now = Date.now();
        if (now >= blockUntil) {
            isBlocked = false;
            localStorage.removeItem('blockUntil');
            document.getElementById('blocked-msg').style.display = 'none';
            return;
        }
        
        const remainingSeconds = Math.ceil((blockUntil - now) / 1000);
        document.getElementById('blocked-text').textContent = `Demasiados intentos fallidos. Intenta nuevamente en ${remainingSeconds} segundos.`;
        document.getElementById('blocked-msg').style.display = 'block';
        
        setTimeout(updateBlockedMessage, 1000);
    }

    // Bloquear acceso temporalmente
    function blockAccess() {
        isBlocked = true;
        blockUntil = Date.now() + 45000;
        localStorage.setItem('blockUntil', blockUntil.toString());
        updateBlockedMessage();
    }

    // Cambiar entre tema claro y oscuro
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
            document.getElementById('theme-switch').innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            localStorage.setItem('theme', 'light');
            document.getElementById('theme-switch').innerHTML = '<i class="fas fa-moon"></i>';
        }
    }

    // Mostrar/ocultar contrase√±a
    function togglePassword(inputId, toggleId) {
        const passwordInput = document.getElementById(inputId);
        const toggleIcon = document.getElementById(toggleId).querySelector('i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.classList.remove('fa-eye');
            toggleIcon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
        }
    }

    // Funci√≥n para recuperar contrase√±a
    function forgotPassword() {
        showAlert(`Para recuperar tu contrase√±a, contacta a Miguel Silverio por WhatsApp al 829-801-8462. Recibir√°s respuesta en un plazo de 12 horas.`, 'info');
    }

    // Funci√≥n para obtener las iniciales de un nombre
    function getInitials(name) {
        if (!name) return "MS";
        
        const names = name.split(' ');
        let initials = "";
        
        if (names.length === 1) {
            initials = names[0].charAt(0);
        } else {
            initials = names[0].charAt(0) + names[names.length - 1].charAt(0);
        }
        
        return initials.toUpperCase();
    }

    // Normalizar nombre de usuario
    function normalizeUsername(username) {
        return username.toLowerCase().trim();
    }

    // Buscar usuario normalizado
    async function findUser(username) {
        try {
            const usersSnapshot = await db.collection("usuarios").get();
            const normalizedUsername = normalizeUsername(username);
            
            for (const doc of usersSnapshot.docs) {
                if (normalizeUsername(doc.id) === normalizedUsername) {
                    return doc.id;
                }
            }
            return null;
        } catch (error) {
            console.error("Error al buscar usuario:", error);
            return null;
        }
    }

    // Verificar si un usuario ha expirado
    function isUserExpired(userData) {
        if (!userData.expiryDate) return false;
        
        const today = new Date();
        const expiryDate = new Date(userData.expiryDate);
        return today > expiryDate;
    }

    // Obtener informaci√≥n de expiraci√≥n para mostrar
    function getExpiryInfo(userData) {
        if (!userData.expiryDate) return "Sin fecha de expiraci√≥n";
        
        const today = new Date();
        const expiryDate = new Date(userData.expiryDate);
        const diffTime = expiryDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) {
            return `<span class="expired">Expirado el ${formatDate(userData.expiryDate)}</span>`;
        } else if (diffDays < 7) {
            return `<span class="expiring-soon">Expira en ${diffDays} d√≠as (${formatDate(userData.expiryDate)})</span>`;
        } else {
            return `Expira el ${formatDate(userData.expiryDate)}`;
        }
    }

    // Formatear fecha a formato legible (DD/MM/YYYY)
    function formatDate(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        return date.toLocaleDateString('es-ES');
    }

    // Configurar event listeners para los toggles de contrase√±a
    document.getElementById('password-toggle').addEventListener('click', function() {
        togglePassword('password', 'password-toggle');
    });

    document.getElementById('admin-password-toggle').addEventListener('click', function() {
        togglePassword('admin-password', 'admin-password-toggle');
    });

    document.getElementById('new-password-toggle').addEventListener('click', function() {
        togglePassword('new-password', 'new-password-toggle');
    });

    document.getElementById('confirm-password-toggle').addEventListener('click', function() {
        togglePassword('confirm-password', 'confirm-password-toggle');
    });

    document.getElementById('theme-switch').addEventListener('click', toggleTheme);

    // Permitir login con la tecla Enter
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            if (document.getElementById('login-form').style.display !== 'none') {
                validarLogin();
            } else if (document.getElementById('admin-auth').style.display !== 'none') {
                verifyAdmin();
            }
        }
    });

    // Funciones de administraci√≥n
    function showAdminAuth() {
        if (isBlocked) {
            showAlert('El sistema est√° bloqueado temporalmente por demasiados intentos fallidos.', 'error');
            return;
        }
        
        document.getElementById('admin-auth').style.display = 'block';
        document.getElementById('login-form').style.display = 'none';
        
        document.getElementById('admin-username').value = '';
        document.getElementById('admin-password').value = '';
        document.getElementById('admin-error-msg').style.display = 'none';
    }

    function hideAdminAuth() {
        document.getElementById('admin-auth').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
    }

    async function showAdminPanel() {
        document.getElementById('admin-panel').style.display = 'block';
        document.getElementById('admin-auth').style.display = 'none';
        
        document.getElementById('register-error-msg').style.display = 'none';
        document.getElementById('register-success-msg').style.display = 'none';
        document.getElementById('new-username').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        document.getElementById('user-role').value = '';
        document.getElementById('user-phone').value = '';
        document.getElementById('expiry-date').value = '';
        document.getElementById('avatar-upload').value = '';
        
        await loadUserList();
    }

    function hideAdminPanel() {
        document.getElementById('admin-panel').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
        hideReactivateForm();
        hideEditForm();
    }

    function switchAdminTab(tabName) {
        const createTab = document.getElementById('tab-create');
        const deleteTab = document.getElementById('tab-delete');
        const createForm = document.getElementById('create-user-form');
        const deleteForm = document.getElementById('delete-user-form');
        
        if (tabName === 'create') {
            createTab.classList.add('active');
            deleteTab.classList.remove('active');
            createForm.style.display = 'block';
            deleteForm.style.display = 'none';
            hideReactivateForm();
            hideEditForm();
        } else {
            createTab.classList.remove('active');
            deleteTab.classList.add('active');
            createForm.style.display = 'none';
            deleteForm.style.display = 'block';
            loadUserList();
        }
    }

    async function loadUserList() {
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        
        try {
            const usersSnapshot = await db.collection("usuarios").get();
            
            usersSnapshot.forEach((doc) => {
                const user = doc.id;
                const userData = doc.data();
                
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const userInfo = document.createElement('div');
                userInfo.className = 'user-info';
                
                const userIcon = document.createElement('div');
                userIcon.className = 'user-icon';
                
                if (userData.avatar) {
                    userIcon.style.backgroundImage = `url(${userData.avatar})`;
                    userIcon.style.backgroundSize = 'cover';
                    userIcon.innerHTML = '';
                } else {
                    userIcon.textContent = getInitials(user).substring(0, 2);
                }
                
                const userDetails = document.createElement('div');
                userDetails.className = 'user-details';
                
                const userName = document.createElement('div');
                userName.innerHTML = `<strong>${user}</strong> - ${userData.role || "Usuario"}`;
                
                const expiryInfo = document.createElement('div');
                expiryInfo.className = 'expiry-info';
                expiryInfo.innerHTML = getExpiryInfo(userData);
                
                userDetails.appendChild(userName);
                userDetails.appendChild(expiryInfo);
                
                userInfo.appendChild(userIcon);
                userInfo.appendChild(userDetails);
                
                userItem.appendChild(userInfo);
                
                const userActions = document.createElement('div');
                userActions.className = 'user-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'action-btn edit-btn';
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.title = 'Editar usuario';
                editBtn.onclick = function() { showEditForm(user); };
                
                userActions.appendChild(editBtn);
                
                if (!userData.isDefault) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'action-btn delete-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.title = 'Eliminar usuario';
                    deleteBtn.onclick = function() { deleteUser(user); };
                    
                    userActions.appendChild(deleteBtn);
                    
                    if (isUserExpired(userData)) {
                        const reactivateBtn = document.createElement('button');
                        reactivateBtn.className = 'action-btn reactivate-btn';
                        reactivateBtn.innerHTML = '<i class="fas fa-redo"></i>';
                        reactivateBtn.title = 'Reactivar usuario';
                        reactivateBtn.onclick = function() { showReactivateForm(user); };
                        
                        userActions.appendChild(reactivateBtn);
                    }
                }
                
                userItem.appendChild(userActions);
                userList.appendChild(userItem);
            });
        } catch (error) {
            console.error("Error al cargar lista de usuarios:", error);
            showAlert("Error al cargar usuarios", "error");
        }
    }

    function showReactivateForm(username) {
        usuarioParaReactivar = username;
        document.getElementById('reactivate-username').textContent = username;
        document.getElementById('reactivate-form').style.display = 'block';
        document.getElementById('new-expiry-date').value = '';
        
        hideEditForm();
        
        document.getElementById('reactivate-form').scrollIntoView({ behavior: 'smooth' });
    }

    function hideReactivateForm() {
        document.getElementById('reactivate-form').style.display = 'none';
        usuarioParaReactivar = null;
    }

    function showEditForm(username) {
        usuarioParaEditar = username;
        db.collection("usuarios").doc(username).get().then((doc) => {
            const userData = doc.data();
            
            document.getElementById('edit-username').textContent = username;
            document.getElementById('edit-role').value = userData.role || "";
            document.getElementById('edit-phone').value = userData.phone || "";
            document.getElementById('edit-expiry-date').value = userData.expiryDate || "";
            document.getElementById('edit-form').style.display = 'block';
            
            hideReactivateForm();
            
            document.getElementById('edit-form').scrollIntoView({ behavior: 'smooth' });
        });
    }

    function hideEditForm() {
        document.getElementById('edit-form').style.display = 'none';
        usuarioParaEditar = null;
    }

    async function reactivateUser() {
        if (!usuarioParaReactivar) return;
        
        const newExpiryDate = document.getElementById('new-expiry-date').value;
        
        if (!newExpiryDate) {
            showAlert('Por favor, selecciona una nueva fecha de caducidad', 'error');
            return;
        }
        
        try {
            await saveUserToFirebase(usuarioParaReactivar, { expiryDate: newExpiryDate });
            showAlert(`Usuario "${usuarioParaReactivar}" reactivado correctamente. Nueva fecha de expiraci√≥n: ${formatDate(newExpiryDate)}`, 'success');
            
            loadUserList();
            hideReactivateForm();
        } catch (error) {
            showAlert('Error al reactivar usuario', 'error');
        }
    }

    async function saveUserEdit() {
        if (!usuarioParaEditar) return;
        
        const newRole = document.getElementById('edit-role').value;
        const newPhone = document.getElementById('edit-phone').value;
        const newExpiryDate = document.getElementById('edit-expiry-date').value;
        const newAvatarFile = document.getElementById('edit-avatar-upload').files[0];
        
        if (!newRole) {
            showAlert('El campo de especialidad/rol es obligatorio', 'error');
            return;
        }
        
        const updateData = {
            role: newRole,
            phone: newPhone,
            expiryDate: newExpiryDate || null
        };
        
        try {
            if (newAvatarFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updateData.avatar = e.target.result;
                    completeUserEdit(updateData);
                };
                reader.readAsDataURL(newAvatarFile);
            } else {
                completeUserEdit(updateData);
            }
        } catch (error) {
            showAlert('Error al editar usuario', 'error');
        }
    }

    async function completeUserEdit(updateData) {
        try {
            await saveUserToFirebase(usuarioParaEditar, updateData);
            showAlert(`Usuario "${usuarioParaEditar}" actualizado correctamente`, 'success');
            
            loadUserList();
            hideEditForm();
        } catch (error) {
            showAlert('Error al guardar cambios', 'error');
        }
    }

    async function deleteUser(username) {
        if (confirm(`¬øEst√°s seguro de que deseas eliminar al usuario "${username}"?`)) {
            try {
                await deleteUserFromFirebase(username);
                loadUserList();
                showAlert(`Usuario "${username}" eliminado correctamente`, 'success');
            } catch (error) {
                showAlert('Error al eliminar usuario', 'error');
            }
        }
    }

    async function verifyAdmin() {
        const adminUsername = document.getElementById('admin-username').value;
        const adminPassword = document.getElementById('admin-password').value;
        const errorMsg = document.getElementById('admin-error-msg');
        
        errorMsg.style.display = 'none';
        
        try {
            const foundUser = await findUser(adminUsername);
            
            if (foundUser === "Miguel Silverio") {
                const docSnap = await db.collection("usuarios").doc(foundUser).get();
                const userData = docSnap.data();
                const hashedPassword = await hashPassword(adminPassword);
                
                if (userData.password === hashedPassword) {
                    showAdminPanel();
                } else {
                    errorMsg.textContent = 'Credenciales de administrador incorrectas';
                    errorMsg.style.display = 'block';
                }
            } else {
                errorMsg.textContent = 'Credenciales de administrador incorrectas';
                errorMsg.style.display = 'block';
            }
        } catch (error) {
            errorMsg.textContent = 'Error al verificar credenciales';
            errorMsg.style.display = 'block';
            console.error("Error:", error);
        }
    }

    window.validarLogin = async function() {
        if (isBlocked) {
            updateBlockedMessage();
            return;
        }

        const email = document.getElementById('usuario').value;
        const password = document.getElementById('password').value;
        const errorMsg = document.getElementById('error-msg');
        const errorText = document.getElementById('error-text');
        const successMsg = document.getElementById('success-msg');

        errorMsg.style.display = 'none';
        successMsg.style.display = 'none';
        document.getElementById('blocked-msg').style.display = 'none';

        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;

            const docRef = db.collection("usuarios").doc(user.uid);
            const docSnap = await docRef.get();

            if (!docSnap.exists) {
                errorText.textContent = "Usuario no registrado en base de datos";
                errorMsg.style.display = "block";
                return;
            }

            const userData = docSnap.data();

            if (!userData.activo) {
                errorText.textContent = "Usuario desactivado";
                errorMsg.style.display = "block";
                return;
            }

            if (userData.expiryDate) {
                const today = new Date();
                const expiry = new Date(userData.expiryDate);

                if (expiry < today) {
                    errorText.textContent = "Usuario expirado";
                    errorMsg.style.display = "block";
                    return;
                }
            }

            failedAttempts = 0;
            currentUser = user;
            successMsg.style.display = "block";

            setTimeout(function() {
                showAlert("Redirigiendo al sistema principal...", "success");
                document.getElementById("main-page").style.display = "block";
                document.getElementById("login-page").style.display = "none";
            }, 1500);

        } catch (error) {
            failedAttempts++;

            if (error.code === 'auth/user-not-found') {
                errorText.textContent = "Usuario no encontrado";
            } else if (error.code === 'auth/wrong-password') {
                errorText.textContent = "Contrase√±a incorrecta";
            } else {
                errorText.textContent = "Correo o contrase√±a incorrectos";
            }
            
            errorMsg.style.display = "block";

            if (failedAttempts >= 3) {
                blockAccess();
            }
        }
    };

    async function registerUser() {
        const username = document.getElementById('new-username').value;
        const password = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const role = document.getElementById('user-role').value;
        const phone = document.getElementById('user-phone').value;
        const expiryDate = document.getElementById('expiry-date').value;
        const avatarFile = document.getElementById('avatar-upload').files[0];
        
        if (!username || !password || !confirmPassword || !role) {
            showAlert('Todos los campos marcados con * son obligatorios', 'error');
            return;
        }
        
        if (password.length < 4) {
            showAlert('La contrase√±a debe tener al menos 4 caracteres', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showAlert('Las contrase√±as no coinciden', 'error');
            return;
        }
        
        const foundUser = await findUser(username);
        if (foundUser) {
            showAlert('El usuario ya existe', 'error');
            return;
        }
        
        let avatarData = null;
        if (avatarFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                avatarData = e.target.result;
                completeUserRegistration(username, password, role, phone, expiryDate, avatarData);
            };
            reader.readAsDataURL(avatarFile);
        } else {
            completeUserRegistration(username, password, role, phone, expiryDate, null);
        }
    }

    async function completeUserRegistration(username, password, role, phone, expiryDate, avatarData) {
        try {
            const hashedPassword = await hashPassword(password);
            
            const newUser = {
                password: hashedPassword,
                expiryDate: expiryDate || null,
                isDefault: false,
                avatar: avatarData,
                role: role,
                phone: phone,
                sessionId: null,
                activo: true,
                createdAt: new Date().toISOString()
            };

            await saveUserToFirebase(username, newUser);
            
            showAlert(`Usuario "${username}" registrado correctamente`, 'success');
            
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('user-role').value = '';
            document.getElementById('user-phone').value = '';
            document.getElementById('expiry-date').value = '';
            document.getElementById('avatar-upload').value = '';
            
            loadUserList();
            switchAdminTab('delete');
        } catch (error) {
            showAlert('Error al registrar usuario: ' + error.message, 'error');
        }
    }

    // Inicializar cuando el DOM est√° listo
    document.addEventListener('DOMContentLoaded', async function() {
        await loadUsers();
    });
</script>

<div id="main-page" style="display:none;">

<!-- Bot√≥n de Cerrar Sesi√≥n -->
<button id="logout-btn" 
        style="position:fixed; top:15px; right:15px; padding:10px 15px; 
               background:linear-gradient(to right,#e74c3c,#c0392b); 
               color:#fff; border:none; border-radius:8px; 
               cursor:pointer; font-weight:bold; z-index:9999;">
    <i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n
</button>

<script>
document.addEventListener("DOMContentLoaded", function() {
    var logoutBtn = document.getElementById("logout-btn");
    if (logoutBtn) {
        logoutBtn.addEventListener("click", function(){
            firebase.auth().signOut().then(() => {
                document.getElementById("main-page").style.display = "none";
                document.getElementById("login-page").style.display = "block";
                if (document.getElementById("usuario")) document.getElementById("usuario").value = "";
                if (document.getElementById("password")) document.getElementById("password").value = "";
                if (document.getElementById("error-msg")) document.getElementById("error-msg").style.display = "none";
                if (document.getElementById("success-msg")) document.getElementById("success-msg").style.display = "none";
                if (document.getElementById("blocked-msg")) document.getElementById("blocked-msg").style.display = "none";
                showAlert("Sesi√≥n cerrada correctamente", "success");
            });
        });
    }
});
</script>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro Anecd√≥tico</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --gray: #95a5a6;
            --light-gray: #f5f5f5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            padding-bottom: 120px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            margin-bottom: 2rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .copyright {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 1.2rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
        }
        
        .card-title i {
            margin-right: 10px;
            color: var(--secondary);
        }
        
        .form-group {
            margin-bottom: 1.2rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }
        
        input[type="text"], 
        input[type="date"], 
        textarea, 
        select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s ease, box-shadow 0.3s ease;
        }
        
        input[type="text"]:focus, 
        input[type="date"]:focus, 
        textarea:focus, 
        select:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 20px;
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-primary {
            
