<script>
    // Configuración de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCY14LkfciAkiQK8tqFedBR1oNsSJYy_NM",
        authDomain: "registro-anecdotico-4e9f9.firebaseapp.com",
        projectId: "registro-anecdotico-4e9f9",
        storageBucket: "registro-anecdotico-4e9f9.appspot.com",
        messagingSenderId: "1090150651792",
        appId: "1:1090150651792:web:7235a82869df91969a5840"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let failedAttempts = 0;
    let isBlocked = false;

    // --- FUNCIONES DE INTERFAZ ---
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const icon = document.querySelector('.theme-switch i');
        icon.className = document.body.classList.contains('dark-mode') ? 'fas fa-sun' : 'fas fa-moon';
    }

    function togglePassword(inputId, toggleId) {
        const input = document.getElementById(inputId);
        const icon = document.querySelector(`#${toggleId} i`);
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }

    function showAlert(message, type = "success") {
        const alert = document.getElementById("custom-alert");
        alert.className = `custom-alert show ${type}`;
        document.getElementById("alert-message").textContent = message;
        setTimeout(() => alert.classList.remove("show"), 3000);
    }

    // Perfil dinámico al escribir correo
    function updateProfileRealTime() {
        const email = document.getElementById('usuario').value.toLowerCase();
        if(email.includes("silverio")) {
            document.getElementById('profile-name').textContent = "Miguel Silverio";
            document.getElementById('user-avatar').textContent = "MS";
            document.getElementById('profile-role').textContent = "Docente de Inglés";
        } else if(email.includes("@")) {
            const name = email.split('@')[0].toUpperCase();
            document.getElementById('profile-name').textContent = name;
            document.getElementById('user-avatar').textContent = name.charAt(0);
        }
    }

    // --- LÓGICA DE LOGIN ---
    async function validarLogin() {
        if (isBlocked) return;

        const email = document.getElementById('usuario').value;
        const pass = document.getElementById('password').value;
        const errorBox = document.getElementById('error-msg');
        const successBox = document.getElementById('success-msg');

        try {
            // Control de Sesión Única
            const sessionRef = db.collection('active_sessions').doc(email.replace(/\./g, '_'));
            const doc = await sessionRef.get();
            
            if (doc.exists && (Date.now() - doc.data().lastActive < 45000)) {
                throw new Error("Ya hay una sesión activa en otro dispositivo.");
            }

            await auth.signInWithEmailAndPassword(email, pass);
            
            // Marcar sesión activa
            await sessionRef.set({ email, lastActive: Date.now() });

            errorBox.style.display = 'none';
            successBox.style.display = 'block';
            setTimeout(() => window.location.href = "dashboard.html", 1500);

        } catch (error) {
            failedAttempts++;
            document.getElementById('error-text').textContent = error.message;
            errorBox.style.display = 'block';
            if (failedAttempts >= 3) startBlock();
        }
    }

    function startBlock() {
        isBlocked = true;
        let timeLeft = 45;
        const blockedBox = document.getElementById('blocked-msg');
        blockedBox.style.display = 'block';
        const timer = setInterval(() => {
            document.getElementById('blocked-text').textContent = `Bloqueado. Intente en ${timeLeft}s`;
            if (timeLeft-- <= 0) {
                clearInterval(timer);
                isBlocked = false;
                blockedBox.style.display = 'none';
                failedAttempts = 0;
            }
        }, 1000);
    }

    // --- ADMINISTRACIÓN ---
    function showAdminAuth() { document.getElementById('login-form').style.display = 'none'; document.getElementById('admin-auth').style.display = 'block'; }
    function hideAdminAuth() { document.getElementById('login-form').style.display = 'block'; document.getElementById('admin-auth').style.display = 'none'; }

    function verifyAdmin() {
        const u = document.getElementById('admin-username').value;
        const p = document.getElementById('admin-password').value;
        if(u === "admin" && p === "2201") {
            document.getElementById('admin-auth').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            loadUsers();
        } else { showAlert("Admin incorrecto", "error"); }
    }

    async function registerUser() {
        const email = document.getElementById('new-email').value;
        const pass = document.getElementById('new-password').value;
        const name = document.getElementById('new-username').value;
        const role = document.getElementById('user-role').value;

        try {
            await auth.createUserWithEmailAndPassword(email, pass);
            await db.collection('users').doc(email).set({ name, role, email });
            showAlert("Usuario creado en Firebase");
            loadUsers();
        } catch (e) { showAlert(e.message, "error"); }
    }

    async function loadUsers() {
        const list = document.getElementById('user-list');
        list.innerHTML = "Cargando...";
        const snap = await db.collection('users').get();
        list.innerHTML = "";
        snap.forEach(doc => {
            const u = doc.data();
            list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #ddd">
                <span>${u.name} (${u.role})</span>
                <button onclick="deleteUser('${u.email}')" style="width:auto; background:red; padding:5px">Borrar</button>
            </div>`;
        });
    }

    function switchAdminTab(tab) {
        document.getElementById('create-user-form').style.display = tab === 'create' ? 'block' : 'none';
        document.getElementById('delete-user-form').style.display = tab === 'delete' ? 'block' : 'none';
        document.querySelectorAll('.form-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
    }

    function hideAdminPanel() { document.getElementById('admin-panel').style.display = 'none'; document.getElementById('login-form').style.display = 'block'; }
</script>
</body>
</html>
